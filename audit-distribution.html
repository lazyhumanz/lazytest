<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Audit Distribution | QMS</title>
<meta name="description" content="Quality Management System - Audit Distribution Dashboard">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjMWY5ZTRiIj48cGF0aCBkPSJNMjAwLTEyMHEtMzMgMC01Ni41LTIzLjVUMTIwLTIwMHYtNTYwcTAtMzMgMjMuNS01Ni41VDIwMC04NDBoNTYwcTMzIDAgNTYuNSAyMy41VDg0MC03NjB2NTYwcTAgMzMtMjMuNSA1Ni41VDc2MC0xMjBIMjAwWm00OTEtODBoNjl2LTY5bC02OSA2OVptLTQ1NyAwaDczbDEyMC0xMjBoODVMNDUyLTIwMGg2NGwxMjAtMTIwaDg1TDU0MS0yMDBoNjVsMTIwLTEyMGgzNHYtNDQwSDIwMHY1MDlsNjktNjloODVMNDM0LTIwMFptNzItMjAwLTU2LTU2IDE3Ny0xNzcgODAgODAgMTQ3LTE0NyA1NiA1Ni0yMDMgMjA0LTgwLTgwLTEyMSAxMjBaIi8+PC9zdmc+">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="theme.css">
    <link rel="stylesheet" href="sidebar.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="env-config.js"></script>
    <script src="supabase-config.js"></script>
    <script src="auth-check.js"></script>
    <script src="access-control.js"></script>
    <script src="confirmation-dialog.js"></script>
    <script src="load-sidebar.js"></script>
    <script src="search.js"></script>
    <script src="form-validation.js"></script>
    <script src="timezone-utils.js"></script>
    <script src="date-filter-utils.js"></script>
    <style>
        .distribution-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 0;
            width: 100%;
            margin: 0;
        }

        .section-card {
            background: #ffffff;
            border-radius: 0.375rem;
            padding: 0.75rem;
            border: 0.0469rem solid #e5e7eb;
            box-shadow: 0 0.0469rem 0.1406rem rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            margin-bottom: 0.5625rem;
            padding-bottom: 0.375rem;
            border-bottom: 0.0469rem solid #e5e7eb;
        }

        .section-header[onclick] {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .section-header[onclick]:hover {
            background-color: #f9fafb;
        }

        .section-number {
            background: #1A733E;
            color: white;
            width: 1.125rem;
            height: 1.125rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.5625rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .section-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: #1A733E;
            margin: 0;
        }

        .section-subtitle {
            font-size: 0.5625rem;
            color: #6b7280;
            margin: 0.0938rem 0 0 0;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(6.3281rem, 1fr));
            gap: 0.375rem;
            margin-bottom: 0.5625rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-size: 0.5156rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.1875rem;
        }

        .filter-select, .filter-input {
            padding: 0.2812rem 0.375rem;
            border: 0.0469rem solid #d1d5db;
            border-radius: 0.1875rem;
            font-size: 0.6094rem;
            font-family: 'Poppins', sans-serif;
            background-color: white;
            transition: all 0.2s;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #1A733E;
            box-shadow: 0 0 0 0.1406rem rgba(26, 115, 62, 0.1);
        }

        .group-container {
            border: 0.0469rem solid #e5e7eb;
            border-radius: 0.375rem;
            margin-bottom: 0.375rem;
            overflow: hidden;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .group-header {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            padding: 0.375rem 0.5625rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
        }

        .group-header:hover {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }

        .group-header-left {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            flex: 1;
        }

        .group-checkbox {
            width: 0.6562rem;
            height: 0.6562rem;
            cursor: pointer;
            accent-color: #1A733E;
        }

        .group-title {
            font-size: 0.6094rem;
            font-weight: 600;
            color: #1A733E;
            margin: 0;
        }

        .group-count {
            background: #1A733E;
            color: white;
            padding: 0.0938rem 0.2812rem;
            border-radius: 0.1875rem;
            font-size: 0.5156rem;
            font-weight: 600;
        }

        .group-expand {
            color: #6b7280;
            transition: transform 0.2s;
        }

        .group-expand.expanded {
            transform: rotate(180deg);
        }

        .group-content {
            display: none;
            flex-direction: column;
            padding: 0;
            background: white;
            width: 100%;
        }

        .group-content.expanded {
            display: flex !important;
            flex-direction: column !important;
            width: 100% !important;
        }

        .employee-item {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            justify-content: space-between !important;
            padding: 0.375rem 0.5625rem;
            border-bottom: 0.0469rem solid #e5e7eb;
            transition: all 0.2s;
            background: white;
            width: 100% !important;
            box-sizing: border-box !important;
            clear: both;
            cursor: pointer;
        }

        .employee-item:hover {
            background: #f9fafb;
        }
        
        .employee-item .counter-container,
        .employee-item .counter-container * {
            cursor: default;
            pointer-events: auto;
        }

        .employee-item:last-child {
            border-bottom: none;
        }

        .employee-info {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            flex: 1;
        }

        .employee-checkbox {
            width: 0.6094rem;
            height: 0.6094rem;
            cursor: pointer;
            accent-color: #1A733E;
        }

        .employee-avatar {
            width: 1.3125rem;
            height: 1.3125rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #1A733E, #15582E);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.5156rem;
        }

        .employee-details {
            flex: 1;
        }

        .employee-name {
            font-size: 0.6094rem;
            font-weight: 600;
            color: #374151;
            margin: 0;
        }

        .employee-meta {
            font-size: 0.5156rem;
            color: #6b7280;
            margin: 0.0469rem 0 0 0;
        }

        .counter-container {
            display: flex;
            align-items: center;
            gap: 0.0938rem;
        }
        
        .counter-btn {
            width: 1.125rem;
            height: 1.125rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 0.0469rem solid #d1d5db;
            background-color: #ffffff;
            color: #4b5563;
            border-radius: 0.1875rem;
            font-size: 0.5625rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Poppins', sans-serif;
            padding: 0;
            line-height: 1;
        }
        
        .counter-btn:hover:not(:disabled) {
            background-color: #f9fafb;
            border-color: #1A733E;
            color: #1A733E;
        }
        
        .counter-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .audit-count-input {
            width: 1.875rem;
            padding: 0.1875rem 0.2812rem;
            border: 0.0469rem solid #d1d5db;
            border-radius: 0.1875rem;
            font-size: 0.5625rem;
            font-family: 'Poppins', sans-serif;
            text-align: center;
            font-weight: 700;
            background-color: #ffffff;
            color: #1f2937;
            cursor: text;
            -moz-appearance: textfield;
            appearance: textfield;
        }
        
        .audit-count-input::-webkit-inner-spin-button,
        .audit-count-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
        }
        
        .audit-count-input:disabled {
            background-color: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        .audit-count-input.error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }

        .audit-target-input {
            width: 2.5rem;
            padding: 0.1875rem 0.2812rem;
            border: 0.0469rem solid #d1d5db;
            border-radius: 0.1875rem;
            font-size: 0.5625rem;
            font-family: 'Poppins', sans-serif;
            text-align: center;
            font-weight: 600;
            background-color: #ffffff;
            color: #1f2937;
            cursor: text;
            transition: all 0.2s;
            -moz-appearance: textfield;
            appearance: textfield;
        }
        
        .audit-target-input::-webkit-inner-spin-button,
        .audit-target-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
        }
        
        .audit-target-input:focus {
            outline: none;
            border-color: #1A733E;
            box-shadow: 0 0 0 0.1406rem rgba(26, 115, 62, 0.1);
        }
        
        .audit-target-input:hover:not(:disabled) {
            border-color: #9ca3af;
        }

        .bulk-actions-bar {
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 0.0469rem solid #e5e7eb;
            padding: 0.5625rem 0.75rem;
            margin: 0 -0.75rem -0.75rem -0.75rem;
            display: none;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 -0.0938rem 0.1875rem rgba(0, 0, 0, 0.05);
        }

        .bulk-actions-bar.active {
            display: flex;
        }

        .bulk-info {
            display: flex;
            align-items: center;
            gap: 0.5625rem;
        }

        .selected-count {
            font-size: 0.6094rem;
            font-weight: 600;
            color: #1A733E;
        }

        .total-audits {
            font-size: 0.6094rem;
            color: #6b7280;
        }

        .bulk-actions {
            display: flex;
            gap: 0.375rem;
            align-items: center;
        }

        .assign-select {
            padding: 0.2812rem 0.4688rem;
            border: 0.0469rem solid #d1d5db;
            border-radius: 0.1875rem;
            font-size: 0.6094rem;
            font-family: 'Poppins', sans-serif;
            min-width: 6.3281rem;
        }

        .btn-assign {
            background: #1A733E;
            color: white;
            padding: 0.2812rem 0.75rem;
            border: none;
            border-radius: 0.1875rem;
            font-size: 0.6094rem;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-assign:hover {
            background: #15582E;
            transform: translateY(-0.0469rem);
            box-shadow: 0 0.1875rem 0.375rem rgba(26, 115, 62, 0.2);
        }

        .btn-assign:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: white;
            color: #6b7280;
            padding: 0.1406rem 0.2812rem;
            border: 0.0469rem solid #e5e7eb;
            border-radius: 0.1406rem;
            font-size: 0.5156rem;
            font-weight: 400;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #f9fafb;
            color: #374151;
            border-color: #d1d5db;
        }
        
        .quick-date-btn.active {
            background: #1A733E;
            color: white;
            border-color: #1A733E;
        }
        
        .quick-date-btn.active:hover {
            background: #15582E;
            border-color: #15582E;
        }

        #autoAssignBySupervisorBtn {
            background: #1A733E !important;
            color: white !important;
            padding: 0.1406rem 0.2812rem !important;
            font-size: 0.5156rem !important;
            font-weight: 400 !important;
            border: 0.0469rem solid #1A733E !important;
        }

        #autoAssignBySupervisorBtn:hover {
            background: #15582E !important;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Force vertical list layout - prevent any grid wrapping */
        #groupedEmployeesContainer {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 0.375rem;
        }
        
        #groupedEmployeesContainer > * {
            width: 100%;
            flex-shrink: 0;
        }

        .empty-state {
            text-align: center;
            padding: 1.5rem 0.75rem;
            color: #6b7280;
        }

        .empty-state svg {
            width: 3rem;
            height: 3rem;
            margin-bottom: 0.75rem;
            opacity: 0.5;
        }

        .filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 0.0352rem solid #d1d5db;
            border-radius: 0.2812rem;
            box-shadow: 0 0.375rem 0.75rem rgba(0, 0, 0, 0.15);
            padding: 0.375rem;
            min-width: 7.0312rem;
            max-height: 8.7891rem;
            overflow-y: auto;
            z-index: 9999;
            display: none;
            margin-top: 0.1875rem;
            pointer-events: auto;
        }

        .filter-dropdown.active {
            display: block;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.2812rem 0.375rem;
            cursor: pointer;
            border-radius: 0.1875rem;
            font-size: 0.6094rem;
            user-select: none;
            pointer-events: auto;
        }

        .filter-option:hover {
            background: #f3f4f6;
        }

        .filter-option input[type="checkbox"] {
            cursor: pointer;
            accent-color: #1A733E;
            pointer-events: auto;
        }

        .filter-actions {
            display: flex;
            gap: 0.375rem;
            padding: 0.375rem;
            border-top: 0.0352rem solid #e5e7eb;
            margin-top: 0.375rem;
        }

        .filter-actions button {
            flex: 1;
            padding: 0.2812rem;
            font-size: 0.5625rem;
            border-radius: 0.1875rem;
            border: none;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            pointer-events: auto;
        }

        .filter-apply {
            background: #1A733E;
            color: white;
        }

        .filter-apply:hover {
            background: #15582E;
        }

        .filter-clear {
            background: #f3f4f6;
            color: #374151;
        }

        .filter-clear:hover {
            background: #e5e7eb;
        }

        #clearFiltersBtn:hover {
            background: #dc2626 !important;
        }

        .btn-action {
            background-color: #f3f4f6;
            color: #374151;
            border: 0.0469rem solid #d1d5db;
            border-radius: 0.1875rem;
            padding: 0.2812rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 1.3125rem;
            height: 1.3125rem;
        }

        .btn-action:hover {
            background-color: #e5e7eb;
        }

        .btn-action-primary {
            background-color: #1A733E;
            color: white;
            border: none;
        }

        .btn-action-primary:hover {
            background-color: #145a30;
        }

        .btn-action-danger {
            background-color: #fee2e2;
            color: #dc2626;
            border: 0.0469rem solid #fca5a5;
        }

        .btn-action-danger:hover {
            background-color: #fecaca;
        }

        .btn-action-warning {
            background-color: #fef3c7;
            color: #92400e;
            border: 0.0469rem solid #fcd34d;
        }

        .btn-action-warning:hover {
            background-color: #fde68a;
        }

        .btn-action-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 0.0469rem solid #6ee7b7;
        }

        .btn-action-success:hover {
            background-color: #a7f3d0;
        }

        /* Split layout for manual assignment */
        .split-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            width: 100%;
        }

        .split-panel {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .auditors-panel {
            background: #f9fafb;
            border-radius: 0.375rem;
            padding: 0.75rem;
            border: 0.0469rem solid #e5e7eb;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 20rem;
        }

        .auditors-header {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            margin-bottom: 0.5625rem;
            padding-bottom: 0.375rem;
            border-bottom: 0.0469rem solid #e5e7eb;
        }

        .auditors-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: #1A733E;
            margin: 0;
        }

        .auditors-list {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
            max-height: calc(100vh - 25rem);
            overflow-y: auto;
        }

        .auditor-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.5625rem;
            background: white;
            border-radius: 0.1875rem;
            border: 0.0469rem solid #e5e7eb;
            transition: all 0.2s;
        }

        .auditor-item:hover {
            background: #f3f4f6;
            border-color: #1A733E;
        }

        .auditor-avatar {
            width: 1.3125rem;
            height: 1.3125rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #1A733E, #15582E);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.5156rem;
            flex-shrink: 0;
        }

        .auditor-name {
            font-size: 0.6094rem;
            font-weight: 600;
            color: #374151;
            margin: 0;
            flex: 1;
        }

        .auditor-badge {
            background: #1A733E;
            color: white;
            padding: 0.0938rem 0.2812rem;
            border-radius: 0.1875rem;
            font-size: 0.4688rem;
            font-weight: 600;
        }

        .auditors-list-container {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 0.375rem 0;
            margin-bottom: 0.75rem;
        }

        .auditor-list-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.5625rem;
            background: white;
            border: 0.0469rem solid #e5e7eb;
            border-radius: 0.1875rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .auditor-list-item:hover {
            background: #f9fafb;
            border-color: #1A733E;
        }

        .auditor-list-item input[type="checkbox"] {
            cursor: pointer;
            accent-color: #1A733E;
            width: 0.6562rem;
            height: 0.6562rem;
        }

        .auditor-list-item input[type="checkbox"]:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .auditor-list-item:has(input[type="checkbox"]:disabled) {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .auditor-list-actions {
            display: flex;
            gap: 0.375rem;
            padding: 0.375rem 0;
            border-top: 0.0469rem solid #e5e7eb;
            margin-top: 0.375rem;
        }

        .auditor-list-actions button {
            flex: 1;
            padding: 0.2812rem;
            font-size: 0.5625rem;
            border-radius: 0.1875rem;
            border: 0.0469rem solid #d1d5db;
            background: white;
            color: #374151;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: all 0.2s;
        }

        .auditor-list-actions button:hover {
            background: #f3f4f6;
            border-color: #1A733E;
        }

        /* Pagination Styles */
        .pagination-btn {
            padding: 0.2812rem 0.5625rem;
            border: 0.0469rem solid #d1d5db;
            background: white;
            color: #374151;
            border-radius: 0.1875rem;
            font-size: 0.6094rem;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 1.875rem;
            text-align: center;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #1A733E;
            color: #1A733E;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #1A733E;
            color: white;
            border-color: #1A733E;
        }

        .pagination-btn.active:hover {
            background: #15582E;
        }

    </style>
</head>

<body>
<!-- Sidebar will be loaded dynamically by load-sidebar.js -->
 <main class="main-content" role="main">
    <p class="page-heading">Audit Distribution</p>
    <div style="margin-bottom: 1.125rem;"></div>

    <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 1.125rem; padding: 0 0.75rem; margin-top: 3rem;">
        <button id="topAutoAssignBtn" class="btn-assign" onclick="autoAssignBySupervisor()" style="display: flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.75rem;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="8.5" cy="7" r="4"/>
                <polyline points="17 11 19 13 23 9"/>
            </svg>
            Auto Assign to Quality Mentors
        </button>
    </div>

    <div class="distribution-container">
        
        <!-- Step 1: Manual Assignment -->
        <div class="section-card" id="employeesSection">
            <div class="section-header" onclick="toggleManualSection()" style="cursor: pointer;">
                <div class="section-number">1</div>
                <div style="flex: 1;">
                    <h2 class="section-title">Manual Assignment</h2>
                    <p class="section-subtitle">Filter and select employees to assign for auditing (scorecards will be auto-assigned based on their channel)</p>
                </div>
                <svg id="manualSectionIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transform: rotate(180deg); transition: transform 0.3s;">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </div>
            <div id="manualSectionContent" style="display: block;">

            <!-- Filters -->
            <div class="filter-grid">
                <div class="filter-group">
                    <label class="filter-label">Search Employee</label>
                    <input type="text" id="employeeSearch" class="filter-input" placeholder="Search by name..." oninput="applyFiltersAndGroup()">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Group By</label>
                    <select id="groupBySelect" class="filter-select" onchange="applyFiltersAndGroup()">
                        <option value="none" selected>None</option>
                        <option value="channel">Channel</option>
                        <option value="team">Team</option>
                        <option value="quality_mentor">Quality Mentor</option>
                        <option value="team_supervisor">Team Supervisor</option>
                        <option value="department">Department</option>
                        <option value="country">Country</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Filter by Channel</label>
                    <select id="channelFilter" class="filter-select" onchange="applyFiltersAndGroup()">
                        <option value="">All Channels</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Filter by Team</label>
                    <select id="teamFilter" class="filter-select" onchange="applyFiltersAndGroup()">
                        <option value="">All Teams</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Filter by Department</label>
                    <select id="departmentFilter" class="filter-select" onchange="applyFiltersAndGroup()">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Filter by Country</label>
                    <select id="countryFilter" class="filter-select" onchange="applyFiltersAndGroup()">
                        <option value="">All Countries</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Filter by Quality Mentor</label>
                    <select id="qualitySupervisorFilter" class="filter-select" onchange="applyFiltersAndGroup()">
                        <option value="">All Mentors</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Filter by Team Supervisor</label>
                    <select id="teamSupervisorFilter" class="filter-select" onchange="applyFiltersAndGroup()">
                        <option value="">All Team Supervisors</option>
                    </select>
                </div>
            </div>

            <!-- Quick Actions -->
            <div style="display: flex; gap: 0.375rem; margin-bottom: 0.5625rem; flex-wrap: wrap; align-items: center;">
                <button class="btn-secondary" onclick="selectAllVisible()">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 0.2812rem;">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Select All Visible
                </button>
                <button class="btn-secondary" onclick="deselectAll()">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 0.2812rem;">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                    Deselect All
                </button>
            </div>

            <!-- Split Layout: Employees (Left) and Auditors (Right) -->
            <div class="split-layout">
                <!-- Left Panel: Employees -->
                <div class="split-panel">
            <!-- Pagination Controls (Top) -->
            <div id="paginationControlsTop" style="display: none; justify-content: space-between; align-items: center; margin-bottom: 0.5625rem; padding: 0.375rem 0; flex-wrap: wrap; gap: 0.375rem;">
                <div style="display: flex; align-items: center; gap: 0.375rem;">
                    <label style="font-size: 0.6094rem; color: #374151; font-weight: 500;">Items per page:</label>
                    <select id="itemsPerPageSelect" class="filter-select" onchange="changeItemsPerPage(parseInt(this.value))" style="width: auto; min-width: 4rem; padding: 0.1875rem 0.375rem;">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div id="paginationInfoTop" style="font-size: 0.6094rem; color: #6b7280;"></div>
                <div id="paginationButtonsTop" style="display: flex; gap: 0.1875rem; align-items: center;"></div>
            </div>

            <!-- Grouped Employees -->
            <div id="groupedEmployeesContainer">
                <!-- Groups will be populated here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <p style="font-size: 0.75rem; font-weight: 600; margin: 0 0 0.375rem 0;">No employees found</p>
                <p style="font-size: 0.6562rem; margin: 0;">Try adjusting your filters or selecting a different scorecard</p>
            </div>

            <!-- Pagination Controls (Bottom) -->
            <div id="paginationControlsBottom" style="display: none; justify-content: space-between; align-items: center; margin-top: 0.5625rem; padding: 0.375rem 0; flex-wrap: wrap; gap: 0.375rem;">
                <div style="display: flex; align-items: center; gap: 0.375rem;">
                    <label style="font-size: 0.6094rem; color: #374151; font-weight: 500;">Items per page:</label>
                    <select id="itemsPerPageSelectBottom" class="filter-select" onchange="changeItemsPerPage(parseInt(this.value))" style="width: auto; min-width: 4rem; padding: 0.1875rem 0.375rem;">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div id="paginationInfoBottom" style="font-size: 0.6094rem; color: #6b7280;"></div>
                <div id="paginationButtonsBottom" style="display: flex; gap: 0.1875rem; align-items: center;"></div>
            </div>
            </div>
            
                <!-- Right Panel: Quality Analyst Selection -->
                <div class="split-panel">
                    <div class="auditors-panel" id="rightPanelContent" style="display: none;">
                        <div class="auditors-header">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0; color: #1A733E;">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="8.5" cy="7" r="4"/>
                                <polyline points="17 11 19 13 23 9"/>
                            </svg>
                            <h3 class="auditors-title">Select Quality Analyst(s)</h3>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem; flex: 1; min-height: 0;">
                            <div style="display: flex; flex-direction: column; gap: 0.375rem; flex-shrink: 0;">
                                <label style="font-size: 0.6094rem; font-weight: 600; color: #374151;">
                                    <span style="color: #ef4444;">*</span> Audits per employee:
                                </label>
                                <div class="counter-container" style="justify-content: center;">
                                    <button type="button" class="counter-btn" onclick="updateBulkAuditCount(Math.max(0, bulkAuditCount - 1))">âˆ’</button>
                                    <input type="number" id="bulkAuditCountRight" min="0" max="10" value="0" class="audit-count-input" onchange="updateBulkAuditCount(parseInt(this.value) || 0)" oninput="updateBulkAuditCount(parseInt(this.value) || 0)" style="width: 3rem;">
                                    <button type="button" class="counter-btn" onclick="updateBulkAuditCount(Math.min(10, bulkAuditCount + 1))">+</button>
                                </div>
                                <div id="totalAuditsDisplay" style="text-align: center; padding: 0.375rem 0; margin-top: 0.1875rem;">
                                    <div style="font-size: 0.5156rem; color: #6b7280; margin-bottom: 0.1875rem;">Total audits:</div>
                                    <div style="font-size: 0.75rem; font-weight: 700; color: #1A733E;" id="totalAuditsCount">0</div>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.375rem; flex: 1; min-height: 0;">
                                <label style="font-size: 0.6094rem; font-weight: 600; color: #374151; flex-shrink: 0;">
                                    <span style="color: #ef4444;">*</span> Quality Analyst(s):
                                </label>
                                <div class="auditors-list-container" id="auditorsListContainer">
                                    <!-- Quality Analyst list will be populated here -->
                                </div>
                            </div>
                            <button class="btn-assign" onclick="performBulkAssignment()" id="assignButtonRight" disabled style="width: 100%; flex-shrink: 0;">Assign Audits</button>
                        </div>
                    </div>
                    <div class="auditors-panel" id="rightPanelEmpty" style="display: flex; align-items: center; justify-content: center; min-height: 10rem;">
                        <div style="text-align: center; color: #6b7280;">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.3; margin-bottom: 0.75rem;">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="8.5" cy="7" r="4"/>
                                <polyline points="17 11 19 13 23 9"/>
                            </svg>
                            <p style="font-size: 0.75rem; font-weight: 600; margin: 0 0 0.375rem 0;">Select employees to assign</p>
                            <p style="font-size: 0.6562rem; margin: 0;">Choose employees from the list to select Quality Analysts</p>
                        </div>
                    </div>
                </div>
            </div>
            
            </div>
        </div>

        <!-- Agent-wise Audit Summary -->
        <div class="section-card" id="agentWiseSummarySection">
            <div class="section-header">
                <div style="flex: 1; display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 0.5625rem;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0;">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        <h2 class="section-title">Agent-wise Audit Summary</h2>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.375rem;">
                        <!-- Date Filter Buttons -->
                        <div style="display: flex; gap: 0.375rem; align-items: center;">
                            <button class="btn-secondary quick-date-btn" id="todayBtn" onclick="applyQuickDateFilter('today')" style="padding: 0.2812rem 0.5625rem; font-size: 0.5625rem;">Today</button>
                            <button class="btn-secondary quick-date-btn" id="yesterdayBtn" onclick="applyQuickDateFilter('yesterday')" style="padding: 0.2812rem 0.5625rem; font-size: 0.5625rem;">Yesterday</button>
                            <button class="btn-secondary quick-date-btn active" id="thisMonthBtn" onclick="applyQuickDateFilter('thisMonth')" style="padding: 0.2812rem 0.5625rem; font-size: 0.5625rem;">This Month</button>
                        </div>
                        <button class="btn-secondary" onclick="refreshAgentWiseSummary()" style="display: flex; align-items: center; gap: 0.375rem;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"/>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>
            <div style="margin-top: 0.75rem;">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.5625rem;">
                        <thead>
                            <tr style="background: #f9fafb; border-bottom: 0.0938rem solid #e5e7eb;">
                                <th style="text-align: left; padding: 0.375rem; font-weight: 600; color: #374151;">Agent</th>
                                <th style="text-align: left; padding: 0.375rem; font-weight: 600; color: #374151;">Channel</th>
                                <th style="text-align: center; padding: 0.375rem; font-weight: 600; color: #374151;">Audit Target</th>
                                <th style="text-align: center; padding: 0.375rem; font-weight: 600; color: #374151;">Total Assigned</th>
                                <th style="text-align: center; padding: 0.375rem; font-weight: 600; color: #374151;">Completed Audits</th>
                                <th style="text-align: left; padding: 0.375rem; font-weight: 600; color: #374151;">Progress</th>
                                <th style="text-align: left; padding: 0.375rem; font-weight: 600; color: #374151;">Breakdown by Auditor</th>
                            </tr>
                        </thead>
                        <tbody id="agentWiseSummaryTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 1.5rem; color: #6b7280;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Assigned Audits Summary -->
        <div class="section-card" id="assignedAuditsSection">
            <div class="section-header">
                <div style="flex: 1; display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 0.5625rem;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0;">
                            <line x1="18" y1="20" x2="18" y2="10"/>
                            <line x1="12" y1="20" x2="12" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="14"/>
                        </svg>
                        <h2 class="section-title">Assigned Audits Overview</h2>
                    </div>
                    <button class="btn-secondary" onclick="refreshAssignedAudits()" style="display: flex; align-items: center; gap: 0.375rem;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"/>
                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                        </svg>
                        Refresh
                    </button>
                </div>
            </div>
            <!-- Recent Assignments Table -->
            <div style="margin-top: 0.75rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5625rem;">
                    <div style="display: flex; align-items: center; gap: 0.5625rem;">
                        <h3 style="font-size: 0.6562rem; font-weight: 600; color: #374151; margin: 0;">All Assignments</h3>
                        <button id="clearFiltersBtn" class="btn-secondary" onclick="clearColumnFilters()" style="display: none; align-items: center; gap: 0.2812rem; padding: 0.2812rem 0.6562rem; font-size: 0.5625rem; background: #ef4444; color: white; border: none; font-weight: 600; transition: all 0.2s;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                            </svg>
                            Clear Filters
                        </button>
                    </div>
                    <div id="bulkAssignmentActions" style="display: none; gap: 0.375rem; align-items: center;">
                        <span id="bulkAssignmentCount" style="font-size: 0.6094rem; color: #6b7280;">0 selected</span>
                        <input type="number" id="bulkEditWeek" class="filter-input" placeholder="Week (1-52)" min="1" max="52" style="width: 3.5156rem; padding: 0.1875rem 0.375rem; font-size: 0.5625rem;">
                        <select id="bulkEditAuditor" class="filter-select" style="min-width: 5.2734rem; padding: 0.1875rem 0.375rem; font-size: 0.5625rem;">
                            <option value="">Change Auditor...</option>
                        </select>
                        <select id="bulkEditScorecard" class="filter-select" style="min-width: 5.2734rem; padding: 0.1875rem 0.375rem; font-size: 0.5625rem;">
                            <option value="">Change Scorecard...</option>
                        </select>
                        <button onclick="applyBulkEdit()" class="btn-secondary" style="background: #1A733E; color: white; border-color: #1A733E; padding: 0.1875rem 0.5625rem; font-size: 0.5625rem;">
                            Apply Changes
                        </button>
                        <button onclick="bulkDeleteAssignments()" class="btn-secondary" style="background: #ef4444; color: white; border-color: #ef4444; padding: 0.1875rem 0.5625rem; font-size: 0.5625rem;">
                            Delete Selected
                        </button>
                    </div>
                </div>
                <div style="overflow-x: auto; overflow-y: visible;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.5625rem;">
                        <thead style="position: relative;">
                            <tr style="background: #f9fafb; border-bottom: 0.0938rem solid #e5e7eb;">
                                <th style="text-align: center; padding: 0.2812rem; font-weight: 600; color: #374151; width: 1.0546rem;">
                                    <input type="checkbox" id="selectAllAssignments" onchange="toggleAllAssignments(this.checked)" style="cursor: pointer; accent-color: #1A733E;">
                                </th>
                                <th style="text-align: left; padding: 0.2812rem; font-weight: 600; color: #374151; cursor: pointer; position: relative;" onclick="toggleColumnFilter('week', event)">
                                    Week
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-left: 0.1875rem;">
                                        <polygon points="12 2 2 12 22 12"/>
                                    </svg>
                                </th>
                                <th style="text-align: left; padding: 0.2812rem; font-weight: 600; color: #374151; cursor: pointer; position: relative;" onclick="toggleColumnFilter('employee', event)">
                                    Employee
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-left: 0.1875rem;">
                                        <polygon points="12 2 2 12 22 12"/>
                                    </svg>
                                </th>
                                <th style="text-align: left; padding: 0.2812rem; font-weight: 600; color: #374151; cursor: pointer; position: relative;" onclick="toggleColumnFilter('channel', event)">
                                    Channel
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-left: 0.1875rem;">
                                        <polygon points="12 2 2 12 22 12"/>
                                    </svg>
                                </th>
                                <th style="text-align: left; padding: 0.2812rem; font-weight: 600; color: #374151; cursor: pointer; position: relative;" onclick="toggleColumnFilter('auditor', event)">
                                    Auditor
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-left: 0.1875rem;">
                                        <polygon points="12 2 2 12 22 12"/>
                                    </svg>
                                </th>
                                <th style="text-align: left; padding: 0.2812rem; font-weight: 600; color: #374151; cursor: pointer; position: relative;" onclick="toggleColumnFilter('scorecard', event)">
                                    Scorecard
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-left: 0.1875rem;">
                                        <polygon points="12 2 2 12 22 12"/>
                                    </svg>
                                </th>
                                <th style="text-align: left; padding: 0.2812rem; font-weight: 600; color: #374151; cursor: pointer; position: relative;" onclick="toggleColumnFilter('status', event)">
                                    Status
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-left: 0.1875rem;">
                                        <polygon points="12 2 2 12 22 12"/>
                                    </svg>
                                </th>
                                <th style="text-align: left; padding: 0.2812rem; font-weight: 600; color: #374151;">Created</th>
                                <th style="text-align: center; padding: 0.2812rem; font-weight: 600; color: #374151;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="assignedAuditsTableBody">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 1.5rem; color: #6b7280;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</main>

<script>
// ============================================================================
// Global Variables
// ============================================================================
let allScorecards = []; // All active scorecards
let allEmployees = [];
let allUsers = []; // All users including QAs (for lookups)
let filteredEmployees = [];
let selectedEmployees = new Map(); // email -> { employee, auditCount }
let qualityAnalysts = [];
let channels = [];
let allAssignments = []; // Store all assignments for filtering
let bulkAuditCount = 0; // Global bulk audit count (default 0, mandatory)
let selectedQualityAnalysts = new Set(); // Set of selected QA emails
let completedAuditsCache = new Map(); // Cache for completed audit counts (email -> count)
let dateFilter = { start: null, end: null }; // Date filter for completed audits
let columnFilters = {
    week: [],
    employee: [],
    channel: [],
    auditor: [],
    scorecard: [],
    status: []
};
// Pagination state
let currentPage = 1;
let itemsPerPage = 20;

// ============================================================================
// Initialize Page
// ============================================================================
document.addEventListener('DOMContentLoaded', async function() {
    await initializePage();
});

async function initializePage() {
    try {
        // Wait for Supabase to be ready
        let attempts = 0;
        while (!window.supabaseClient && attempts < 50) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
        }

        if (!window.supabaseClient) {
            console.error('Supabase client not initialized');
            return;
        }

        // Check page access using centralized access control
        if (!window.accessControl || !window.accessControl.enforcePageAccess('audit-distribution.html')) {
            return; // Access denied, user will be redirected
        }

        // Load users first (needed for lookups)
        await loadAllUsers();
        
        // Then load everything else in parallel
        await Promise.all([
            loadScorecards(),
            loadQualityAnalysts(),
            loadChannels(),
            loadEmployees()
        ]);
        
        // Initialize date filter to current month (default)
        initializeDateFilter();
        
        // Then load assignments (depends on allUsers being loaded)
        await loadAssignedAudits();
        await loadCompletedAuditsCache(); // Load completed audits cache for employee stats
        
        // Now render the employee list with audit stats
        applyFiltersAndGroup();
        
        await loadAgentWiseSummary();
        
    } catch (error) {
        console.error('Error initializing page:', error);
    }
}

// ============================================================================
// Load Data
// ============================================================================
async function loadScorecards() {
    try {
        const { data, error } = await window.supabaseClient
            .from('scorecards')
            .select('*')
            .eq('is_active', true)
            .order('name', { ascending: true });
        
        if (error) throw error;
        
        allScorecards = data || [];
        console.log(`Loaded ${allScorecards.length} active scorecards`);
        
    } catch (error) {
        console.error('Error loading scorecards:', error);
        allScorecards = [];
    }
}

async function loadQualityAnalysts() {
    try {
        const { data, error } = await window.supabaseClient
            .from('users')
            .select('*')
            .eq('role', 'Quality Analyst')
            .eq('is_active', true)
            .order('name', { ascending: true });
        
        if (error) throw error;
        
        qualityAnalysts = data || [];
        populateQADropdown();
        
    } catch (error) {
        console.error('Error loading Quality Analysts:', error);
        qualityAnalysts = [];
    }
}

async function loadChannels() {
    try {
        const { data, error } = await window.supabaseClient
            .from('channels')
            .select('name')
            .eq('is_active', true)
            .order('name', { ascending: true });
        
        if (error) throw error;
        
        channels = data.map(c => c.name);
        
    } catch (error) {
        console.error('Error loading channels:', error);
        channels = [];
    }
}

async function loadAllUsers() {
    try {
        const { data, error } = await window.supabaseClient
            .from('users')
            .select('email, name, channel, role')
            .eq('is_active', true)
            .order('name', { ascending: true });
        
        if (error) {
            console.error('Supabase error loading all users:', error);
            throw error;
        }
        
        allUsers = data || [];
        console.log(`Loaded ${allUsers.length} users for lookups`);
        
    } catch (error) {
        console.error('Error loading all users:', error);
        allUsers = [];
    }
}

async function loadEmployees() {
    try {
        const { data, error } = await window.supabaseClient
            .from('users')
            .select('*')
            .eq('is_active', true)
            .in('role', ['Employee', 'Agent']) // Only include Employee and Agent roles for auditing
            .order('name', { ascending: true });
        
        if (error) throw error;
        
        allEmployees = data || [];
        
        // No filtering by scorecard - load ALL employees
        populateFilters();
        // Don't call applyFiltersAndGroup() here - wait for assignments and cache to load
        // It will be called after loadAssignedAudits() and loadCompletedAuditsCache()
        
    } catch (error) {
        console.error('Error loading employees:', error);
        allEmployees = [];
    }
}

// ============================================================================
// Get Applicable Scorecards for Employee
// ============================================================================
function getApplicableScorecardsForEmployee(employee) {
    if (!employee.channel) {
        return [];
    }
    
    return allScorecards.filter(scorecard => {
        if (!scorecard.channels) return false;
        const scorecardChannels = scorecard.channels.split(',').map(c => c.trim());
        return scorecardChannels.includes(employee.channel);
    });
}

// ============================================================================
// Load Assigned Audits
// ============================================================================
async function loadAssignedAudits() {
    try {
        console.log('Loading assignments. allUsers count:', allUsers.length, 'qualityAnalysts count:', qualityAnalysts.length);
        
        // Load assignments from audit_assignments table with scorecard info
        const { data, error } = await window.supabaseClient
            .from('audit_assignments')
            .select(`
                *,
                scorecards:scorecard_id (
                    id,
                    name,
                    table_name
                )
            `)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        console.log('Loaded assignments:', data?.length || 0);
        
        // Store assignments for filtering
        allAssignments = data || [];
        
        // Calculate stats
        const stats = {
            pending: 0,
            in_progress: 0,
            completed: 0,
            total: data ? data.length : 0
        };
        
        if (data) {
            data.forEach(assignment => {
                if (assignment.status === 'pending') stats.pending++;
                else if (assignment.status === 'in_progress') stats.in_progress++;
                else if (assignment.status === 'completed') stats.completed++;
            });
        }
        
        // Update stats
        
        // Populate table
        const tbody = document.getElementById('assignedAuditsTableBody');
        
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 1.5rem; color: #6b7280;">No assignments found</td></tr>';
            populateBulkEditDropdowns();
            return;
        }
        
        // Populate bulk edit dropdowns
        populateBulkEditDropdowns();
        
        tbody.innerHTML = data.map((assignment, index) => {
            const statusColors = {
                'pending': 'background: #fef3c7; color: #92400e;',
                'in_progress': 'background: #dbeafe; color: #1e40af;',
                'completed': 'background: #d1fae5; color: #065f46;',
                'cancelled': 'background: #fee2e2; color: #991b1b;'
            };
            
            const createdDate = new Date(assignment.created_at);
            const formattedDate = createdDate.toLocaleDateString() + ' ' + createdDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Find auditor name from qualityAnalysts, allEmployees, or allUsers
            let auditorName = assignment.auditor_email.split('@')[0];
            const auditor = qualityAnalysts.find(qa => qa.email === assignment.auditor_email) || 
                           allEmployees.find(emp => emp.email === assignment.auditor_email) ||
                           allUsers.find(u => u.email === assignment.auditor_email);
            if (auditor && auditor.name) {
                auditorName = auditor.name;
            }
            
            // Get channel by looking up in allUsers
            const user = allUsers.find(u => u.email === assignment.employee_email);
            const channel = user?.channel || '-';
            
            // Debug first assignment
            if (index === 0) {
                console.log('First assignment:', {
                    employee_email: assignment.employee_email,
                    auditor_email: assignment.auditor_email,
                    user_found: !!user,
                    channel: channel,
                    auditor_found: !!auditor,
                    auditorName: auditorName,
                    allUsers_sample: allUsers.slice(0, 2).map(u => ({ email: u.email, channel: u.channel }))
                });
            }
            
            // Find employee to get applicable scorecards
            const employee = allEmployees.find(emp => emp.email === assignment.employee_email) ||
                           allUsers.find(u => u.email === assignment.employee_email);
            const applicableScorecards = employee ? getApplicableScorecardsForEmployee(employee) : [];
            
            // Allow editing (week, auditor, scorecard) only for pending audits
            const isEditable = assignment.status === 'pending';
            // Allow deletion for both pending and in_progress audits
            const isDeletable = assignment.status === 'pending' || assignment.status === 'in_progress';
            
            // Build auditor options
            let auditorOptions = '';
            if (isEditable) {
                auditorOptions = qualityAnalysts.map(qa => 
                    `<option value="${qa.email}" ${qa.email === assignment.auditor_email ? 'selected' : ''}>${escapeHtml(qa.name)}</option>`
                ).join('');
            }
            
            // Build scorecard options
            let scorecardOptions = '';
            if (isEditable) {
                if (applicableScorecards.length > 0) {
                    scorecardOptions = applicableScorecards.map(sc => 
                        `<option value="${sc.id}" ${sc.id === assignment.scorecard_id ? 'selected' : ''}>${escapeHtml(sc.name)}</option>`
                    ).join('');
                } else {
                    scorecardOptions = `<option value="${assignment.scorecard_id}" selected>${escapeHtml(assignment.scorecard?.name || 'Current Scorecard')}</option>`;
                }
            }
            
            return `
                <tr style="border-bottom: 0.0469rem solid #f3f4f6;" data-assignment-id="${assignment.id}">
                    <td style="padding: 0.2812rem; text-align: center;">
                        <input type="checkbox" class="assignment-checkbox" data-assignment-id="${assignment.id}" 
                               onchange="toggleAssignmentSelection()" style="cursor: pointer; accent-color: #1A733E;">
                    </td>
                    <td style="padding: 0.2812rem; font-size: 0.5625rem;">
                        ${isEditable ? `
                            <input type="number" class="week-input" data-assignment-id="${assignment.id}" 
                                   value="${assignment.week || ''}" min="1" max="52" 
                                   onchange="updateWeek('${assignment.id}', this.value)"
                                   style="width: 2.25rem; padding: 0.0938rem 0.1875rem; border: 0.0352rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5625rem; font-family: 'Poppins', sans-serif; text-align: center;">
                        ` : (assignment.week || '-')}
                    </td>
                    <td style="padding: 0.2812rem; font-size: 0.5625rem;">${escapeHtml(assignment.employee_name || assignment.employee_email)}</td>
                    <td style="padding: 0.2812rem; color: #6b7280; font-size: 0.5625rem;">${escapeHtml(channel)}</td>
                    <td style="padding: 0.2812rem; font-size: 0.5625rem;">
                        ${escapeHtml(auditorName)}
                    </td>
                    <td style="padding: 0.2812rem; font-size: 0.5625rem;">
                        ${escapeHtml(assignment.scorecard?.name || 'N/A')}
                    </td>
                    <td style="padding: 0.2812rem;">
                        <span style="padding: 0.0938rem 0.2812rem; border-radius: 0.1875rem; font-size: 0.4688rem; font-weight: 600; ${statusColors[assignment.status] || ''}">
                            ${assignment.status.replace('_', ' ').toUpperCase()}
                        </span>
                    </td>
                    <td style="padding: 0.2812rem; color: #6b7280; font-size: 0.5156rem;">${formattedDate}</td>
                    <td style="padding: 0.2812rem; text-align: center;">
                            ${isDeletable ? `
                                <div style="display: flex; gap: 0.1875rem; justify-content: center;">
                                    <button onclick="deleteAssignment('${assignment.id}')" 
                                        class="btn-action btn-action-danger"
                                        title="Delete">
                                        <svg style="width: 0.6562rem; height: 0.6562rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                            <line x1="10" y1="11" x2="10" y2="17"/>
                                            <line x1="14" y1="11" x2="14" y2="17"/>
                                        </svg>
                                    </button>
                                </div>
                            ` : `
                            <span style="color: #9ca3af; font-size: 0.4688rem;">-</span>
                            `}
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error loading assigned audits:', error);
        const tbody = document.getElementById('assignedAuditsTableBody');
        tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 1.5rem; color: #ef4444;">Error loading assignments: ${error.message || 'Unknown error'}</td></tr>`;
    }
}

async function refreshAssignedAudits() {
    await loadAssignedAudits();
    await loadCompletedAuditsCache(); // Refresh completed audits cache with current date filter
    await loadAgentWiseSummary();
    // Refresh employee list to update stats
    applyFiltersAndGroup();
}

// ============================================================================
// Audit Target Management
// ============================================================================
function getAuditTargetKey(agentEmail, year, month) {
    return `audit_target_${agentEmail}_${year}_${month}`;
}

function getAuditTarget(agentEmail, year, month, defaultValue = 22) {
    try {
        const key = getAuditTargetKey(agentEmail, year, month);
        const stored = localStorage.getItem(key);
        if (stored !== null) {
            const value = parseInt(stored);
            return isNaN(value) ? defaultValue : value;
        }
    } catch (e) {
        console.warn('Error reading audit target:', e);
    }
    return defaultValue;
}

function setAuditTarget(agentEmail, year, month, target) {
    try {
        const key = getAuditTargetKey(agentEmail, year, month);
        const value = parseInt(target);
        if (!isNaN(value) && value >= 0) {
            localStorage.setItem(key, value.toString());
            return true;
        }
    } catch (e) {
        console.error('Error saving audit target:', e);
    }
    return false;
}

function getCurrentMonthYear() {
    const now = new Date();
    return {
        year: now.getFullYear(),
        month: now.getMonth() + 1 // 1-12
    };
}

// ============================================================================
// Load Agent-wise Summary
// ============================================================================
async function loadAgentWiseSummary() {
    try {
        const tbody = document.getElementById('agentWiseSummaryTableBody');
        if (!tbody) return;
        
        if (!allAssignments || allAssignments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 1.5rem; color: #6b7280;">No assignments found</td></tr>';
            return;
        }
        
        // Get current month/year for target storage
        const { year, month } = getCurrentMonthYear();
        
        // Group assignments by employee (agent)
        const agentStats = new Map();
        
        allAssignments.forEach(assignment => {
            const employeeEmail = assignment.employee_email;
            const employeeName = assignment.employee_name || employeeEmail;
            
            // Get channel from allUsers
            const user = allUsers.find(u => u.email === employeeEmail);
            const channel = user?.channel || '-';
            
            if (!agentStats.has(employeeEmail)) {
                // Get saved target for this agent and month, default to 22
                const target = getAuditTarget(employeeEmail, year, month, 22);
                agentStats.set(employeeEmail, {
                    name: employeeName,
                    email: employeeEmail,
                    channel: channel,
                    target: target,
                    totalAudits: 0,
                    completedAudits: 0, // Will be populated from audit tables
                    auditorBreakdown: new Map() // auditor_email -> count
                });
            }
            
            const stats = agentStats.get(employeeEmail);
            stats.totalAudits++;
            
            // Get auditor name
            const auditor = allUsers.find(u => u.email === assignment.auditor_email) ||
                           qualityAnalysts.find(qa => qa.email === assignment.auditor_email);
            const auditorName = auditor?.name || assignment.auditor_email.split('@')[0];
            
            // Update auditor breakdown
            if (!stats.auditorBreakdown.has(assignment.auditor_email)) {
                stats.auditorBreakdown.set(assignment.auditor_email, {
                    name: auditorName,
                    count: 0
                });
            }
            stats.auditorBreakdown.get(assignment.auditor_email).count++;
        });
        
        // Update agent stats with completed audit counts from cache
        agentStats.forEach((stats, email) => {
            const normalizedEmail = (email || '').toLowerCase().trim();
            stats.completedAudits = completedAuditsCache.get(normalizedEmail) || 0;
        });
        
        // Convert to array and sort by name
        const agentArray = Array.from(agentStats.values()).sort((a, b) => 
            a.name.localeCompare(b.name)
        );
        
        if (agentArray.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 1.5rem; color: #6b7280;">No assignments found</td></tr>';
            return;
        }
        
        // Render table rows
        tbody.innerHTML = agentArray.map(agent => {
            // Calculate progress percentage relative to agent's target
            const progressPercentage = agent.target > 0 
                ? Math.min(100, Math.round((agent.completedAudits / agent.target) * 100))
                : 0;
            
            // Sanitize email for use in IDs
            const sanitizedEmail = sanitizeEmailForId(agent.email);
            
            // Build auditor breakdown HTML
            const auditorBreakdownHtml = Array.from(agent.auditorBreakdown.entries())
                .sort((a, b) => b[1].count - a[1].count) // Sort by count descending
                .map(([auditorEmail, data]) => {
                    return `
                        <div style="display: flex; align-items: center; gap: 0.375rem; padding: 0.1875rem 0; border-bottom: 0.0352rem solid #f3f4f6;">
                            <span style="font-weight: 600; color: #374151; min-width: 6rem;">${escapeHtml(data.name)}:</span>
                            <span style="color: #374151; font-size: 0.5625rem;">${data.count}</span>
                        </div>
                    `;
                }).join('');
            
            return `
                <tr data-email="${escapeHtml(agent.email)}" data-completed="${agent.completedAudits}" style="border-bottom: 0.0469rem solid #f3f4f6;">
                    <td style="padding: 0.375rem; font-size: 0.5625rem; font-weight: 600; color: #374151;">
                        ${escapeHtml(agent.name)}
                    </td>
                    <td style="padding: 0.375rem; font-size: 0.5625rem; color: #6b7280;">
                        ${escapeHtml(agent.channel)}
                    </td>
                    <td style="padding: 0.375rem; text-align: center;">
                        <input type="number" 
                               class="audit-target-input" 
                               data-email="${escapeHtml(agent.email)}"
                               value="${agent.target}"
                               min="0"
                               max="100"
                               onchange="updateAuditTarget('${escapeHtml(agent.email)}', this.value)"
                               onblur="updateAuditTarget('${escapeHtml(agent.email)}', this.value)">
                    </td>
                    <td style="padding: 0.375rem; text-align: center; font-size: 0.5625rem; color: #374151;">
                        ${agent.totalAudits}
                    </td>
                    <td style="padding: 0.375rem; text-align: center; font-size: 0.5625rem; color: #374151;">
                        ${agent.completedAudits}
                    </td>
                    <td style="padding: 0.375rem; font-size: 0.5625rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span id="progress-text-${sanitizedEmail}" style="font-size: 0.5625rem; font-weight: 600; color: #374151; min-width: 1.875rem;">${progressPercentage}%</span>
                            <div style="flex: 1; height: 0.5625rem; background-color: #e5e7eb; border-radius: 0.2812rem; overflow: hidden; position: relative;">
                                <div id="progress-bar-${sanitizedEmail}" style="height: 100%; width: ${progressPercentage}%; background-color: #1A733E; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 0.375rem; font-size: 0.5625rem;">
                        <button onclick="toggleBreakdown('${escapeHtml(agent.email)}')" 
                                style="display: flex; align-items: center; gap: 0.375rem; padding: 0.1875rem 0.375rem; background: none; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; cursor: pointer; font-size: 0.5625rem; color: #374151; font-family: 'Poppins', sans-serif; transition: all 0.2s;"
                                onmouseover="this.style.backgroundColor='#f3f4f6'; this.style.borderColor='#9ca3af';"
                                onmouseout="this.style.backgroundColor='transparent'; this.style.borderColor='#d1d5db';">
                            <svg id="breakdown-icon-${sanitizedEmail}" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
                                <path d="M9 18l6-6-6-6"/>
                            </svg>
                            <span>Show</span>
                        </button>
                        <div id="breakdown-content-${sanitizedEmail}" style="display: none; margin-top: 0.375rem; padding: 0.375rem; background: #f9fafb; border-radius: 0.1875rem; border: 0.0469rem solid #e5e7eb;">
                            <div style="display: flex; flex-direction: column; gap: 0.1875rem;">
                                ${auditorBreakdownHtml || '<span style="color: #9ca3af;">No auditors assigned</span>'}
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error loading agent-wise summary:', error);
        const tbody = document.getElementById('agentWiseSummaryTableBody');
        if (tbody) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 1.5rem; color: #ef4444;">Error loading summary: ${error.message || 'Unknown error'}</td></tr>`;
        }
    }
}

async function refreshAgentWiseSummary() {
    await loadCompletedAuditsCache(); // Reload with current date filter
    await loadAgentWiseSummary();
    applyFiltersAndGroup(); // Refresh employee list to update stats
}

// Sanitize email for use in DOM IDs
function sanitizeEmailForId(email) {
    return (email || '').replace(/[^a-zA-Z0-9]/g, '_');
}

// Toggle breakdown visibility for an agent
window.toggleBreakdown = function(agentEmail) {
    const sanitizedEmail = sanitizeEmailForId(agentEmail);
    const contentId = `breakdown-content-${sanitizedEmail}`;
    const iconId = `breakdown-icon-${sanitizedEmail}`;
    const content = document.getElementById(contentId);
    const icon = document.getElementById(iconId);
    const button = icon?.closest('button');
    
    if (!content || !icon || !button) return;
    
    const isHidden = content.style.display === 'none';
    
    if (isHidden) {
        content.style.display = 'block';
        icon.style.transform = 'rotate(90deg)';
        const span = button.querySelector('span');
        if (span) span.textContent = 'Hide';
    } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
        const span = button.querySelector('span');
        if (span) span.textContent = 'Show';
    }
};

// Update audit target for an agent
window.updateAuditTarget = function(agentEmail, targetValue) {
    const { year, month } = getCurrentMonthYear();
    
    // Handle empty string
    if (targetValue === '' || targetValue === null || targetValue === undefined) {
        const previousTarget = getAuditTarget(agentEmail, year, month, 22);
        const input = document.querySelector(`input.audit-target-input[data-email="${agentEmail}"]`);
        if (input) {
            input.value = previousTarget;
        }
        return;
    }
    
    const target = parseInt(targetValue);
    
    if (isNaN(target) || target < 0) {
        // Invalid value, restore previous value
        const previousTarget = getAuditTarget(agentEmail, year, month, 22);
        const input = document.querySelector(`input.audit-target-input[data-email="${agentEmail}"]`);
        if (input) {
            input.value = previousTarget;
        }
        return;
    }
    
    // Check if value actually changed
    const currentTarget = getAuditTarget(agentEmail, year, month, 22);
    if (target === currentTarget) {
        return; // No change, don't update
    }
    
    // Save the target
    if (setAuditTarget(agentEmail, year, month, target)) {
        // Update progress bar immediately without reloading
        updateProgressBar(agentEmail, target);
    }
};

// Update progress bar for a specific agent
function updateProgressBar(agentEmail, target) {
    const sanitizedEmail = sanitizeEmailForId(agentEmail);
    // Find row by iterating through rows and checking data-email attribute
    const rows = document.querySelectorAll('tr[data-email]');
    let row = null;
    for (const r of rows) {
        if (r.getAttribute('data-email') === agentEmail) {
            row = r;
            break;
        }
    }
    
    if (!row) return;
    
    // Get completed audits from data attribute
    const completedAudits = parseInt(row.getAttribute('data-completed')) || 0;
    
    // Calculate new progress percentage
    const progressPercentage = target > 0 
        ? Math.min(100, Math.round((completedAudits / target) * 100))
        : 0;
    
    // Update progress text
    const progressText = document.getElementById(`progress-text-${sanitizedEmail}`);
    if (progressText) {
        progressText.textContent = `${progressPercentage}%`;
    }
    
    // Update progress bar width
    const progressBar = document.getElementById(`progress-bar-${sanitizedEmail}`);
    if (progressBar) {
        progressBar.style.width = `${progressPercentage}%`;
    }
}

// ============================================================================
// Edit & Delete Assignments
// ============================================================================
function handleAssignmentChange(assignmentId) {
    // Show the save button for this row
    const saveBtn = document.querySelector(`.save-assignment-btn[data-assignment-id="${assignmentId}"]`);
    if (saveBtn) {
        saveBtn.style.display = 'flex';
    }
}

async function saveAssignment(assignmentId) {
    try {
        // Get the new values from the dropdowns
        const auditorSelect = document.querySelector(`.assignment-auditor-select[data-assignment-id="${assignmentId}"]`);
        const scorecardSelect = document.querySelector(`.assignment-scorecard-select[data-assignment-id="${assignmentId}"]`);
        
        if (!auditorSelect || !scorecardSelect) {
            throw new Error('Could not find assignment fields');
        }
        
        const newAuditor = auditorSelect.value;
        const newScorecard = scorecardSelect.value;
        const originalAuditor = auditorSelect.dataset.original;
        const originalScorecard = scorecardSelect.dataset.original;
        
        // Check if anything changed
        if (newAuditor === originalAuditor && newScorecard === originalScorecard) {
            // Nothing changed, just hide the save button
            const saveBtn = document.querySelector(`.save-assignment-btn[data-assignment-id="${assignmentId}"]`);
            if (saveBtn) saveBtn.style.display = 'none';
            return;
        }
        
        const updateData = {};
        if (newAuditor) updateData.auditor_email = newAuditor;
        if (newScorecard) updateData.scorecard_id = newScorecard;
        
        const { error: updateError } = await window.supabaseClient
            .from('audit_assignments')
            .update(updateData)
            .eq('id', assignmentId);
        
        if (updateError) throw updateError;
        
        // Show success message
        await window.confirmationDialog.show({
            title: 'Success!',
            message: 'Assignment updated successfully.',
            confirmText: 'OK',
            type: 'success'
        });
        
        // Refresh the table
        await loadAssignedAudits();
        
    } catch (error) {
        console.error('Error saving assignment:', error);
        await window.confirmationDialog.show({
            title: 'Error',
            message: 'Failed to update assignment: ' + error.message,
            confirmText: 'OK',
            type: 'error'
        });
    }
}

async function deleteAssignment(assignmentId) {
    try {
        // Find the assignment in local data
        const assignment = allAssignments.find(a => a.id === assignmentId);
        if (!assignment) {
            throw new Error('Assignment not found');
        }
        
        // Get table name from scorecard
        const scorecard = allScorecards.find(sc => sc.id === assignment.scorecard_id);
        if (!scorecard || !scorecard.table_name) {
            throw new Error('Could not find scorecard table');
        }
        
        // Find auditor name
        let auditorName = assignment.auditor_email.split('@')[0];
        const auditor = qualityAnalysts.find(qa => qa.email === assignment.auditor_email) || 
                       allEmployees.find(emp => emp.email === assignment.auditor_email) ||
                       allUsers.find(u => u.email === assignment.auditor_email);
        if (auditor && auditor.name) {
            auditorName = auditor.name;
        }
        
        const confirmed = await window.confirmationDialog.show({
            title: 'Delete Assignment',
            message: `Are you sure you want to delete this assignment?\n\nEmployee: ${assignment.employee_name || assignment.employee_email}\nAuditor: ${auditorName}\nScorecard: ${assignment.scorecard?.name || scorecard.name || 'N/A'}\n\nThis action cannot be undone.`,
            confirmText: 'Delete',
            cancelText: 'Cancel',
            type: 'warning'
        });
        
        if (!confirmed) return;
        
        // Delete the assignment
        const { error: deleteError } = await window.supabaseClient
            .from('audit_assignments')
            .delete()
            .eq('id', assignmentId);
        
        if (deleteError) throw deleteError;
        
        await window.confirmationDialog.show({
            title: 'Success!',
            message: 'Assignment deleted successfully.',
            confirmText: 'OK',
            type: 'success'
        });
        
        // Refresh the table and employee list to show updated stats
        await loadAssignedAudits();
        applyFiltersAndGroup(); // Refresh employee list to update audit counts
        await loadAgentWiseSummary();
        
    } catch (error) {
        console.error('Error deleting assignment:', error);
        await window.confirmationDialog.show({
            title: 'Error',
            message: 'Failed to delete assignment: ' + error.message,
            confirmText: 'OK',
            type: 'error'
        });
    }
}

// ============================================================================
// Populate Quality Analysts List
// ============================================================================
function populateQADropdown() {
    const container = document.getElementById('auditorsListContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (qualityAnalysts.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 1.5rem 0.75rem; color: #6b7280; font-size: 0.6094rem;">No Quality Analysts available</div>';
        return;
    }
    
    // Calculate total audits and audits per auditor
    let totalAudits = 0;
    selectedEmployees.forEach((data) => {
        totalAudits += data.auditCount;
    });
    
    const selectedAuditorCount = selectedQualityAnalysts.size;
    const auditsPerAuditor = selectedAuditorCount > 0 ? Math.ceil(totalAudits / selectedAuditorCount) : 0;
    
    // Check if audit count is set (required for selection)
    const canSelectAuditors = bulkAuditCount > 0;
    
    // Add individual QA items (audits will be distributed evenly among selected auditors)
    qualityAnalysts.forEach(qa => {
        const listItem = document.createElement('div');
        listItem.className = 'auditor-list-item';
        const isSelected = selectedQualityAnalysts.has(qa.email);
        
        listItem.onclick = function(e) {
            if (e.target.type !== 'checkbox' && canSelectAuditors) {
                const checkbox = listItem.querySelector('input[type="checkbox"]');
                if (checkbox && !checkbox.disabled) {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            }
        };
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `qa-checkbox-${qa.email}`;
        checkbox.value = qa.email;
        checkbox.checked = isSelected;
        checkbox.disabled = !canSelectAuditors;
        checkbox.addEventListener('change', function(e) {
            e.stopPropagation();
            if (canSelectAuditors) {
                toggleQASelection(qa.email, this.checked);
            } else {
                this.checked = false;
            }
        });
        
        const avatar = document.createElement('div');
        avatar.className = 'auditor-avatar';
        const initials = qa.name ? qa.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'QA';
        avatar.textContent = initials;
        
        const nameContainer = document.createElement('div');
        nameContainer.style.cssText = 'display: flex; align-items: center; justify-content: space-between; flex: 1; gap: 0.375rem;';
        
        const name = document.createElement('p');
        name.className = 'auditor-name';
        name.textContent = qa.name || qa.email;
        name.style.margin = '0';
        
        nameContainer.appendChild(name);
        
        // Show audit count badge if auditor is selected
        if (isSelected && auditsPerAuditor > 0) {
            const badge = document.createElement('span');
            badge.className = 'auditor-badge';
            badge.textContent = `${auditsPerAuditor} audit${auditsPerAuditor !== 1 ? 's' : ''}`;
            nameContainer.appendChild(badge);
        }
        
        listItem.appendChild(checkbox);
        listItem.appendChild(avatar);
        listItem.appendChild(nameContainer);
        container.appendChild(listItem);
    });
    
    // Add action buttons
    const actions = document.createElement('div');
    actions.className = 'auditor-list-actions';
    
    const selectAllBtn = document.createElement('button');
    selectAllBtn.textContent = 'Select All';
    selectAllBtn.disabled = !canSelectAuditors;
    selectAllBtn.onclick = function(e) {
        e.stopPropagation();
        if (canSelectAuditors) {
            selectAllQAs();
        }
    };
    
    const clearBtn = document.createElement('button');
    clearBtn.textContent = 'Clear';
    clearBtn.onclick = function(e) {
        e.stopPropagation();
        deselectAllQAs();
    };
    
    actions.appendChild(selectAllBtn);
    actions.appendChild(clearBtn);
    container.appendChild(actions);
    
    updateAssignButton();
}

function renderAuditorsList() {
    // Re-render the list to update checkbox states
    populateQADropdown();
}


function populateFilters() {
    // Populate channel filter
    const channelFilter = document.getElementById('channelFilter');
    const uniqueChannels = [...new Set(allEmployees.map(e => e.channel).filter(Boolean))];
    
    channelFilter.innerHTML = '<option value="">All Channels</option>';
    uniqueChannels.sort().forEach(channel => {
        const option = document.createElement('option');
        option.value = channel;
        option.textContent = channel;
        channelFilter.appendChild(option);
    });
    
    // Populate team filter
    const teamFilter = document.getElementById('teamFilter');
    const uniqueTeams = [...new Set(allEmployees.map(e => e.team).filter(Boolean))];
    
    teamFilter.innerHTML = '<option value="">All Teams</option>';
    uniqueTeams.sort().forEach(team => {
        const option = document.createElement('option');
        option.value = team;
        option.textContent = team;
        teamFilter.appendChild(option);
    });
    
    // Populate department filter
    const departmentFilter = document.getElementById('departmentFilter');
    const uniqueDepartments = [...new Set(allEmployees.map(e => e.department).filter(Boolean))];
    
    departmentFilter.innerHTML = '<option value="">All Departments</option>';
    uniqueDepartments.sort().forEach(department => {
        const option = document.createElement('option');
        option.value = department;
        option.textContent = department;
        departmentFilter.appendChild(option);
    });
    
    // Populate country filter
    const countryFilter = document.getElementById('countryFilter');
    const uniqueCountries = [...new Set(allEmployees.map(e => e.country).filter(Boolean))];
    
    countryFilter.innerHTML = '<option value="">All Countries</option>';
    uniqueCountries.sort().forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        countryFilter.appendChild(option);
    });
    
    // Populate quality supervisor filter
    const qsFilter = document.getElementById('qualitySupervisorFilter');
    const uniqueQS = [...new Set(allEmployees.map(e => e.quality_mentor).filter(Boolean))];
    
    qsFilter.innerHTML = '<option value="">All Mentors</option>';
    
    // Create options with names and sort by name
    const supervisorOptions = uniqueQS.map(qs => {
        const qsUser = allUsers.find(u => u.email === qs);
        return {
            email: qs,
            name: qsUser ? qsUser.name : qs
        };
    }).sort((a, b) => a.name.localeCompare(b.name));
    
    supervisorOptions.forEach(supervisor => {
        const option = document.createElement('option');
        option.value = supervisor.email;
        option.textContent = supervisor.name;
        qsFilter.appendChild(option);
    });
    
    // Populate team supervisor filter
    const tsFilter = document.getElementById('teamSupervisorFilter');
    const uniqueTS = [...new Set(allEmployees.map(e => e.team_supervisor).filter(Boolean))];
    
    tsFilter.innerHTML = '<option value="">All Team Supervisors</option>';
    
    // Create options with names and sort by name
    const teamSupervisorOptions = uniqueTS.map(ts => {
        const tsUser = allUsers.find(u => u.email === ts);
        return {
            email: ts,
            name: tsUser ? tsUser.name : ts
        };
    }).sort((a, b) => a.name.localeCompare(b.name));
    
    teamSupervisorOptions.forEach(supervisor => {
        const option = document.createElement('option');
        option.value = supervisor.email;
        option.textContent = supervisor.name;
        tsFilter.appendChild(option);
    });
}

// ============================================================================
// Get Audit Stats for Employee
// ============================================================================
function getEmployeeAuditStats(employeeEmail) {
    if (!employeeEmail) {
        return { assigned: 0, completed: 0 };
    }
    
    // Normalize email for comparison
    const normalizedEmail = (employeeEmail || '').toLowerCase().trim();
    
    // Count assigned audits (all statuses except cancelled)
    // Normalize both sides for comparison
    const assignedCount = allAssignments.filter(a => {
        if (!a.employee_email || a.status === 'cancelled') return false;
        const assignmentEmail = (a.employee_email || '').toLowerCase().trim();
        return assignmentEmail === normalizedEmail;
    }).length;
    
    // Get completed count from cache
    const completedCount = completedAuditsCache.get(normalizedEmail) || 0;
    
    return {
        assigned: assignedCount,
        completed: completedCount
    };
}

// ============================================================================
// Date Filter Functions
// ============================================================================
function initializeDateFilter() {
    const today = getDhakaNow();
    const firstDay = getDhakaFirstDayOfMonth(today);
    const lastDay = getDhakaLastDayOfMonth(today);
    const firstDayStr = formatDhakaDateForInput(firstDay);
    const lastDayStr = formatDhakaDateForInput(lastDay);
    
    // Set date filter to current month
    dateFilter.start = firstDayStr;
    dateFilter.end = lastDayStr;
    
    // Activate "This Month" button
    const quickDateButtons = document.querySelectorAll('.quick-date-btn');
    quickDateButtons.forEach(btn => btn.classList.remove('active'));
    const thisMonthBtn = document.getElementById('thisMonthBtn');
    if (thisMonthBtn) {
        thisMonthBtn.classList.add('active');
    }
}

// Use shared date filter utility - wrap to provide page-specific callbacks
const originalApplyQuickDateFilter = window.applyQuickDateFilter;
window.applyQuickDateFilter = function(period) {
    originalApplyQuickDateFilter(period, {
        dateFilter: dateFilter,
        onRefresh: () => {
            // Reload completed audits cache with new date filter
            loadCompletedAuditsCache().then(() => {
                // Refresh the summary and employee list
                loadAgentWiseSummary();
                applyFiltersAndGroup();
            });
        }
    });
};

// ============================================================================
// Load Completed Audits Cache
// ============================================================================
async function loadCompletedAuditsCache() {
    try {
        completedAuditsCache.clear();
        
        // Get date filter period (convert date strings to Date objects)
        let period = null;
        if (dateFilter.start || dateFilter.end) {
            period = {
                start: dateFilter.start ? getDhakaStartOfDay(parseDhakaDate(dateFilter.start)) : null,
                end: dateFilter.end ? getDhakaEndOfDay(parseDhakaDate(dateFilter.end)) : null
            };
        }
        
        // Get all audit tables
        let tablesToQuery = [];
        
        try {
            const { data: allTables, error: tablesError } = await window.supabaseClient.rpc('get_audit_tables');
            
            if (!tablesError && allTables && allTables.length > 0) {
                tablesToQuery = allTables.map(t => t.table_name);
            } else if (allScorecards && allScorecards.length > 0) {
                tablesToQuery = allScorecards.map(s => s.table_name).filter(Boolean);
            }
        } catch (rpcError) {
            console.warn('RPC call failed, using scorecard-based loading:', rpcError);
            if (allScorecards && allScorecards.length > 0) {
                tablesToQuery = allScorecards.map(s => s.table_name).filter(Boolean);
            }
        }
        
        // Query each table for completed audits with date filtering
        for (const tableName of tablesToQuery) {
            try {
                // Select submitted_at for date filtering
                let query = window.supabaseClient
                    .from(tableName)
                    .select('employee_email, audit_status, submitted_at')
                    .not('submitted_at', 'is', null); // Only audits with submitted_at
                
                // Apply date filters server-side if possible (convert Dhaka to UTC)
                if (period && period.start) {
                    query = query.gte('submitted_at', dhakaDateToUTCISO(period.start));
                }
                if (period && period.end) {
                    query = query.lte('submitted_at', dhakaDateToUTCISO(period.end));
                }
                
                const { data, error } = await query;
                
                if (error) {
                    // Some tables may not have audit_status column, try without it
                    let retryQuery = window.supabaseClient
                        .from(tableName)
                        .select('employee_email, submitted_at')
                        .not('submitted_at', 'is', null);
                    
                    // Apply date filters server-side if possible
                    if (period && period.start) {
                        retryQuery = retryQuery.gte('submitted_at', dhakaDateToUTCISO(period.start));
                    }
                    if (period && period.end) {
                        retryQuery = retryQuery.lte('submitted_at', dhakaDateToUTCISO(period.end));
                    }
                    
                    const retryResult = await retryQuery;
                    if (retryResult.error) {
                        console.warn(`Error loading from ${tableName}:`, retryResult.error);
                        continue;
                    }
                    
                    // If no audit_status column, assume all are completed (legacy audits)
                    // But still filter by date
                    if (retryResult.data) {
                        let filteredData = retryResult.data;
                        
                        // Fallback client-side date filtering if server-side filter failed
                        if (period && period.start) {
                            filteredData = filteredData.filter(audit => {
                                if (!audit.submitted_at) return false;
                                const auditDate = toDhakaTime(audit.submitted_at);
                                return (!period.start || auditDate >= period.start) && 
                                       (!period.end || auditDate <= period.end);
                            });
                        }
                        
                        filteredData.forEach(audit => {
                            if (audit.employee_email) {
                                const email = (audit.employee_email || '').toLowerCase().trim();
                                completedAuditsCache.set(email, (completedAuditsCache.get(email) || 0) + 1);
                            }
                        });
                    }
                } else if (data) {
                    // Filter for completed audits and apply date filter
                    let filteredData = data;
                    
                    // Fallback client-side date filtering if server-side filter failed
                    if (period && period.start) {
                        filteredData = filteredData.filter(audit => {
                            if (!audit.submitted_at) return false;
                            const auditDate = toDhakaTime(audit.submitted_at);
                            return (!period.start || auditDate >= period.start) && 
                                   (!period.end || auditDate <= period.end);
                        });
                    }
                    
                    filteredData.forEach(audit => {
                        const auditStatus = audit.audit_status;
                        // Only include completed audits or audits without audit_status (legacy completed audits)
                        // Matching expert-audits.html logic exactly
                        const isComplete = !auditStatus || auditStatus === 'completed';
                        if (isComplete && audit.employee_email) {
                            const email = (audit.employee_email || '').toLowerCase().trim();
                            completedAuditsCache.set(email, (completedAuditsCache.get(email) || 0) + 1);
                        }
                    });
                }
            } catch (err) {
                console.warn(`Exception loading from ${tableName}:`, err);
                continue;
            }
        }
    } catch (error) {
        console.error('Error loading completed audits cache:', error);
    }
}

// ============================================================================
// Filter & Group Employees
// ============================================================================
function applyFiltersAndGroup() {
    const channelFilter = document.getElementById('channelFilter').value;
    const teamFilter = document.getElementById('teamFilter').value;
    const departmentFilter = document.getElementById('departmentFilter').value;
    const countryFilter = document.getElementById('countryFilter').value;
    const qsFilter = document.getElementById('qualitySupervisorFilter').value;
    const tsFilter = document.getElementById('teamSupervisorFilter').value;
    const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
    const groupBy = document.getElementById('groupBySelect').value;
    
    // Save expanded groups state before re-rendering
    const expandedGroups = new Set();
    if (groupBy !== 'none') {
        document.querySelectorAll('.group-content.expanded').forEach(content => {
            const groupId = content.id.replace('content-', '');
            if (groupId) {
                expandedGroups.add(groupId);
            }
        });
    }
    
    // Apply filters
    filteredEmployees = allEmployees.filter(emp => {
        const matchesChannel = !channelFilter || emp.channel === channelFilter;
        const matchesTeam = !teamFilter || emp.team === teamFilter;
        const matchesDepartment = !departmentFilter || emp.department === departmentFilter;
        const matchesCountry = !countryFilter || emp.country === countryFilter;
        const matchesQS = !qsFilter || emp.quality_mentor === qsFilter;
        const matchesTS = !tsFilter || emp.team_supervisor === tsFilter;
        const matchesSearch = !searchTerm || 
            (emp.name && emp.name.toLowerCase().includes(searchTerm)) ||
            (emp.email && emp.email.toLowerCase().includes(searchTerm));
        
        return matchesChannel && matchesTeam && matchesDepartment && matchesCountry && matchesQS && matchesTS && matchesSearch;
    });
    
    // Reset to page 1 when filters change
    currentPage = 1;
    
    // Initialize error state for audit count input if value is 0
    const auditCountInputRight = document.getElementById('bulkAuditCountRight');
    if (auditCountInputRight && bulkAuditCount === 0) {
        auditCountInputRight.classList.add('error');
    }
    
    // Update right panel visibility
    updateRightPanel();
    
    // Render employees
    if (groupBy === 'none') {
        renderFlatList(filteredEmployees);
    } else {
        renderGroups(groupEmployees(filteredEmployees, groupBy), groupBy, expandedGroups);
    }
    
    updateAssignButton();
}

function groupEmployees(employees, groupBy) {
    if (groupBy === 'none') return new Map();
    
    const groups = new Map();
    employees.forEach(emp => {
        let groupKey = emp[groupBy] || 'Unassigned';
        
        // Get supervisor name if grouping by supervisor
        if ((groupBy === 'quality_mentor' || groupBy === 'team_supervisor') && groupKey !== 'Unassigned') {
            const supervisor = allUsers.find(u => u.email === groupKey);
            if (supervisor) groupKey = supervisor.name;
        }
        
        if (!groups.has(groupKey)) groups.set(groupKey, []);
        groups.get(groupKey).push(emp);
    });
    
    return groups;
}

function renderFlatList(employees) {
    const container = document.getElementById('groupedEmployeesContainer');
    const emptyState = document.getElementById('emptyState');
    
    if (employees.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        hidePagination();
        return;
    }
    
    emptyState.style.display = 'none';
    container.innerHTML = '';
    
    // Sort employees by assigned audit count (ascending) - fewer audits first
    const sortedEmployees = [...employees].sort((a, b) => {
        const statsA = getEmployeeAuditStats(a.email);
        const statsB = getEmployeeAuditStats(b.email);
        // Sort by assigned count ascending, then by name
        if (statsA.assigned !== statsB.assigned) {
            return statsA.assigned - statsB.assigned;
        }
        return (a.name || '').localeCompare(b.name || '');
    });
    
    // Calculate pagination
    const totalItems = sortedEmployees.length;
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    
    // Ensure currentPage is valid
    if (currentPage > totalPages && totalPages > 0) {
        currentPage = totalPages;
    }
    if (currentPage < 1) {
        currentPage = 1;
    }
    
    // Get items for current page
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginatedEmployees = sortedEmployees.slice(startIndex, endIndex);
    
    // Create a simple container for flat list - ensure vertical layout
    const flatListContainer = document.createElement('div');
    flatListContainer.style.cssText = 'display: flex; flex-direction: column; width: 100%; gap: 0;';
    
    // Render each employee as a flat list item
    paginatedEmployees.forEach(emp => {
        const employeeElement = createEmployeeElement(emp);
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = employeeElement;
        const employeeNode = tempDiv.firstElementChild;
        flatListContainer.appendChild(employeeNode);
    });
    
    container.appendChild(flatListContainer);
    
    // Update pagination controls
    updatePagination(totalItems, totalPages);
}

function renderGroups(groups, groupBy, expandedGroups = new Set()) {
    const container = document.getElementById('groupedEmployeesContainer');
    const emptyState = document.getElementById('emptyState');
    
    if (groups.size === 0 || filteredEmployees.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        hidePagination();
        return;
    }

    emptyState.style.display = 'none';
    container.innerHTML = '';
    
    // Sort groups by key
    const sortedGroups = Array.from(groups.entries()).sort((a, b) => 
        a[0].localeCompare(b[0])
    );
    
    // Flatten all employees from all groups for pagination
    const allGroupedEmployees = [];
    sortedGroups.forEach(([groupName, employees]) => {
        // Sort employees within each group by assigned audit count (ascending)
        const sortedEmployees = [...employees].sort((a, b) => {
            const statsA = getEmployeeAuditStats(a.email);
            const statsB = getEmployeeAuditStats(b.email);
            // Sort by assigned count ascending, then by name
            if (statsA.assigned !== statsB.assigned) {
                return statsA.assigned - statsB.assigned;
            }
            return (a.name || '').localeCompare(b.name || '');
        });
        allGroupedEmployees.push(...sortedEmployees.map(emp => ({ emp, groupName })));
    });
    
    // Calculate pagination
    const totalItems = allGroupedEmployees.length;
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    
    // Ensure currentPage is valid
    if (currentPage > totalPages && totalPages > 0) {
        currentPage = totalPages;
    }
    if (currentPage < 1) {
        currentPage = 1;
    }
    
    // Get items for current page
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginatedItems = allGroupedEmployees.slice(startIndex, endIndex);
    
    // Group paginated items back by group name
    const paginatedGroups = new Map();
    paginatedItems.forEach(({ emp, groupName }) => {
        if (!paginatedGroups.has(groupName)) {
            paginatedGroups.set(groupName, []);
        }
        paginatedGroups.get(groupName).push(emp);
    });
    
    // Render paginated groups
    Array.from(paginatedGroups.entries()).forEach(([groupName, employees]) => {
        const groupDiv = createGroupElement(groupName, employees, groupBy);
        container.appendChild(groupDiv);
        
        // Restore expanded state if this group was previously expanded
        const groupId = `group-${groupName.replace(/[^a-zA-Z0-9]/g, '-')}`;
        if (expandedGroups.has(groupId)) {
            const content = document.getElementById(`content-${groupId}`);
            const expand = document.getElementById(`expand-${groupId}`);
            if (content && expand) {
                content.classList.add('expanded');
                expand.classList.add('expanded');
            }
        }
    });
    
    // Update pagination controls
    updatePagination(totalItems, totalPages);
}

function createGroupElement(groupName, employees, groupBy) {
    const groupDiv = document.createElement('div');
    groupDiv.className = 'group-container';
    
    const groupId = `group-${groupName.replace(/[^a-zA-Z0-9]/g, '-')}`;
    const allSelected = employees.every(emp => selectedEmployees.has(emp.email));
    
    groupDiv.innerHTML = `
        <div class="group-header" onclick="toggleGroup('${groupId}')">
            <div class="group-header-left">
                <input type="checkbox" class="group-checkbox" 
                       ${allSelected ? 'checked' : ''}
                       onclick="event.stopPropagation(); toggleGroupSelection('${groupId}', this.checked)"
                       id="checkbox-${groupId}">
                <h3 class="group-title">${escapeHtml(groupName)}</h3>
                <span class="group-count">${employees.length}</span>
                </div>
            <svg class="group-expand" id="expand-${groupId}" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
            </svg>
            </div>
        <div class="group-content" id="content-${groupId}">
            ${employees.map(emp => createEmployeeElement(emp)).join('')}
                </div>
    `;
    
    return groupDiv;
}

function createEmployeeElement(employee) {
    const initials = employee.name ? employee.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
    const isSelected = selectedEmployees.has(employee.email);
    const auditStats = getEmployeeAuditStats(employee.email);
    
    return `
        <div class="employee-item" onclick="handleEmployeeRowClick(event, '${employee.email}')">
            <div class="employee-info">
                <input type="checkbox" class="employee-checkbox" 
                       data-email="${employee.email}"
                       ${isSelected ? 'checked' : ''}
                       onchange="toggleEmployeeSelection('${employee.email}', this.checked)"
                       onclick="event.stopPropagation()">
                <div class="employee-avatar">${initials}</div>
                <div class="employee-details">
                    <p class="employee-name">${escapeHtml(employee.name || 'Unknown')}</p>
                    <p class="employee-meta">
                        ${employee.channel || '-'} â€¢ ${employee.team || '-'} â€¢ ${employee.designation || '-'}
                    </p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5625rem; flex-shrink: 0;">
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.0938rem;">
                    <div style="display: flex; align-items: center; gap: 0.1875rem;">
                        <span style="font-size: 0.5156rem; color: #6b7280;">Assigned:</span>
                        <span style="font-size: 0.5625rem; font-weight: 600; color: #1A733E;">${auditStats.assigned}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.1875rem;">
                        <span style="font-size: 0.5156rem; color: #6b7280;">Completed:</span>
                        <span style="font-size: 0.5625rem; font-weight: 600; color: #065f46;">${auditStats.completed}</span>
                    </div>
                </div>
            </div>
        </div>
        `;
}

// ============================================================================
// Selection & Interaction
// ============================================================================
function toggleGroup(groupId) {
    const content = document.getElementById(`content-${groupId}`);
    const expand = document.getElementById(`expand-${groupId}`);
    
    content.classList.toggle('expanded');
    expand.classList.toggle('expanded');
}

function toggleGroupSelection(groupId, checked) {
    const content = document.getElementById(`content-${groupId}`);
    const checkboxes = content.querySelectorAll('.employee-checkbox');
    
    checkboxes.forEach(checkbox => {
        const email = checkbox.dataset.email;
        toggleEmployeeSelection(email, checked);
        checkbox.checked = checked;
    });
}

function handleEmployeeRowClick(event, email) {
    // Don't toggle if clicking on checkbox (it handles its own clicks)
    if (event.target.type === 'checkbox') {
        return;
    }
    
    // Toggle selection
    const checkbox = document.querySelector(`input.employee-checkbox[data-email="${email}"]`);
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        toggleEmployeeSelection(email, checkbox.checked);
    }
}

function toggleEmployeeSelection(email, selected) {
    const employee = filteredEmployees.find(e => e.email === email);
    if (!employee) return;
    
    if (selected) {
        if (!selectedEmployees.has(email)) {
            // Use bulkAuditCount if > 0, otherwise default to 1
            const auditCount = bulkAuditCount > 0 ? bulkAuditCount : 1;
            selectedEmployees.set(email, { employee, auditCount });
        }
    } else {
        selectedEmployees.delete(email);
    }
    
    // Update checkbox state
    const checkbox = document.querySelector(`input.employee-checkbox[data-email="${email}"]`);
    if (checkbox) {
        checkbox.checked = selected;
    }
    
    // Update input and button states
    const input = document.querySelector(`input.audit-count-input[data-email="${email}"]`);
    const buttons = document.querySelectorAll(`button.counter-btn[data-email="${email}"]`);
    if (input) {
        input.disabled = !selected;
        if (selected && selectedEmployees.has(email)) {
            input.value = selectedEmployees.get(email).auditCount;
        }
    }
    buttons.forEach(btn => btn.disabled = !selected);
    
    // Update auditors list to refresh audit count badges (no need to re-render full list for selection change)
    populateQADropdown();
    updateAssignButton();
    updateTotalAuditsDisplay(); // Update total audits display
}

function updateAuditCount(email, count) {
    if (selectedEmployees.has(email)) {
        const data = selectedEmployees.get(email);
        data.auditCount = Math.max(1, Math.min(10, count));
        
        const input = document.querySelector(`input.audit-count-input[data-email="${email}"]`);
        if (input) input.value = data.auditCount;
        
        updateAssignButton();
    }
}

function updateAssignButton() {
    const assignButtonRight = document.getElementById('assignButtonRight');
    
    const hasQASelection = selectedQualityAnalysts.size > 0;
        const hasValidAuditCount = bulkAuditCount > 0;
    const isDisabled = !hasQASelection || !hasValidAuditCount || selectedEmployees.size === 0;
    
    if (assignButtonRight) {
        assignButtonRight.disabled = isDisabled;
    }
    
    // Show/hide right panel based on selection
    updateRightPanel();
}

// ============================================================================
// Update Total Audits Display
// ============================================================================
function updateTotalAuditsDisplay() {
    const totalAuditsElement = document.getElementById('totalAuditsCount');
    if (!totalAuditsElement) return;
    
    // Calculate total: audits per employee Ã— number of selected employees
    const selectedCount = selectedEmployees.size;
    const totalAudits = bulkAuditCount * selectedCount;
    
    totalAuditsElement.textContent = totalAudits.toLocaleString();
    
    // Update the display container visibility/style
    const displayContainer = document.getElementById('totalAuditsDisplay');
    if (displayContainer) {
        if (selectedCount > 0 && bulkAuditCount > 0) {
            displayContainer.style.display = 'block';
        } else {
            displayContainer.style.display = 'block'; // Always show, even if 0
        }
    }
}

function updateRightPanel() {
    const rightPanelContent = document.getElementById('rightPanelContent');
    const rightPanelEmpty = document.getElementById('rightPanelEmpty');
    
    if (selectedEmployees.size > 0) {
        if (rightPanelContent) rightPanelContent.style.display = 'block';
        if (rightPanelEmpty) rightPanelEmpty.style.display = 'none';
        // Update total audits when panel is shown
        updateTotalAuditsDisplay();
    } else {
        if (rightPanelContent) rightPanelContent.style.display = 'none';
        if (rightPanelEmpty) rightPanelEmpty.style.display = 'flex';
    }
}

function toggleQASelection(qaEmail, selected) {
    // Prevent selection if audit count is not set
    if (selected && bulkAuditCount <= 0) {
        alert('Please set "Audits per employee" before selecting auditors.');
        return;
    }
    
    if (selected) {
        selectedQualityAnalysts.add(qaEmail);
    } else {
        selectedQualityAnalysts.delete(qaEmail);
    }
    
    // Re-render to update audit count badges
    populateQADropdown();
    updateAssignButton();
}

function selectAllQAs() {
    // Prevent selection if audit count is not set
    if (bulkAuditCount <= 0) {
        alert('Please set "Audits per employee" before selecting auditors.');
        return;
    }
    
    selectedQualityAnalysts.clear();
    qualityAnalysts.forEach(qa => {
        selectedQualityAnalysts.add(qa.email);
    });
    renderAuditorsList();
    updateAssignButton();
}

function deselectAllQAs() {
    selectedQualityAnalysts.clear();
    renderAuditorsList();
    updateAssignButton();
}

// QA selection is handled by checkbox change events in populateQADropdown


// ============================================================================
// Quick Actions
// ============================================================================
function selectAllVisible() {
    // Get currently visible employees (on current page)
    const visibleCheckboxes = document.querySelectorAll('.employee-checkbox:not(:checked)');
    visibleCheckboxes.forEach(checkbox => {
        const email = checkbox.dataset.email;
        const employee = filteredEmployees.find(e => e.email === email);
        if (employee && !selectedEmployees.has(email)) {
            // Use bulkAuditCount if > 0, otherwise default to 1
            const auditCount = bulkAuditCount > 0 ? bulkAuditCount : 1;
            selectedEmployees.set(email, { employee, auditCount });
            checkbox.checked = true;
        }
    });
    // Update auditors list to refresh audit count badges
    populateQADropdown();
    updateAssignButton();
    updateTotalAuditsDisplay(); // Update total audits display
}

function deselectAll() {
    selectedEmployees.clear();
    applyFiltersAndGroup();
    // Update auditors list to refresh audit count badges
    populateQADropdown();
    updateTotalAuditsDisplay(); // Update total audits display
}

function updateBulkAuditCount(count) {
    if (count === undefined || count === null || isNaN(count)) {
        count = 0;
    }
    
    bulkAuditCount = Math.max(0, Math.min(10, count));
    
    // Update the input field in the right panel
    const inputRight = document.getElementById('bulkAuditCountRight');
    
    if (inputRight) {
        inputRight.value = bulkAuditCount;
        if (bulkAuditCount === 0) {
            inputRight.classList.add('error');
            // Clear all auditor selections if count is set to 0
            selectedQualityAnalysts.clear();
        } else {
            inputRight.classList.remove('error');
        }
    }
    
    // Update all selected employees with the new count
    selectedEmployees.forEach((data) => {
        data.auditCount = bulkAuditCount;
    });
    
    // Re-render auditors list to update disabled state and audit count badges
    populateQADropdown();
    updateAssignButton();
    updateTotalAuditsDisplay(); // Update total audits display
    applyFiltersAndGroup();
}

// ============================================================================
// Auto-Assign by Supervisor
// ============================================================================
async function autoAssignBySupervisor() {
    // Automatically switch to quality_mentor grouping if not already
    const groupBySelect = document.getElementById('groupBySelect');
    if (groupBySelect.value !== 'quality_mentor') {
        groupBySelect.value = 'quality_mentor';
        applyFiltersAndGroup();
    }
    
    // Prompt for audit count with default of 4
    const auditCountInput = prompt('How many audits per employee?', '4');
    if (auditCountInput === null) return; // User cancelled
    
    const auditCount = parseInt(auditCountInput);
    if (isNaN(auditCount) || auditCount < 1 || auditCount > 10) {
        await window.confirmationDialog.show({
            title: 'Invalid Number',
            message: 'Please enter a valid number between 1 and 10.',
            confirmText: 'OK',
            type: 'warning'
        });
        return;
    }
    
    // Group employees by their quality supervisor
    const supervisorGroups = new Map();
    let totalEmployees = 0;
    let totalAudits = 0;
    let employeesWithoutSupervisor = 0;
    let employeesWithoutScorecard = 0;
    
    // Use ALL employees, not just filtered ones
    allEmployees.forEach(emp => {
        if (!emp.quality_mentor) {
            employeesWithoutSupervisor++;
            return;
        }
        
        // Add ALL employees with quality mentor (scorecard not required)
            if (!supervisorGroups.has(emp.quality_mentor)) {
                supervisorGroups.set(emp.quality_mentor, []);
            }
            supervisorGroups.get(emp.quality_mentor).push(emp);
            totalEmployees++;
            totalAudits += auditCount;
    });
    
    if (supervisorGroups.size === 0) {
        await window.confirmationDialog.show({
            title: 'No Valid Assignments',
            message: 'No employees with assigned Quality Mentors found.',
            confirmText: 'OK',
            type: 'warning'
        });
            return;
        }
        
    // Calculate total assignments
    const totalAssignments = totalEmployees * auditCount;
    
    // Build confirmation message
    let message = `This will automatically create:\n\n`;
    message += `â€¢ ${totalAssignments} audit assignment${totalAssignments !== 1 ? 's' : ''}\n`;
    message += `â€¢ For ${totalEmployees} employee${totalEmployees !== 1 ? 's' : ''}\n`;
    message += `â€¢ ${auditCount} audits per employee\n`;
    message += `â€¢ Assigned to ${supervisorGroups.size} Quality Mentor${supervisorGroups.size !== 1 ? 's' : ''}\n`;
    
    if (employeesWithoutSupervisor > 0) {
        message += `\nWarning: ${employeesWithoutSupervisor} employee${employeesWithoutSupervisor !== 1 ? 's' : ''} without Quality Mentor will be skipped\n`;
    }
    
    message += `\nNote: Auditors will select scorecards when performing audits.\n`;
    message += `\nContinue?`;
    
    const confirmed = await window.confirmationDialog.show({
        title: 'Auto Assign',
        message: message,
        confirmText: 'Assign Audits',
        cancelText: 'Cancel',
        type: 'info'
    });
    
    if (!confirmed) return;
    
    try {
        const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
        const assignedBy = userInfo.email || 'unknown';
        const currentWeek = getWeekNumber();
        
        // Create audit assignments in audit_assignments table
        const assignmentsToCreate = [];
        
        supervisorGroups.forEach((employees, supervisorEmail) => {
            employees.forEach(emp => {
                // Get first applicable scorecard if available, otherwise null
                const applicableScorecards = getApplicableScorecardsForEmployee(emp);
                const scorecardId = applicableScorecards.length > 0 ? applicableScorecards[0].id : null;
                
                // Create exactly auditCount assignments per employee
                for (let i = 0; i < auditCount; i++) {
                    assignmentsToCreate.push({
                            employee_email: emp.email,
                            employee_name: emp.name,
                            auditor_email: supervisorEmail,
                        scorecard_id: scorecardId,
                        week: currentWeek,
                            status: 'pending',
                        assigned_by: assignedBy
                    });
                }
            });
        });
        
        // Insert assignments into audit_assignments table
        const { data: createdAssignments, error: insertError } = await window.supabaseClient
            .from('audit_assignments')
            .insert(assignmentsToCreate)
            .select();
        
        if (insertError) throw insertError;
        
        const totalCreated = createdAssignments ? createdAssignments.length : 0;
        
        await window.confirmationDialog.show({
            title: 'Success!',
            message: `Successfully created ${totalCreated} audit assignment${totalCreated !== 1 ? 's' : ''} across ${supervisorGroups.size} Quality Mentor${supervisorGroups.size !== 1 ? 's' : ''}!`,
            confirmText: 'OK',
            type: 'success'
        });
        
        // Refresh assigned audits view first to update allAssignments
        await loadAssignedAudits();
        
        // Clear selections if any and refresh employee list to show updated stats
        selectedEmployees.clear();
        applyFiltersAndGroup();
        
        await loadAgentWiseSummary();
        
    } catch (error) {
        console.error('Error auto-assigning audits:', error);
        await window.confirmationDialog.show({
            title: 'Assignment Failed',
            message: 'Error assigning audits: ' + error.message,
            confirmText: 'OK',
            type: 'error'
        });
    }
}

// ============================================================================
// Bulk Assignment
// ============================================================================
async function performBulkAssignment() {
    // Validate inputs
    if (bulkAuditCount <= 0 || bulkAuditCount > 10) {
        const input = document.getElementById('bulkAuditCount');
        if (input) input.classList.add('error');
        await window.confirmationDialog.show({
            title: 'Audit Count Required',
            message: 'Please enter the number of audits per employee (1-10). This field is mandatory.',
            confirmText: 'OK',
            type: 'warning'
        });
        return;
    }
    
    if (selectedQualityAnalysts.size === 0) {
        await window.confirmationDialog.show({
            title: 'No Quality Analyst Selected',
            message: 'Please select at least one Quality Analyst. Audits will be distributed evenly among the selected auditors.',
            confirmText: 'OK',
            type: 'warning'
        });
        return;
    }
    
    if (selectedEmployees.size === 0) {
        await window.confirmationDialog.show({
            title: 'No Employees Selected',
            message: 'Please select at least one employee to assign audits.',
            confirmText: 'OK',
            type: 'warning'
        });
        return;
    }
        
    // Calculate total assignments
    let totalAssignments = 0;
    selectedEmployees.forEach((data) => {
        totalAssignments += data.auditCount;
    });
    
    // Build confirmation message - audits will be distributed evenly among selected auditors
        const selectedQANames = Array.from(selectedQualityAnalysts)
            .map(email => qualityAnalysts.find(qa => qa.email === email)?.name || email)
            .join(', ');
    const confirmMessage = `This will create ${totalAssignments} audit assignment${totalAssignments !== 1 ? 's' : ''} for ${selectedEmployees.size} employee${selectedEmployees.size !== 1 ? 's' : ''} and distribute them evenly among ${selectedQualityAnalysts.size} selected Quality Analyst${selectedQualityAnalysts.size !== 1 ? 's' : ''}:\n\n${selectedQANames}\n\nNote: Auditors will select scorecards when performing audits.\n\nContinue?`;
    
    const confirmed = await window.confirmationDialog.show({
        title: 'Confirm Audit Assignment',
        message: confirmMessage,
        confirmText: 'Assign Audits',
        cancelText: 'Cancel',
        type: 'info'
    });
    
    if (!confirmed) return;
    
    // Disable button during processing
    const assignButton = document.getElementById('assignButtonRight');
    if (assignButton) {
        assignButton.disabled = true;
        assignButton.textContent = 'Assigning...';
    }
    
    try {
        await distributeToSelectedQAs();
        
        await window.confirmationDialog.show({
            title: 'Success!',
            message: `Successfully created audit assignments! Check the overview section above.`,
            confirmText: 'OK',
            type: 'success'
        });
        
        // Refresh assigned audits view first to update allAssignments
        await loadAssignedAudits();
        
        // Clear selections and refresh employee list to show updated stats
        selectedEmployees.clear();
        applyFiltersAndGroup();
        
        await loadAgentWiseSummary();
        
    } catch (error) {
        console.error('Error assigning audits:', error);
        await window.confirmationDialog.show({
            title: 'Assignment Failed',
            message: 'Error assigning audits: ' + error.message,
            confirmText: 'OK',
            type: 'error'
        });
    } finally {
        const assignButtonRight = document.getElementById('assignButtonRight');
        if (assignButtonRight) {
            assignButtonRight.disabled = false;
            assignButtonRight.textContent = 'Assign Audits';
        }
    }
}

async function distributeToSelectedQAs() {
    // Convert Set to Array for easier indexing - distribute evenly among selected auditors
    const selectedQAsArray = Array.from(selectedQualityAnalysts)
            .map(email => qualityAnalysts.find(qa => qa.email === email))
            .filter(qa => qa !== undefined);
    
    if (selectedQualityAnalysts.size === 0) {
        throw new Error('No Quality Analysts selected');
    }
    
    if (selectedQAsArray.length === 0) {
        throw new Error('No valid Quality Analysts found');
    }
    
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
    const assignedBy = userInfo.email || 'unknown';
    const currentWeek = getWeekNumber();
    
    // Collect all audits first, then distribute evenly across all auditors
    const allAudits = [];
    selectedEmployees.forEach((data, employeeEmail) => {
        // Get first applicable scorecard if available, otherwise null
        const applicableScorecards = getApplicableScorecardsForEmployee(data.employee);
        const scorecardId = applicableScorecards.length > 0 ? applicableScorecards[0].id : null;
        
        // Create all audits for this employee
        for (let i = 0; i < data.auditCount; i++) {
            allAudits.push({
                employee_email: employeeEmail,
                employee_name: data.employee.name,
                scorecard_id: scorecardId
            });
        }
    });
    
    // Distribute all audits evenly among selected auditors using round-robin
    const numAuditors = selectedQAsArray.length;
    
    // Create assignments in audit_assignments table
    const assignmentsToCreate = [];
    allAudits.forEach((audit, index) => {
        const auditorIdx = index % numAuditors; // Round-robin: cycles through auditors
        
        assignmentsToCreate.push({
            employee_email: audit.employee_email,
            employee_name: audit.employee_name,
            auditor_email: selectedQAsArray[auditorIdx].email,
            scorecard_id: audit.scorecard_id,
            week: currentWeek,
            status: 'pending',
            assigned_by: assignedBy
        });
    });
    
    // Insert assignments into audit_assignments table
    const { data: createdAssignments, error: insertError } = await window.supabaseClient
        .from('audit_assignments')
        .insert(assignmentsToCreate)
        .select();
    
    if (insertError) throw insertError;
    
    const totalCreated = createdAssignments ? createdAssignments.length : 0;
}

// ============================================================================
// Bulk Assignment Operations
// ============================================================================
function populateBulkEditDropdowns() {
    const auditorSelect = document.getElementById('bulkEditAuditor');
    const scorecardSelect = document.getElementById('bulkEditScorecard');
    
    // Populate auditor dropdown
    auditorSelect.innerHTML = '<option value="">Change Auditor...</option>';
    qualityAnalysts.forEach(qa => {
        const option = document.createElement('option');
        option.value = qa.email;
        option.textContent = qa.name;
        auditorSelect.appendChild(option);
    });
    
    // Populate scorecard dropdown
    scorecardSelect.innerHTML = '<option value="">Change Scorecard...</option>';
    allScorecards.forEach(sc => {
        const option = document.createElement('option');
        option.value = sc.id;
        option.textContent = sc.name;
        scorecardSelect.appendChild(option);
    });
}

function toggleAllAssignments(checked) {
    const checkboxes = document.querySelectorAll('.assignment-checkbox');
    checkboxes.forEach(cb => cb.checked = checked);
    toggleAssignmentSelection();
}

function toggleAssignmentSelection() {
    const checkboxes = document.querySelectorAll('.assignment-checkbox:checked');
    const bulkActions = document.getElementById('bulkAssignmentActions');
    const countSpan = document.getElementById('bulkAssignmentCount');
    
    if (checkboxes.length > 0) {
        bulkActions.style.display = 'flex';
        countSpan.textContent = `${checkboxes.length} selected`;
    } else {
        bulkActions.style.display = 'none';
    }
    
    // Update select all checkbox state
    const selectAllCheckbox = document.getElementById('selectAllAssignments');
    const allCheckboxes = document.querySelectorAll('.assignment-checkbox');
    selectAllCheckbox.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
}

async function applyBulkEdit() {
    const selectedCheckboxes = document.querySelectorAll('.assignment-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        await window.confirmationDialog.show({
            title: 'No Assignments Selected',
            message: 'Please select at least one assignment to edit.',
            confirmText: 'OK',
            type: 'warning'
        });
        return;
    }
    
    const newWeekInput = document.getElementById('bulkEditWeek').value;
    const newAuditor = document.getElementById('bulkEditAuditor').value;
    const newScorecard = document.getElementById('bulkEditScorecard').value;
    
    if (!newWeekInput && !newAuditor && !newScorecard) {
        await window.confirmationDialog.show({
            title: 'No Changes Selected',
            message: 'Please enter a week number or select an auditor/scorecard to change.',
            confirmText: 'OK',
            type: 'warning'
        });
        return;
    }
    
    // Validate week number if provided
    if (newWeekInput) {
        const newWeek = parseInt(newWeekInput);
        if (isNaN(newWeek) || newWeek < 1 || newWeek > 52) {
            await window.confirmationDialog.show({
                title: 'Invalid Week',
                message: 'Week number must be between 1 and 52.',
                confirmText: 'OK',
                type: 'warning'
            });
            return;
        }
    }
    
    const assignmentIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.assignmentId);
    
    const confirmed = await window.confirmationDialog.show({
        title: 'Confirm Bulk Edit',
        message: `Are you sure you want to update ${assignmentIds.length} assignment${assignmentIds.length !== 1 ? 's' : ''}?`,
        confirmText: 'Update',
        cancelText: 'Cancel',
        type: 'info'
    });
    
    if (!confirmed) return;
    
    try {
        const updates = {};
        if (newWeekInput) updates.week = parseInt(newWeekInput);
        if (newAuditor) updates.auditor_email = newAuditor;
        if (newScorecard) updates.scorecard_id = newScorecard;
        
        const { error } = await window.supabaseClient
            .from('audit_assignments')
            .update(updates)
            .in('id', assignmentIds);
        
        if (error) throw error;
        
        await window.confirmationDialog.show({
            title: 'Success!',
            message: `Successfully updated ${assignmentIds.length} assignment${assignmentIds.length !== 1 ? 's' : ''}.`,
            confirmText: 'OK',
            type: 'success'
        });
        
        // Reset selections and reload
        document.getElementById('bulkEditWeek').value = '';
        document.getElementById('bulkEditAuditor').value = '';
        document.getElementById('bulkEditScorecard').value = '';
        await loadAssignedAudits();
        applyFiltersAndGroup(); // Refresh employee list to update audit counts
        await loadAgentWiseSummary();
        
    } catch (error) {
        console.error('Error bulk editing assignments:', error);
        await window.confirmationDialog.show({
            title: 'Error',
            message: 'Failed to update assignments: ' + error.message,
            confirmText: 'OK',
            type: 'error'
        });
    }
}

async function bulkDeleteAssignments() {
    const selectedCheckboxes = document.querySelectorAll('.assignment-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        await window.confirmationDialog.show({
            title: 'No Assignments Selected',
            message: 'Please select at least one assignment to delete.',
            confirmText: 'OK',
            type: 'warning'
        });
        return;
    }
    
    const assignmentIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.assignmentId);
    
    const confirmed = await window.confirmationDialog.show({
        title: 'Confirm Bulk Delete',
        message: `Are you sure you want to delete ${assignmentIds.length} assignment${assignmentIds.length !== 1 ? 's' : ''}?\n\nThis action cannot be undone.`,
        confirmText: 'Delete',
        cancelText: 'Cancel',
        type: 'warning'
    });
    
    if (!confirmed) return;
    
    try {
        const { error } = await window.supabaseClient
            .from('audit_assignments')
            .delete()
            .in('id', assignmentIds);
        
        if (error) throw error;
        
        await window.confirmationDialog.show({
            title: 'Success!',
            message: `Successfully deleted ${assignmentIds.length} assignment${assignmentIds.length !== 1 ? 's' : ''}.`,
            confirmText: 'OK',
            type: 'success'
        });
        
        // Reload assignments and refresh employee list
        await loadAssignedAudits();
        applyFiltersAndGroup(); // Refresh employee list to update audit counts
        await loadAgentWiseSummary();
        
    } catch (error) {
        console.error('Error bulk deleting assignments:', error);
        await window.confirmationDialog.show({
            title: 'Error',
            message: 'Failed to delete assignments: ' + error.message,
            confirmText: 'OK',
            type: 'error'
        });
    }
}

// ============================================================================
// Update Week Number
// ============================================================================
async function updateWeek(assignmentId, weekNumber) {
    try {
        const week = parseInt(weekNumber);
        if (isNaN(week) || week < 1 || week > 52) {
            await window.confirmationDialog.show({
                title: 'Invalid Week',
                message: 'Week number must be between 1 and 52.',
                confirmText: 'OK',
                type: 'warning'
            });
            await loadAssignedAudits();
            return;
        }
        
        const { error } = await window.supabaseClient
            .from('audit_assignments')
            .update({ week: week })
            .eq('id', assignmentId);
        
        if (error) throw error;
        
        // Refresh the table silently
        await loadAssignedAudits();
        await loadAgentWiseSummary();
        
    } catch (error) {
        console.error('Error updating week:', error);
        await window.confirmationDialog.show({
            title: 'Error',
            message: 'Failed to update week: ' + error.message,
            confirmText: 'OK',
            type: 'error'
        });
    }
}

// ============================================================================
// Column Filtering
// ============================================================================
let currentFilterDropdown = null;
let tempFilterSelections = {};

function toggleColumnFilter(column, event) {
    // Close any existing dropdown
    if (currentFilterDropdown) {
        currentFilterDropdown.remove();
        currentFilterDropdown = null;
    }
    
    // Get unique values for the column from allAssignments
    const uniqueValues = new Set();
    
    allAssignments.forEach(assignment => {
        let value;
        switch (column) {
            case 'week':
                value = assignment.week ? String(assignment.week) : '-';
                break;
            case 'employee':
                value = assignment.employee_name || assignment.employee_email;
                break;
            case 'channel':
                const user = allUsers.find(u => u.email === assignment.employee_email);
                value = user?.channel || '-';
                break;
            case 'auditor':
                const auditor = allUsers.find(u => u.email === assignment.auditor_email);
                value = auditor?.name || assignment.auditor_email;
                break;
            case 'scorecard':
                value = assignment.scorecard?.name || 'N/A';
                break;
            case 'status':
                value = assignment.status;
                break;
        }
        if (value) uniqueValues.add(value);
    });
    
    const values = Array.from(uniqueValues).sort();
    
    if (values.length === 0) {
        alert('No values available for filtering');
        return;
    }
    
    // Initialize temp selections with current filter
    tempFilterSelections[column] = [...(columnFilters[column] || [])];
    
    // Get the clicked header element
    const headerCell = event?.target?.closest('th');
    if (!headerCell) return;
    
    // Create dropdown
    const dropdown = document.createElement('div');
    dropdown.className = 'filter-dropdown active';
    
    // Add options
    const optionsHtml = values.map(value => {
        const isChecked = tempFilterSelections[column].includes(value);
        return `
            <label class="filter-option" onclick="event.stopPropagation()">
                <input type="checkbox" 
                       value="${escapeHtml(String(value))}" 
                       ${isChecked ? 'checked' : ''}
                       onchange="updateTempFilter('${column}', this.value, this.checked)"
                       onclick="event.stopPropagation()">
                <span>${escapeHtml(String(value))}</span>
            </label>
        `;
    }).join('');
    
    dropdown.innerHTML = `
        <div style="padding: 0.375rem; border-bottom: 0.0352rem solid #e5e7eb; margin-bottom: 0.375rem;" onclick="event.stopPropagation()">
            <strong style="font-size: 0.6094rem; color: #374151;">Filter ${column}</strong>
        </div>
        ${optionsHtml}
        <div class="filter-actions" onclick="event.stopPropagation()">
            <button class="filter-clear" onclick="event.stopPropagation(); clearSingleFilter('${column}')">Clear</button>
            <button class="filter-apply" onclick="event.stopPropagation(); applySingleFilter('${column}')">Apply</button>
        </div>
    `;
    
    // Stop propagation on dropdown clicks
    dropdown.addEventListener('click', (e) => {
        e.stopPropagation();
    });
    
    headerCell.appendChild(dropdown);
    currentFilterDropdown = dropdown;
    
    // Close dropdown when clicking outside
    setTimeout(() => {
        document.addEventListener('click', closeFilterOnClickOutside);
    }, 0);
}

function updateTempFilter(column, value, checked) {
    if (!tempFilterSelections[column]) {
        tempFilterSelections[column] = [];
    }
    
    if (checked) {
        if (!tempFilterSelections[column].includes(value)) {
            tempFilterSelections[column].push(value);
        }
    } else {
        tempFilterSelections[column] = tempFilterSelections[column].filter(v => v !== value);
    }
}

function applySingleFilter(column) {
    columnFilters[column] = tempFilterSelections[column] || [];
    applyColumnFilters();
    if (currentFilterDropdown) {
        currentFilterDropdown.remove();
        currentFilterDropdown = null;
    }
    document.removeEventListener('click', closeFilterOnClickOutside);
}

function clearSingleFilter(column) {
    columnFilters[column] = [];
    tempFilterSelections[column] = [];
    applyColumnFilters();
    if (currentFilterDropdown) {
        currentFilterDropdown.remove();
        currentFilterDropdown = null;
    }
    document.removeEventListener('click', closeFilterOnClickOutside);
}

function closeFilterOnClickOutside(e) {
    if (currentFilterDropdown && !currentFilterDropdown.contains(e.target) && !e.target.closest('th')) {
        currentFilterDropdown.remove();
        currentFilterDropdown = null;
        document.removeEventListener('click', closeFilterOnClickOutside);
    }
}

function applyColumnFilters() {
    const tbody = document.getElementById('assignedAuditsTableBody');
    const rows = tbody.querySelectorAll('tr');
    
    rows.forEach(row => {
        let shouldShow = true;
        
        // Check each active filter
        Object.keys(columnFilters).forEach(column => {
            if (columnFilters[column].length > 0) {
                const cellIndex = {
                    'week': 1,
                    'employee': 2,
                    'channel': 3,
                    'auditor': 4,
                    'scorecard': 5,
                    'status': 6
                }[column];
                
                const cell = row.cells[cellIndex];
                if (cell) {
                    const cellText = cell.textContent.trim();
                    if (!columnFilters[column].some(filter => cellText.includes(filter))) {
                        shouldShow = false;
                    }
                }
            }
        });
        
        row.style.display = shouldShow ? '' : 'none';
    });
    
    // Show/hide clear filters button
    updateClearFiltersButton();
}

function updateClearFiltersButton() {
    const clearBtn = document.getElementById('clearFiltersBtn');
    const hasActiveFilters = Object.values(columnFilters).some(filters => filters.length > 0);
    
    if (clearBtn) {
        clearBtn.style.display = hasActiveFilters ? 'flex' : 'none';
    }
}

function clearColumnFilters() {
    columnFilters = {
        week: [],
        employee: [],
        channel: [],
        auditor: [],
        scorecard: [],
        status: []
    };
    applyColumnFilters();
}

// ============================================================================
// Toggle Manual Assignment Section
// ============================================================================
function toggleManualSection() {
    const content = document.getElementById('manualSectionContent');
    const icon = document.getElementById('manualSectionIcon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
    } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
    }
}

// ============================================================================
// Utility Functions
// ============================================================================
function getWeekNumber(date = new Date()) {
    // Get the first day of the year
    const startOfYear = new Date(date.getFullYear(), 0, 1);
    
    // Calculate the Monday of week 1 (the Monday of the week containing Jan 1)
    // If Jan 1 is Sunday (getDay() === 0), Monday is 6 days before (previous Monday)
    // Otherwise, Monday is (getDay() - 1) days before Jan 1
    const dayOfWeek = startOfYear.getDay();
    const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    const mondayOfWeek1 = new Date(startOfYear);
    mondayOfWeek1.setDate(startOfYear.getDate() + daysToMonday);
    mondayOfWeek1.setHours(0, 0, 0, 0);
    
    // Calculate the Monday of the week containing the given date
    const dateDay = date.getDay();
    const dateDaysToMonday = dateDay === 0 ? -6 : 1 - dateDay;
    const mondayOfDateWeek = new Date(date);
    mondayOfDateWeek.setDate(date.getDate() + dateDaysToMonday);
    mondayOfDateWeek.setHours(0, 0, 0, 0);
    
    // Calculate the number of days from Monday of week 1 to Monday of date's week
    const daysSinceWeek1 = Math.floor((mondayOfDateWeek - mondayOfWeek1) / (24 * 60 * 60 * 1000));
    
    // Calculate the week number (starting from 1)
    const weekNumber = Math.floor(daysSinceWeek1 / 7) + 1;
    
    return weekNumber;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================================================
// Pagination Functions
// ============================================================================
function updatePagination(totalItems, totalPages) {
    if (totalPages <= 1) {
        hidePagination();
        return;
    }
    
    showPagination();
    
    // Calculate display range
    const startIndex = (currentPage - 1) * itemsPerPage + 1;
    const endIndex = Math.min(currentPage * itemsPerPage, totalItems);
    
    // Update pagination info
    const infoText = `Showing ${startIndex}-${endIndex} of ${totalItems}`;
    document.getElementById('paginationInfoTop').textContent = infoText;
    document.getElementById('paginationInfoBottom').textContent = infoText;
    
    // Update items per page selects
    document.getElementById('itemsPerPageSelect').value = itemsPerPage;
    document.getElementById('itemsPerPageSelectBottom').value = itemsPerPage;
    
    // Render pagination buttons
    renderPaginationButtons('paginationButtonsTop', totalPages);
    renderPaginationButtons('paginationButtonsBottom', totalPages);
}

function renderPaginationButtons(containerId, totalPages) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = '';
    
    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.className = 'pagination-btn';
    prevBtn.textContent = 'â€¹';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => goToPage(currentPage - 1);
    prevBtn.title = 'Previous page';
    container.appendChild(prevBtn);
    
    // Page number buttons
    const maxVisiblePages = 7;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // Adjust start if we're near the end
    if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // First page
    if (startPage > 1) {
        const firstBtn = document.createElement('button');
        firstBtn.className = 'pagination-btn';
        firstBtn.textContent = '1';
        firstBtn.onclick = () => goToPage(1);
        container.appendChild(firstBtn);
        
        if (startPage > 2) {
            const ellipsis = document.createElement('span');
            ellipsis.textContent = '...';
            ellipsis.style.cssText = 'padding: 0 0.375rem; color: #6b7280; font-size: 0.6094rem;';
            container.appendChild(ellipsis);
        }
    }
    
    // Page number buttons
    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = 'pagination-btn';
        if (i === currentPage) {
            pageBtn.classList.add('active');
        }
        pageBtn.textContent = i.toString();
        pageBtn.onclick = () => goToPage(i);
        container.appendChild(pageBtn);
    }
    
    // Last page
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            const ellipsis = document.createElement('span');
            ellipsis.textContent = '...';
            ellipsis.style.cssText = 'padding: 0 0.375rem; color: #6b7280; font-size: 0.6094rem;';
            container.appendChild(ellipsis);
        }
        
        const lastBtn = document.createElement('button');
        lastBtn.className = 'pagination-btn';
        lastBtn.textContent = totalPages.toString();
        lastBtn.onclick = () => goToPage(totalPages);
        container.appendChild(lastBtn);
    }
    
    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.className = 'pagination-btn';
    nextBtn.textContent = 'â€º';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => goToPage(currentPage + 1);
    nextBtn.title = 'Next page';
    container.appendChild(nextBtn);
}

function goToPage(page) {
    const groupBy = document.getElementById('groupBySelect').value;
    const totalItems = filteredEmployees.length;
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    
    // Re-render with new page
    if (groupBy === 'none') {
        renderFlatList(filteredEmployees);
    } else {
        const expandedGroups = new Set();
        document.querySelectorAll('.group-content.expanded').forEach(content => {
            const groupId = content.id.replace('content-', '');
            if (groupId) {
                expandedGroups.add(groupId);
            }
        });
        renderGroups(groupEmployees(filteredEmployees, groupBy), groupBy, expandedGroups);
    }
    
    // Scroll to top of employee list
    const container = document.getElementById('groupedEmployeesContainer');
    if (container) {
        container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function changeItemsPerPage(newItemsPerPage) {
    itemsPerPage = newItemsPerPage;
    currentPage = 1; // Reset to first page
    
    // Update both selects
    document.getElementById('itemsPerPageSelect').value = itemsPerPage;
    document.getElementById('itemsPerPageSelectBottom').value = itemsPerPage;
    
    // Re-render
    applyFiltersAndGroup();
}

function showPagination() {
    document.getElementById('paginationControlsTop').style.display = 'flex';
    document.getElementById('paginationControlsBottom').style.display = 'flex';
}

function hidePagination() {
    document.getElementById('paginationControlsTop').style.display = 'none';
    document.getElementById('paginationControlsBottom').style.display = 'none';
}

</script>

</body>
</html>

