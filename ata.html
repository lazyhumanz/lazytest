<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Audit The Auditor (ATA) | QMS</title>
<meta name="description" content="Quality Management System - Audit The Auditor">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjMWY5ZTRiIj48cGF0aCBkPSJNMjAwLTEyMHEtMzMgMC01Ni41LTIzLjVUMTIwLTIwMHYtNTYwcTAtMzMgMjMuNS01Ni41VDIwMC04NDBoNTYwcTMzIDAgNTYuNSAyMy41VDg0MC03NjB2NTYwcTAgMzMtMjMuNSA1Ni41VDc2MC0xMjBIMjAwWm00OTEtODBoNjl2LTY5bC02OSA2OVptLTQ1NyAwaDczbDEyMC0xMjBoODVMNDUyLTIwMGg2NGwxMjAtMTIwaDg1TDU0MS0yMDBoNjVsMTIwLTEyMGgzNHYtNDQwSDIwMHY1MDlsNjktNjloODVMNDM0LTIwMFptNzItMjAwLTU2LTU2IDE3Ny0xNzcgODAgODAgMTQ3LTE0NyA1NiA1Ni0yMDMgMjA0LTgwLTgwLTEyMSAxMjBaIi8+PC9zdmc+">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="theme.css">
    <link rel="stylesheet" href="sidebar.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="env-config.js"></script>
    <script src="supabase-config.js"></script>
    <script src="auth-check.js"></script>
    <script src="access-control.js"></script>
    <script src="confirmation-dialog.js"></script>
    <script src="load-sidebar.js"></script>
    <script src="search.js"></script>
    <script src="form-validation.js"></script>
    <script src="keyboard-shortcuts.js"></script>
    <style>
        /* ATA Management Specific Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.125rem;
            width: 100%;
        }

        .stat-card {
            background: #ffffff;
            border-radius: 0.375rem;
            padding: 0.75rem;
            border: 0.0469rem solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            box-shadow: 0 0.1875rem 0.2812rem -0.0469rem rgba(0, 0, 0, 0.1);
            transform: translateY(-0.0938rem);
        }

        .stat-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.1875rem;
        }

        .stat-title {
            font-size: 0.5625rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Date Range Picker */
        .date-picker-dropdown {
            position: relative;
            display: inline-block;
        }

        .date-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.375rem;
            background: var(--background-white);
            border: 0.0469rem solid var(--border-light);
            border-radius: 0.375rem;
            box-shadow: var(--shadow-lg);
            padding: 0.75rem;
            z-index: 1000;
            min-width: 9.8438rem;
        }

        .date-dropdown-menu.active {
            display: block;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.4688rem 0.75rem;
            background-color: var(--background-white);
            color: var(--text-color);
            border: 0.0469rem solid var(--border-light);
            border-radius: 0.375rem;
            font-size: 0.6562rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-family);
        }

        .action-btn:hover {
            background-color: var(--gray-50);
            border-color: var(--primary-color);
        }

        .action-btn.active {
            background-color: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }

        .action-btn svg {
            width: 0.75rem;
            height: 0.75rem;
        }

        .header-actions {
            display: flex;
            gap: 0.5625rem;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 100%;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .filter-label {
            font-size: 0.5625rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .filter-input {
            padding: 0.375rem 0.5625rem;
            border: 0.0469rem solid var(--border-light);
            border-radius: 0.2812rem;
            font-size: 0.6562rem;
            font-family: var(--font-family);
            background-color: var(--background-white);
            color: var(--text-color);
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
    </style>
</head>

<body>
<!-- Sidebar will be loaded dynamically by load-sidebar.js -->
 <main class="main-content" role="main">
    <p class="page-heading">Audit The Auditor (ATA)</p>
    <div style="margin-bottom: 1.125rem; width: 100%;"></div>

    <!-- Action Buttons -->
    <div class="header-actions" style="margin-top: 2rem; margin-bottom: 1.125rem;">
        <div style="display: flex; gap: 0.5625rem; align-items: center; flex-wrap: wrap;">
            <!-- Week Navigation -->
            <div style="display: flex; align-items: center; gap: 0.5625rem;">
                <button class="action-btn" id="prevWeekBtn" style="padding: 0.4688rem 0.5625rem;" title="Previous Week">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 0.75rem; height: 0.75rem;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <div class="action-btn" id="weekDisplay" style="padding: 0.4688rem 0.75rem; cursor: default; background-color: #f3f4f6; color: #6b7280; border-color: #e5e7eb;">
                    <span id="weekText">Week -</span>
                </div>
                <button class="action-btn" id="nextWeekBtn" style="padding: 0.4688rem 0.5625rem;" title="Next Week">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 0.75rem; height: 0.75rem;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
            <!-- Date Range Picker -->
            <div class="date-picker-dropdown">
                <button class="action-btn" id="dateBtn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span id="dateBtnText">Date Range</span>
                    <svg style="width: 0.5625rem; height: 0.5625rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div class="date-dropdown-menu" id="dateDropdown">
                    <div class="filter-group">
                        <label class="filter-label">Start Date</label>
                        <input type="date" class="filter-input" id="startDate">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">End Date</label>
                        <input type="date" class="filter-input" id="endDate">
                    </div>
                    <div style="display: flex; gap: 0.375rem; margin-top: 0.375rem;">
                        <button class="action-btn" style="flex: 1;" onclick="applyDateFilter()">Apply</button>
                        <button class="action-btn" style="flex: 1;" onclick="clearDateFilter()">Clear</button>
                    </div>
                </div>
            </div>
            <button id="filterToggleBtn" onclick="toggleFilters()" class="action-btn" style="background-color: var(--primary-color); color: var(--white); border-color: var(--primary-color);">
                <svg style="width: 0.75rem; height: 0.75rem;" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
                    <path d="M440-160q-17 0-28.5-11.5T400-200v-240L168-736q-15-20-4.5-42t36.5-22h560q26 0 36.5 22t-4.5 42L560-440v240q0 17-11.5 28.5T520-160h-80Z"/>
                </svg>
                Filters
            </button>
            <button id="viewAllBtn" onclick="toggleViewAll()" style="padding: 0.375rem 0.75rem; background-color: #6b7280; color: white; border: none; border-radius: 0.2812rem; font-size: 0.6562rem; font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">View All</button>
        </div>
        <button id="exportBtn" style="padding: 0.375rem 0.75rem; background-color: #1A733E; color: white; border: none; border-radius: 0.2812rem; font-size: 0.6562rem; font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">Export</button>
    </div>

    <!-- Statistics Overview -->
    <div class="stats-grid" style="margin-top: 1.125rem;">
        <div class="stat-card">
            <div class="stat-value" id="totalAudits">-</div>
            <div class="stat-title">Total Audits Available</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="pendingATA">-</div>
            <div class="stat-title">Pending ATA</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="completedATA">-</div>
            <div class="stat-title">Completed ATA</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="avgAccuracy">-</div>
            <div class="stat-title">Avg Accuracy Score</div>
        </div>
    </div>

    <!-- Filters Section -->
    <div id="filterPanel" style="display: none; background: #ffffff; border-radius: 0.375rem; padding: 0.75rem; border: 0.0469rem solid #e5e7eb; margin-bottom: 0.75rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5625rem;">
            <div style="font-size: 0.6562rem; font-weight: 600; color: #1A733E;">Search & Filters</div>
            <button id="clearFilters" style="padding: 0.2812rem 0.5625rem; background-color: #f9fafb; color: #374151; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; cursor: pointer;">Clear All</button>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(5.2734rem, 1fr)); gap: 0.375rem; align-items: end;">
            <!-- Search -->
            <div>
                <label for="searchInput" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Search</label>
                <input type="text" id="searchInput" placeholder="Search..." style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
            </div>
            
            <!-- Status Filter -->
            <div>
                <label for="statusFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Status</label>
                <select id="statusFilter" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
                    <option value="">All</option>
                    <option value="pending">Pending ATA</option>
                    <option value="completed">Completed ATA</option>
                </select>
            </div>
            
            <!-- Auditor Filter -->
            <div>
                <label for="auditorFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Auditor</label>
                <select id="auditorFilter" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
                    <option value="">All Auditors</option>
                </select>
            </div>
            
            <!-- Scorecard Filter -->
            <div>
                <label for="scorecardFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Scorecard</label>
                <select id="scorecardFilter" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
                    <option value="">All Scorecards</option>
                </select>
            </div>
            
            <!-- Date Range -->
            <div>
                <label for="dateFromFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">From Date</label>
                <input type="date" id="dateFromFilter" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
            </div>

            <div>
                <label for="dateToFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">To Date</label>
                <input type="date" id="dateToFilter" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
            </div>
        </div>
    </div>

    <!-- Audit List -->
    <div id="auditList" style="display: flex; flex-direction: column; gap: 0.5625rem; width: 100%;">
        <!-- Loading indicator -->
        <div id="loadingIndicator" style="text-align: center; padding: 1.5rem; color: #6b7280; font-family: 'Poppins', sans-serif;">
            <p>Loading audits...</p>
        </div>
    </div>

    <!-- No Audits Message -->
    <div id="noAuditsMessage" style="display: none; text-align: center; padding: 1.5rem; color: #6b7280; font-family: 'Poppins', sans-serif;">
        <p style="font-size: 0.75rem; margin-bottom: 0.375rem;">No audits found</p>
        <p style="font-size: 0.6562rem;">Completed audits will appear here for ATA review.</p>
    </div>
</main>

<script>
// ATA Management Functionality
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Check page access using centralized access control
        if (!window.accessControl || !window.accessControl.enforcePageAccess('ata.html')) {
            return; // Access denied, user will be redirected
        }

        const auditList = document.getElementById('auditList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const noAuditsMessage = document.getElementById('noAuditsMessage');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const auditorFilter = document.getElementById('auditorFilter');
        const scorecardFilter = document.getElementById('scorecardFilter');
        const clearFilters = document.getElementById('clearFilters');
        
        let allAudits = [];
        let filteredAudits = [];
        let allScorecards = [];
        let allATAReviews = []; // Store all ATA reviews to check which audits have been reviewed
        let viewingAll = false; // Track if we're viewing all audits or just pending
        let allAuditsLoaded = false;
        
        // Week and date filter state
        let currentWeek = null;
        let currentWeekYear = null;
        let useWeekFilter = false;
        let dateFilter = { start: null, end: null };
        
        // Load scorecards first
        async function loadScorecards() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('scorecards')
                    .select('*')
                    .eq('is_active', true);
                
                if (error) throw error;
                allScorecards = data || [];
                
                // Populate scorecard filter
                const scorecardSelect = document.getElementById('scorecardFilter');
                if (scorecardSelect) {
                    allScorecards.forEach(scorecard => {
                        const option = document.createElement('option');
                        option.value = scorecard.id;
                        option.textContent = scorecard.name;
                        scorecardSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading scorecards:', error);
            }
        }
        
        // Load all ATA reviews to check which audits have been reviewed
        async function loadATAReviews() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('ata_reviews')
                    .select('*');
                
                if (error) throw error;
                allATAReviews = data || [];
            } catch (error) {
                console.error('Error loading ATA reviews:', error);
                allATAReviews = [];
            }
        }
        
        // Get current user info
        function getCurrentUserInfo() {
            try {
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                return {
                    email: (userInfo.email || '').toLowerCase().trim(),
                    name: userInfo.name || '',
                    role: userInfo.role || ''
                };
            } catch (error) {
                console.error('Error getting user info:', error);
                return { email: '', name: '', role: '' };
            }
        }
        
        // Week filter functions
        function getWeekNumber(date = new Date()) {
            const startOfYear = new Date(date.getFullYear(), 0, 1);
            const dayOfWeek = startOfYear.getDay();
            const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            const mondayOfWeek1 = new Date(startOfYear);
            mondayOfWeek1.setDate(startOfYear.getDate() + daysToMonday);
            mondayOfWeek1.setHours(0, 0, 0, 0);
            
            const dateDay = date.getDay();
            const dateDaysToMonday = dateDay === 0 ? -6 : 1 - dateDay;
            const mondayOfDateWeek = new Date(date);
            mondayOfDateWeek.setDate(date.getDate() + dateDaysToMonday);
            mondayOfDateWeek.setHours(0, 0, 0, 0);
            
            const daysSinceWeek1 = Math.floor((mondayOfDateWeek - mondayOfWeek1) / (24 * 60 * 60 * 1000));
            const weekNumber = Math.floor(daysSinceWeek1 / 7) + 1;
            
            return weekNumber;
        }

        function getWeekDates(weekNumber, year) {
            const startOfYear = new Date(year, 0, 1);
            const dayOfWeek = startOfYear.getDay();
            const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            const mondayOfWeek1 = new Date(startOfYear);
            mondayOfWeek1.setDate(startOfYear.getDate() + daysToMonday);
            
            const weekStart = new Date(mondayOfWeek1);
            weekStart.setDate(mondayOfWeek1.getDate() + (weekNumber - 1) * 7);
            weekStart.setHours(0, 0, 0, 0);
            
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            weekEnd.setHours(23, 59, 59, 999);
            
            return { start: weekStart, end: weekEnd };
        }

        function initializeWeekFilter() {
            const today = new Date();
            currentWeek = getWeekNumber(today);
            currentWeekYear = today.getFullYear();
            useWeekFilter = false;
            updateWeekDisplay();
        }

        function updateWeekDisplay() {
            const weekTextEl = document.getElementById('weekText');
            const prevWeekBtn = document.getElementById('prevWeekBtn');
            const nextWeekBtn = document.getElementById('nextWeekBtn');
            const weekDisplay = document.getElementById('weekDisplay');
            
            if (weekTextEl) {
                if (useWeekFilter && currentWeek !== null) {
                    weekTextEl.textContent = `Week ${currentWeek}`;
                } else {
                    weekTextEl.textContent = '-';
                }
            }
            
            if (prevWeekBtn) {
                if (useWeekFilter) {
                    prevWeekBtn.disabled = false;
                    prevWeekBtn.style.opacity = '1';
                    prevWeekBtn.style.cursor = 'pointer';
                } else {
                    prevWeekBtn.disabled = true;
                    prevWeekBtn.style.opacity = '0.5';
                    prevWeekBtn.style.cursor = 'not-allowed';
                }
            }
            
            if (nextWeekBtn) {
                if (useWeekFilter) {
                    nextWeekBtn.disabled = false;
                    nextWeekBtn.style.opacity = '1';
                    nextWeekBtn.style.cursor = 'pointer';
                } else {
                    nextWeekBtn.disabled = true;
                    nextWeekBtn.style.opacity = '0.5';
                    nextWeekBtn.style.cursor = 'not-allowed';
                }
            }
            
            if (weekDisplay) {
                if (useWeekFilter) {
                    weekDisplay.style.backgroundColor = 'var(--primary-color)';
                    weekDisplay.style.color = 'var(--white)';
                    weekDisplay.style.borderColor = 'var(--primary-color)';
                } else {
                    weekDisplay.style.backgroundColor = '#f3f4f6';
                    weekDisplay.style.color = '#6b7280';
                    weekDisplay.style.borderColor = '#e5e7eb';
                }
            }
        }

        function navigateWeek(direction) {
            currentWeek += direction;
            
            if (currentWeek > 52) {
                currentWeek = 1;
                currentWeekYear += 1;
            } else if (currentWeek < 1) {
                currentWeek = 52;
                currentWeekYear -= 1;
            }
            
            updateWeekDisplay();
            useWeekFilter = true;
            dateFilter.start = null;
            dateFilter.end = null;
            const startDateEl = document.getElementById('startDate');
            const endDateEl = document.getElementById('endDate');
            const dateBtnTextEl = document.getElementById('dateBtnText');
            if (startDateEl) startDateEl.value = '';
            if (endDateEl) endDateEl.value = '';
            if (dateBtnTextEl) dateBtnTextEl.textContent = 'Date Range';
            filterAudits();
        }

        window.applyDateFilter = function() {
            const startDateEl = document.getElementById('startDate');
            const endDateEl = document.getElementById('endDate');
            const startDate = startDateEl?.value || '';
            const endDate = endDateEl?.value || '';
            
            if (startDate) dateFilter.start = startDate;
            if (endDate) dateFilter.end = endDate;

            const dateBtnTextEl = document.getElementById('dateBtnText');
            if (startDate || endDate) {
                const start = startDate ? new Date(startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'Start';
                const end = endDate ? new Date(endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'End';
                if (dateBtnTextEl) dateBtnTextEl.textContent = `${start} - ${end}`;
                useWeekFilter = false;
                updateWeekDisplay();
            } else {
                if (dateBtnTextEl) dateBtnTextEl.textContent = 'Date Range';
                useWeekFilter = false;
                updateWeekDisplay();
            }

            const dateDropdown = document.getElementById('dateDropdown');
            if (dateDropdown) dateDropdown.classList.remove('active');
            filterAudits();
        };

        window.clearDateFilter = function() {
            dateFilter.start = null;
            dateFilter.end = null;
            const startDateEl = document.getElementById('startDate');
            const endDateEl = document.getElementById('endDate');
            const dateBtnTextEl = document.getElementById('dateBtnText');
            const dateDropdown = document.getElementById('dateDropdown');
            if (startDateEl) startDateEl.value = '';
            if (endDateEl) endDateEl.value = '';
            if (dateBtnTextEl) dateBtnTextEl.textContent = 'Date Range';
            if (dateDropdown) dateDropdown.classList.remove('active');
            useWeekFilter = false;
            updateWeekDisplay();
            filterAudits();
        };
        
        // Load audits from all scorecard tables
        async function loadAudits(onlyPending = true) {
            try {
                const loadingMessage = onlyPending ? 'Loading audits pending ATA review...' : 'Loading all audits...';
                console.log(loadingMessage);
                
                if (!window.supabaseClient) {
                    throw new Error('Supabase client not initialized');
                }
                
                // Show loading indicator
                loadingIndicator.style.display = 'block';
                loadingIndicator.innerHTML = `<p>${loadingMessage}</p>`;
                auditList.style.display = 'flex';
                noAuditsMessage.style.display = 'none';
                
                await Promise.all([loadScorecards(), loadATAReviews()]);
                
                let combinedAudits = [];
                
                // Get set of audit IDs that have been reviewed
                const reviewedAuditIds = new Set(
                    allATAReviews.map(review => `${review.audit_id}_${review.audit_table_name}`)
                );
                
                // Load from all scorecard tables
                for (const scorecard of allScorecards) {
                    try {
                        let query = window.supabaseClient
                            .from(scorecard.table_name)
                            .select('*')
                            .not('submitted_at', 'is', null) // Only completed audits
                            .not('auditor_email', 'is', null); // Must have an auditor
                        
                        query = query.order('submitted_at', { ascending: false });
                        
                        const { data, error } = await query;
                        
                        if (error) {
                            console.warn(`Error loading from ${scorecard.table_name}:`, error);
                            continue;
                        }
                        
                        if (data && data.length > 0) {
                            const auditsWithScorecard = data.map(audit => ({
                                ...audit,
                                _scorecard_id: scorecard.id,
                                _scorecard_name: scorecard.name,
                                _scorecard_table: scorecard.table_name,
                                _has_ata_review: reviewedAuditIds.has(`${audit.id}_${scorecard.table_name}`)
                            }));
                            combinedAudits = combinedAudits.concat(auditsWithScorecard);
                        }
                    } catch (err) {
                        console.warn(`Exception loading from ${scorecard.table_name}:`, err);
                        continue;
                    }
                }
                
                // Apply date/week filtering
                let dateFilteredAudits = combinedAudits;
                if (dateFilter.start || dateFilter.end) {
                    useWeekFilter = false;
                    dateFilteredAudits = dateFilteredAudits.filter(a => {
                        const submitted = new Date(a.submitted_at || a.submittedAt);
                        if (dateFilter.start && submitted < new Date(dateFilter.start)) return false;
                        if (dateFilter.end) {
                            const endDate = new Date(dateFilter.end);
                            endDate.setHours(23, 59, 59, 999);
                            if (submitted > endDate) return false;
                        }
                        return true;
                    });
                } else if (useWeekFilter && currentWeek !== null) {
                    const weekDates = getWeekDates(currentWeek, currentWeekYear);
                    dateFilteredAudits = dateFilteredAudits.filter(a => {
                        const submitted = new Date(a.submitted_at || a.submittedAt);
                        return submitted >= weekDates.start && submitted <= weekDates.end;
                    });
                }
                
                // Sort by submission date descending
                dateFilteredAudits.sort((a, b) => {
                    const dateA = new Date(a.submitted_at || a.submittedAt);
                    const dateB = new Date(b.submitted_at || b.submittedAt);
                    return dateB - dateA;
                });
                
                console.log(`Total audits loaded: ${dateFilteredAudits.length} (${onlyPending ? 'pending only' : 'all'})`);
                
                allAudits = dateFilteredAudits;
                allAuditsLoaded = true;
                
                // Populate auditor filter
                const uniqueAuditors = new Set();
                allAudits.forEach(audit => {
                    if (audit.auditor_email) {
                        uniqueAuditors.add(audit.auditor_email);
                    }
                });
                
                const auditorSelect = document.getElementById('auditorFilter');
                if (auditorSelect) {
                    // Clear existing options except "All Auditors"
                    auditorSelect.innerHTML = '<option value="">All Auditors</option>';
                    uniqueAuditors.forEach(email => {
                        const audit = allAudits.find(a => a.auditor_email === email);
                        const option = document.createElement('option');
                        option.value = email;
                        option.textContent = audit?.auditor_name || email;
                        auditorSelect.appendChild(option);
                    });
                }
                
                // Update filtered audits based on view mode
                if (viewingAll) {
                    filteredAudits = [...allAudits];
                } else {
                    // Only show pending (not reviewed)
                    filteredAudits = allAudits.filter(a => !a._has_ata_review);
                }
                
                updateStatistics();
                renderAudits();
            } catch (error) {
                console.error('Error loading audits:', error);
                loadingIndicator.style.display = 'none';
                noAuditsMessage.style.display = 'block';
            }
        }
        
        // Update statistics
        function updateStatistics() {
            const pending = filteredAudits.filter(a => !a._has_ata_review).length;
            const completed = filteredAudits.filter(a => a._has_ata_review).length;
            const total = filteredAudits.length;
            
            // Calculate average accuracy from completed ATA reviews
            const completedReviews = allATAReviews.filter(review => {
                return filteredAudits.some(audit => 
                    audit.id === review.audit_id && 
                    audit._scorecard_table === review.audit_table_name
                );
            });
            
            let avgAccuracy = 0;
            if (completedReviews.length > 0) {
                const totalAccuracy = completedReviews.reduce((sum, review) => {
                    return sum + (parseFloat(review.ata_accuracy_score) || 0);
                }, 0);
                avgAccuracy = Math.round((totalAccuracy / completedReviews.length) * 10) / 10;
            }
            
            document.getElementById('totalAudits').textContent = total;
            document.getElementById('pendingATA').textContent = pending;
            document.getElementById('completedATA').textContent = completed;
            document.getElementById('avgAccuracy').textContent = avgAccuracy > 0 ? `${avgAccuracy}%` : '-';
        }
        
        // Render audits
        function renderAudits() {
            loadingIndicator.style.display = 'none';
            
            updateStatistics();
            
            if (filteredAudits.length === 0) {
                auditList.style.display = 'none';
                noAuditsMessage.style.display = 'block';
                return;
            }
            
            auditList.style.display = 'flex';
            noAuditsMessage.style.display = 'none';
            
            const auditCards = filteredAudits.map(audit => createAuditCard(audit));
            auditList.innerHTML = auditCards.join('');
        }
        
        // Helper functions
        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatCardDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }
        
        // Create audit card
        function createAuditCard(audit) {
            const submittedDate = formatCardDate(audit.submitted_at || audit.submittedAt);
            const hasReview = audit._has_ata_review;
            const status = hasReview ? 'Completed' : 'Pending';
            
            let statusColor, statusBgColor, statusTextColor, statusIcon;
            if (status === 'Pending') {
                statusColor = '#f59e0b';
                statusBgColor = '#fef3c7';
                statusTextColor = '#92400e';
                statusIcon = `<svg style="width: 0.5625rem; height: 0.5625rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>`;
            } else {
                statusColor = '#10b981';
                statusBgColor = '#dcfce7';
                statusTextColor = '#166534';
                statusIcon = `<svg style="width: 0.5625rem; height: 0.5625rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>`;
            }
            
            // Get ATA review if exists
            const ataReview = allATAReviews.find(r => 
                r.audit_id === audit.id && r.audit_table_name === audit._scorecard_table
            );
            
            return `
                <div class="audit-card" style="background: #f9fafb; border: 0.0469rem solid #e5e7eb; border-radius: 0.1875rem; padding: 0.5625rem; transition: all 0.2s ease; display: flex; justify-content: space-between; align-items: center; gap: 0.5625rem; cursor: pointer; position: relative;" 
                     onclick="${!hasReview ? `startATAReview('${audit.id}', '${audit._scorecard_table}', '${audit._scorecard_id}')` : `viewATAReview('${audit.id}', '${audit._scorecard_table}')`}"
                     onmouseenter="this.style.borderColor='#1A733E'; this.style.backgroundColor='#ffffff';"
                     onmouseleave="this.style.borderColor='#e5e7eb'; this.style.backgroundColor='#f9fafb';">
                    
                    <div style="flex: 1; display: flex; align-items: center; gap: 0.5625rem; pointer-events: none;">
                        <!-- Avatar with initials -->
                        <div style="width: 1.875rem; height: 1.875rem; border-radius: 0.1875rem; background: ${statusColor}; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.6562rem; flex-shrink: 0;">
                            ${getInitials(audit.employee_name || 'Unknown')}
                        </div>
                        
                        <!-- Audit info -->
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 0.375rem; margin-bottom: 0.1875rem; flex-wrap: wrap;">
                                <h4 style="margin: 0; font-size: 0.6562rem; font-weight: 600; color: #1f2937;">
                                    ${escapeHtml(audit.employee_name || 'Unknown Employee')}
                                </h4>
                                ${audit._scorecard_name ? `
                                    <span style="background-color: #f3f4f6; color: #374151; padding: 0.0938rem 0.375rem; border-radius: 0.1875rem; font-size: 0.4688rem; font-weight: 600; border: 0.0469rem solid #d1d5db;">
                                        ${escapeHtml(audit._scorecard_name)}
                                    </span>
                                ` : ''}
                                <span style="background-color: ${statusBgColor}; color: ${statusTextColor}; padding: 0.0938rem 0.375rem; border-radius: 0.1875rem; font-size: 0.5156rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.1875rem;">
                                    ${statusIcon} ${status}
                                </span>
                                ${ataReview ? `
                                    <span style="background-color: #dbeafe; color: #1e40af; padding: 0.0938rem 0.375rem; border-radius: 0.1875rem; font-size: 0.4688rem; font-weight: 600;">
                                        Accuracy: ${ataReview.ata_accuracy_score || 'N/A'}%
                                    </span>
                                ` : ''}
                            </div>
                            <p style="margin: 0; font-size: 0.5625rem; color: #6b7280; display: flex; align-items: center; gap: 0.2812rem; flex-wrap: wrap;">
                                <span>${escapeHtml(audit.interaction_id || 'No ID')}</span>
                                <span style="color: #d1d5db;">•</span>
                                <span style="font-weight: 500;">${audit.average_score || audit.averageScore || '0'}%</span>
                                <span style="color: #d1d5db;">•</span>
                                <span style="color: #374151; font-weight: 500;">Auditor: ${escapeHtml(audit.auditor_name || audit.auditorName || 'Unknown')}</span>
                                <span style="color: #d1d5db;">•</span>
                                <span>${submittedDate}</span>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Action buttons -->
                    <div style="display: flex; gap: 0.375rem; flex-shrink: 0; align-items: center; pointer-events: auto;">
                        ${!hasReview ? `
                            <button 
                                onclick="event.stopPropagation(); startATAReview('${audit.id}', '${audit._scorecard_table}', '${audit._scorecard_id}')"
                                style="padding: 0.375rem 0.75rem; background-color: #1A733E; color: white; border: none; border-radius: 0.1875rem; font-size: 0.5625rem; font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.2s ease; white-space: nowrap;"
                                onmouseover="this.style.backgroundColor='#15582E'"
                                onmouseout="this.style.backgroundColor='#1A733E'"
                            >
                                Review Audit
                            </button>
                        ` : `
                            <button 
                                onclick="event.stopPropagation(); viewATAReview('${audit.id}', '${audit._scorecard_table}')"
                                style="padding: 0.375rem 0.75rem; background-color: #1A733E; color: white; border: none; border-radius: 0.1875rem; font-size: 0.5625rem; font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.2s ease; white-space: nowrap;"
                                onmouseover="this.style.backgroundColor='#15582E'"
                                onmouseout="this.style.backgroundColor='#1A733E'"
                            >
                                View ATA Review
                            </button>
                        `}
                    </div>
                </div>
            `;
        }
        
        // Start ATA review - redirects to create-audit.html in ATA mode
        window.startATAReview = function(auditId, tableName, scorecardId) {
            // Redirect to create-audit.html with ATA mode parameters
            const params = new URLSearchParams({
                ata: 'true',
                auditId: auditId,
                table: tableName
            });
            if (scorecardId) {
                params.append('scorecard', scorecardId);
            }
            window.location.href = `create-audit.html?${params.toString()}`;
        };
        
        // View ATA review details
        window.viewATAReview = function(auditId, tableName) {
            // Redirect to audit-view.html with ATA review flag
            window.location.href = `audit-view.html?id=${auditId}&table=${tableName}&ata=true`;
        };
        
        // Toggle filters
        window.toggleFilters = function() {
            const panel = document.getElementById('filterPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        };
        
        // Toggle between viewing all audits and pending only
        window.toggleViewAll = function() {
            const viewAllBtn = document.getElementById('viewAllBtn');
            
            if (viewingAll) {
                viewingAll = false;
                viewAllBtn.textContent = 'View All';
                viewAllBtn.style.backgroundColor = '#6b7280';
                filteredAudits = allAudits.filter(a => !a._has_ata_review);
            } else {
                viewingAll = true;
                viewAllBtn.textContent = 'Show Pending Only';
                viewAllBtn.style.backgroundColor = '#1A733E';
                filteredAudits = [...allAudits];
            }
            
            updateStatistics();
            renderAudits();
        };
        
        // Filter audits
        function filterAudits() {
            const searchTerm = (searchInput?.value || '').toLowerCase();
            const statusValue = statusFilter?.value || '';
            const auditorValue = auditorFilter?.value || '';
            const scorecardValue = scorecardFilter?.value || '';
            const dateFrom = document.getElementById('dateFromFilter')?.value || '';
            const dateTo = document.getElementById('dateToFilter')?.value || '';
            
            // Start with the appropriate base set
            let baseAudits = viewingAll ? allAudits : allAudits.filter(a => !a._has_ata_review);
            
            filteredAudits = baseAudits.filter(audit => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    (audit.employee_name && audit.employee_name.toLowerCase().includes(searchTerm)) ||
                    (audit.employee_email && audit.employee_email.toLowerCase().includes(searchTerm)) ||
                    (audit.interaction_id && audit.interaction_id.toLowerCase().includes(searchTerm)) ||
                    (audit.auditor_name && audit.auditor_name.toLowerCase().includes(searchTerm)) ||
                    (audit.auditor_email && audit.auditor_email.toLowerCase().includes(searchTerm));
                
                // Status filter
                let matchesStatus = true;
                if (statusValue === 'pending') {
                    matchesStatus = !audit._has_ata_review;
                } else if (statusValue === 'completed') {
                    matchesStatus = audit._has_ata_review;
                }
                
                // Auditor filter
                const matchesAuditor = !auditorValue || audit.auditor_email === auditorValue;
                
                // Scorecard filter
                const matchesScorecard = !scorecardValue || audit._scorecard_id === scorecardValue;
                
                // Date range filter
                let matchesDateRange = true;
                if (dateFilter.start || dateFilter.end) {
                    const submitted = new Date(audit.submitted_at || audit.submittedAt);
                    if (dateFilter.start && submitted < new Date(dateFilter.start)) matchesDateRange = false;
                    if (dateFilter.end) {
                        const endDate = new Date(dateFilter.end);
                        endDate.setHours(23, 59, 59, 999);
                        if (submitted > endDate) matchesDateRange = false;
                    }
                } else if (useWeekFilter && currentWeek !== null) {
                    const weekDates = getWeekDates(currentWeek, currentWeekYear);
                    const submitted = new Date(audit.submitted_at || audit.submittedAt);
                    if (submitted < weekDates.start || submitted > weekDates.end) matchesDateRange = false;
                }
                
                // Additional date range filter from filter panel
                if (matchesDateRange && (dateFrom || dateTo)) {
                    const submitted = new Date(audit.submitted_at || audit.submittedAt);
                    if (dateFrom) {
                        const fromDate = new Date(dateFrom);
                        if (submitted < fromDate) matchesDateRange = false;
                    }
                    if (dateTo) {
                        const toDate = new Date(dateTo);
                        toDate.setHours(23, 59, 59, 999);
                        if (submitted > toDate) matchesDateRange = false;
                    }
                }
                
                return matchesSearch && matchesStatus && matchesAuditor && matchesScorecard && matchesDateRange;
            });
            
            renderAudits();
        }
        
        // Event listeners
        if (searchInput) {
            searchInput.addEventListener('input', filterAudits);
        }
        if (statusFilter) {
            statusFilter.addEventListener('change', filterAudits);
        }
        if (auditorFilter) {
            auditorFilter.addEventListener('change', filterAudits);
        }
        if (scorecardFilter) {
            scorecardFilter.addEventListener('change', filterAudits);
        }
        if (clearFilters) {
            clearFilters.addEventListener('click', function() {
                document.querySelectorAll('input[id$="Filter"], select[id$="Filter"], #searchInput').forEach(input => {
                    input.value = '';
                });
                filterAudits();
            });
        }
        
        const dateFromFilter = document.getElementById('dateFromFilter');
        const dateToFilter = document.getElementById('dateToFilter');
        if (dateFromFilter) dateFromFilter.addEventListener('change', filterAudits);
        if (dateToFilter) dateToFilter.addEventListener('change', filterAudits);
        
        // Export functionality
        document.getElementById('exportBtn').addEventListener('click', function() {
            if (filteredAudits.length === 0) {
                alert('No audits to export.');
                return;
            }
            
            const headers = [
                'Audit ID', 'Employee Name', 'Employee Email', 'Auditor Name', 'Auditor Email',
                'Scorecard', 'Original Score', 'Passing Status', 'Interaction ID', 
                'Submitted At', 'ATA Status', 'ATA Accuracy Score', 'ATA Review Score'
            ];
            
            const csvContent = [
                headers.join(','),
                ...filteredAudits.map(a => {
                    const ataReview = allATAReviews.find(r => 
                        r.audit_id === a.id && r.audit_table_name === a._scorecard_table
                    );
                    return [
                        a.id || '',
                        a.employee_name || '',
                        a.employee_email || '',
                        a.auditor_name || '',
                        a.auditor_email || '',
                        a._scorecard_name || '',
                        a.average_score || a.averageScore || '',
                        a.passing_status || '',
                        a.interaction_id || '',
                        a.submitted_at || a.submittedAt || '',
                        a._has_ata_review ? 'Completed' : 'Pending',
                        ataReview ? (ataReview.ata_accuracy_score || '') : '',
                        ataReview ? (ataReview.ata_review_score || '') : ''
                    ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(',');
                })
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `ata-reports-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // Setup event listeners for week navigation and date picker
        function setupHeaderActionListeners() {
            // Week navigation buttons
            const prevWeekBtn = document.getElementById('prevWeekBtn');
            const nextWeekBtn = document.getElementById('nextWeekBtn');
            if (prevWeekBtn) {
                prevWeekBtn.addEventListener('click', () => navigateWeek(-1));
            }
            if (nextWeekBtn) {
                nextWeekBtn.addEventListener('click', () => navigateWeek(1));
            }

            // Date button
            const dateBtn = document.getElementById('dateBtn');
            if (dateBtn) {
                dateBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const dropdown = document.getElementById('dateDropdown');
                    if (dropdown) dropdown.classList.toggle('active');
                });
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.date-picker-dropdown')) {
                    const dropdown = document.getElementById('dateDropdown');
                    if (dropdown) dropdown.classList.remove('active');
                }
            });
        }
        
        // Setup listeners when DOM is ready
        setupHeaderActionListeners();
        
        // Initialize week filter
        initializeWeekFilter();
        
        // Initialize - load pending audits by default
        loadAudits(true);
        
    } catch (error) {
        console.error('Error in ATA management functionality:', error);
    }
});
</script>

</body>
</html>
