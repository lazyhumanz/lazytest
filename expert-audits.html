<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Expert Audit Reports | QMS</title>
<meta name="description" content="Quality Management System Dashboard">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjMWY5ZTRiIj48cGF0aCBkPSJNMjAwLTEyMHEtMzMgMC01Ni41LTIzLjVUMTIwLTIwMHYtNTYwcTAtMzMgMjMuNS01Ni41VDIwMC04NDBoNTYwcTMzIDAgNTYuNSAyMy41VDg0MC03NjB2NTYwcTAgMzMtMjMuNSA1Ni41VDc2MC0xMjBIMjAwWm00OTEtODBoNjl2LTY5bC02OSA2OVptLTQ1NyAwaDczbDEyMC0xMjBoODVMNDUyLTIwMGg2NGwxMjAtMTIwaDg1TDU0MS0yMDBoNjVsMTIwLTEyMGgzNHYtNDQwSDIwMHY1MDlsNjktNjloODVMNDM0LTIwMFptNzItMjAwLTU2LTU2IDE3Ny0xNzcgODAgODAgMTQ3LTE0NyA1NiA1Ni0yMDMgMjA0LTgwLTgwLTEyMSAxMjBaIi8+PC9zdmc+">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="theme.css">
    <link rel="stylesheet" href="sidebar.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#1a733e',
              'primary-dark': '#0d5e3a',
              'dark-forest': '#032816',
              'success': '#10b981',
              'warning': '#f59e0b',
              'error': '#ef4444',
            },
            fontFamily: {
              sans: ['Poppins', 'sans-serif'],
            },
          },
        },
      }
    </script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="env-config.js"></script>
    <script src="supabase-config.js"></script>
    <script src="auth-check.js"></script>
    <script src="confirmation-dialog.js"></script>
    <script src="load-sidebar.js"></script>
    <script src="search.js"></script>
    <script src="form-validation.js"></script>
    <script src="keyboard-shortcuts.js"></script>
    <script src="timezone-utils.js"></script>
    <script src="date-filter-utils.js"></script>
    <style>
        /* Audit Reports Specific Styles */
        .expert-audits-container {
            display: flex;
            flex-direction: column;
            gap: 1.125rem;
            padding: 0;
            width: 100%;
            margin: 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.125rem;
            width: 100%;
        }

        /* KPI Cards - Matching employee-performance.html */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(9rem, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.125rem;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        @media (min-width: 1200px) {
            .kpi-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 1199px) {
            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(8rem, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }

        .kpi-card {
            background-color: var(--background-white);
            border: 0.0469rem solid var(--border-light);
            border-radius: 0.375rem;
            padding: 0.75rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
            min-width: 0;
            width: 100%;
            box-sizing: border-box;
            cursor: pointer;
            position: relative;
        }

        .kpi-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
            transform: translateY(-0.0625rem);
        }

        .kpi-card.active {
            border-color: var(--primary-color);
            border-width: 0.0938rem;
            box-shadow: 0 0 0 0.1875rem rgba(26, 115, 62, 0.1);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            min-width: 0;
        }

        .kpi-label {
            font-size: 0.5625rem;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }

        .kpi-date {
            font-size: 0.5rem;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .kpi-value {
            font-size: clamp(1rem, 1.5vw, 1.5rem);
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 0.25rem;
            line-height: 1;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .kpi-change {
            font-size: 0.5625rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .kpi-change.positive {
            color: var(--success-color);
        }

        .kpi-change.negative {
            color: var(--error-color);
        }

        .kpi-chart-container {
            height: 1.6875rem;
            margin-top: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 0.5625rem;
            flex-wrap: wrap;
            align-items: center;
            width: 100%;
            max-width: 100%;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.4688rem 0.75rem;
            background-color: var(--background-white);
            color: var(--text-color);
            border: 0.0469rem solid var(--border-light);
            border-radius: 0.375rem;
            font-size: 0.6562rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-family);
        }

        .action-btn:hover {
            background-color: var(--gray-50);
            border-color: var(--primary-color);
        }

        .action-btn.active {
            background-color: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }

        .action-btn svg {
            width: 0.75rem;
            height: 0.75rem;
        }

        /* Date Range Picker */
        .date-picker-dropdown {
            position: relative;
            display: inline-block;
        }

        .date-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.375rem;
            background: var(--background-white);
            border: 0.0469rem solid var(--border-light);
            border-radius: 0.375rem;
            box-shadow: var(--shadow-lg);
            padding: 0.75rem;
            z-index: 1000;
            min-width: 9.8438rem;
        }

        .date-dropdown-menu.active {
            display: block;
        }

        .controls-section {
            background: #ffffff;
            border-radius: 0.375rem;
            padding: 0.75rem;
            border: 0.0469rem solid #e5e7eb;
            margin-bottom: 0.75rem;
            width: 100%;
        }

        .controls-header {
            font-size: 0.6562rem;
            font-weight: 600;
            color: #1A733E;
            margin-bottom: 0.5625rem;
            padding-bottom: 0.1875rem;
            border-bottom: 0.0469rem solid #1A733E;
            text-transform: uppercase;
            letter-spacing: 0.0141rem;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(7.0312rem, 1fr));
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .filter-label {
            font-size: 0.5625rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .filter-input, .filter-select {
            padding: 0.375rem 0.5625rem;
            border: 0.0469rem solid var(--border-light);
            border-radius: 0.2812rem;
            font-size: 0.6562rem;
            font-family: var(--font-family);
            background-color: var(--background-white);
            color: var(--text-color);
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .control-label {
            font-size: 0.5625rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.1875rem;
            font-family: 'Poppins', sans-serif;
        }

        .control-select {
            padding: 0.2812rem 0.375rem;
            border: 0.0469rem solid #d1d5db;
            border-radius: 0.1875rem;
            font-size: 0.5625rem;
            font-family: 'Poppins', sans-serif;
            transition: all 0.2s ease;
            background-color: #ffffff;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%23374151\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'%3e%3cpolyline points=\'6,9 12,15 18,9\'%3e%3c/polyline%3e%3c/svg%3e');
            background-repeat: no-repeat;
            background-position: right 0.5625rem center;
            background-size: 0.75rem;
            padding-right: 1.875rem;
            cursor: pointer;
        }

        .control-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

    </style>

</head>

<body>
<!-- Sidebar will be loaded dynamically by load-sidebar.js -->
<main class="main-content" role="main">
    <p class="page-heading">Audit Reports</p>
    <div style="margin-bottom: 1.125rem; width: 100%;"></div>

    <!-- Action Buttons -->
    <div class="header-actions" style="margin-top: 2rem; margin-bottom: 1.125rem;">
        <!-- Week Navigation -->
        <div style="display: flex; align-items: center; gap: 0.5625rem;">
            <button class="action-btn" id="prevWeekBtn" style="padding: 0.4688rem 0.5625rem;" title="Previous Week">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 0.75rem; height: 0.75rem;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
            </button>
            <div class="action-btn" id="weekDisplay" style="padding: 0.4688rem 0.75rem; cursor: default; background-color: var(--primary-color); color: var(--white); border-color: var(--primary-color);">
                <span id="weekText">Week -</span>
                </div>
            <button class="action-btn" id="nextWeekBtn" style="padding: 0.4688rem 0.5625rem;" title="Next Week">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 0.75rem; height: 0.75rem;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
                </div>
        <div class="date-picker-dropdown">
            <button class="action-btn" id="dateBtn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span id="dateBtnText">Date Range</span>
                <svg style="width: 0.5625rem; height: 0.5625rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div class="date-dropdown-menu" id="dateDropdown">
                <div class="filter-group">
                    <label class="filter-label">Start Date</label>
                    <input type="date" class="filter-input" id="startDate">
            </div>
                <div class="filter-group">
                    <label class="filter-label">End Date</label>
                    <input type="date" class="filter-input" id="endDate">
                </div>
                <div style="display: flex; gap: 0.375rem; margin-top: 0.375rem;">
                    <button class="action-btn" style="flex: 1;" onclick="applyDateFilter()">Apply</button>
                    <button class="action-btn" style="flex: 1;" onclick="clearDateFilter()">Clear</button>
                </div>
            </div>
        </div>
        <!-- Quick Date Filters -->
        <div style="display: flex; align-items: center; gap: 0.375rem;">
            <button class="action-btn quick-date-btn" id="todayBtn" onclick="applyQuickDateFilter('today')">Today</button>
            <button class="action-btn quick-date-btn" id="yesterdayBtn" onclick="applyQuickDateFilter('yesterday')">Yesterday</button>
            <button class="action-btn quick-date-btn active" id="thisMonthBtn" onclick="applyQuickDateFilter('thisMonth')">This Month</button>
        </div>
        <button class="action-btn" id="exportBtn">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
            <span>Export</span>
            <svg style="width: 0.5625rem; height: 0.5625rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </button>
        <button class="action-btn" id="filterBtn">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
            </svg>
        </button>
        <button class="action-btn" id="clearAllBtn" style="display: none;" title="Clear All Filters">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span>Clear All</span>
        </button>
        <button id="viewAllBtn" onclick="toggleViewAll()" style="display: none; padding: 0.4688rem 0.75rem; background-color: #f3f4f6; color: #374151; border: 0.0469rem solid #d1d5db; border-radius: 0.375rem; font-size: 0.6562rem; font-family: 'Poppins', sans-serif; font-weight: 500; cursor: pointer; transition: all 0.2s ease;" class="action-btn">View All</button>
                </div>

    <!-- Filters and Search -->
    <div id="filterPanel" class="controls-section" style="display: none; margin-bottom: 1.125rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5625rem;">
            <div class="controls-header" style="margin: 0; padding: 0; border: none;">Search & Filters</div>
            <button id="clearFilters" style="padding: 0.2812rem 0.5625rem; background-color: #f9fafb; color: #374151; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; cursor: pointer;">Clear All</button>
        </div>
    
    <!-- Compact Filter Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(5.2734rem, 1fr)); gap: 0.375rem; align-items: end; width: 100%;">
        <!-- Scorecard Selector -->
        <div>
            <label for="scorecardSelector" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Scorecard</label>
            <select id="scorecardSelector" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
                <option value="">Loading scorecards...</option>
            </select>
        </div>
        
        <!-- General Search -->
        <div>
            <label for="searchInput" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Search</label>
            <input type="text" id="searchInput" placeholder="Search audits..." style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
        </div>
        
        <!-- Auditor Name -->
        <div id="auditorNameFilterContainer">
            <label for="auditorNameFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Auditor</label>
            <input type="text" id="auditorNameFilter" placeholder="Auditor name..." style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
        </div>
        
        <!-- Employee Name -->
        <div>
            <label for="employeeNameFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Employee</label>
            <input type="text" id="employeeNameFilter" placeholder="Employee name..." style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
        </div>
        
        <!-- Audit Type -->
        <div>
            <label for="auditTypeFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Type</label>
            <select id="auditTypeFilter" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
                <option value="">All Types</option>
                <option value="Routine Audit (Recorded)">Routine (Recorded)</option>
                <option value="Focused Audit (Recorded)">Focused (Recorded)</option>
                <option value="Focused Audit (Live)">Focused (Live)</option>
                <option value="Evaluation and Feedback">Evaluation</option>
            </select>
        </div>
        
        <!-- Status -->
        <div>
            <label for="statusFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Status</label>
            <select id="statusFilter" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
                <option value="">All Statuses</option>
                <option value="Passed">Passed</option>
                <option value="Not Passed">Not Passed</option>
            </select>
        </div>
        
        <!-- Quarter -->
        <div>
            <label for="quarterFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Quarter</label>
            <select id="quarterFilter" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
                <option value="">All Quarters</option>
                <option value="Q1">Q1</option>
                <option value="Q2">Q2</option>
                <option value="Q3">Q3</option>
                <option value="Q4">Q4</option>
            </select>
        </div>
        
        <!-- Channel -->
        <div>
            <label for="channelFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Channel</label>
            <select id="channelFilter" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
                <option value="">All Channels</option>
                <option value="FN Chat CFD">FN Chat CFD</option>
                <option value="FN Chat Futures">FN Chat Futures</option>
                <option value="FN Email">FN Email</option>
                <option value="Regular PSTF">Regular PSTF</option>
                <option value="Advance PSTF">Advance PSTF</option>
                <option value="PO + Ticket">PO + Ticket</option>
                <option value="CPM Email">CPM Email</option>
                <option value="B.Dev Email">B.Dev Email</option>
                <option value="MKT Social Media Comments">MKT Social Media</option>
            </select>
        </div>
        
        <!-- Employee Type -->
        <div>
            <label for="employeeTypeFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Emp Type</label>
            <select id="employeeTypeFilter" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
                <option value="">All Types</option>
                <option value="Employee">Employee</option>
                <option value="Supervisor">Supervisor</option>
                <option value="Manager">Manager</option>
            </select>
        </div>
        
        <!-- Country -->
        <div>
            <label for="countryFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Country</label>
            <select id="countryFilter" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
                <option value="">All Countries</option>
                <option value="Bangladesh">Bangladesh</option>
                <option value="Sri Lanka">Sri Lanka</option>
            </select>
        </div>
        
        <!-- Interaction ID -->
        <div>
            <label for="interactionIdFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Interaction ID</label>
            <input type="text" id="interactionIdFilter" placeholder="Interaction ID..." style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
        </div>
        
        <!-- Week -->
        <div>
            <label for="weekFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Week</label>
            <input type="number" id="weekFilter" min="1" max="52" placeholder="Week (1-52)..." style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
        </div>
        
        <!-- Min Score -->
        <div>
            <label for="minScoreFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Min Score</label>
            <input type="number" id="minScoreFilter" min="0" max="100" placeholder="Min %..." style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
        </div>
        
        <!-- Max Score -->
        <div>
            <label for="maxScoreFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Max Score</label>
            <input type="number" id="maxScoreFilter" min="0" max="100" placeholder="Max %..." style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
        </div>
        
        <!-- Min Errors -->
        <div>
            <label for="minErrorsFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Min Errors</label>
            <input type="number" id="minErrorsFilter" min="0" placeholder="Min errors..." style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
        </div>
        
        <!-- Max Errors -->
        <div>
            <label for="maxErrorsFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Max Errors</label>
            <input type="number" id="maxErrorsFilter" min="0" placeholder="Max errors..." style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
        </div>
        
        <!-- From Date -->
        <div>
            <label for="dateFromFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">From Date</label>
            <input type="date" id="dateFromFilter" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
        </div>
        
        <!-- To Date -->
        <div>
            <label for="dateToFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">To Date</label>
            <input type="date" id="dateToFilter" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
        </div>
        
        <!-- Validation Status -->
        <div>
            <label for="validationStatusFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Validation</label>
            <select id="validationStatusFilter" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
                <option value="">All Validation</option>
                <option value="Validated">Validated</option>
                <option value="Pending">Pending</option>
                <option value="Rejected">Rejected</option>
            </select>
        </div>
        
        <!-- Acknowledgement Status -->
        <div>
            <label for="acknowledgementStatusFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Acknowledgement</label>
            <select id="acknowledgementStatusFilter" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
                <option value="">All Status</option>
                <option value="Acknowledged">Acknowledged</option>
                <option value="Pending">Pending</option>
            </select>
        </div>
        
        <!-- Employee Pre Status -->
        <div>
            <label for="agentPreStatusFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Pre Status</label>
            <select id="agentPreStatusFilter" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
                <option value="">All Pre Status</option>
                <option value="No active quality concerns">No concerns</option>
                <option value="Pre-Quality">Pre-Quality</option>
                <option value="Quality Concern">Quality Concern</option>
                <option value="Performance Improvement Plan (PIP)">PIP</option>
                <option value="Performance Improvement Plan (PIP) - Alert">PIP Alert</option>
                <option value="Performance Improvement Plan (PIP) - Priority">PIP Priority</option>
            </select>
        </div>
        
        <!-- Employee Post Status -->
        <div>
            <label for="agentPostStatusFilter" style="font-size: 0.5156rem; font-weight: 500; color: #374151; margin-bottom: 0.0938rem; font-family: 'Poppins', sans-serif; display: block;">Post Status</label>
            <select id="agentPostStatusFilter" style="padding: 0.1875rem 0.2812rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.5156rem; font-family: 'Poppins', sans-serif; width: 100%;">
                <option value="">All Post Status</option>
                <option value="No active quality concerns">No concerns</option>
                <option value="Pre-Quality">Pre-Quality</option>
                <option value="Quality Concern">Quality Concern</option>
                <option value="Performance Improvement Plan (PIP)">PIP</option>
                <option value="Performance Improvement Plan (PIP) - Alert">PIP Alert</option>
                <option value="Performance Improvement Plan (PIP) - Priority">PIP Priority</option>
            </select>
        </div>
    </div>
</div>

    <div class="expert-audits-container" style="margin-top: 0;">
        <!-- Statistics Overview - Enhanced CX Metrics -->
        <div class="kpi-grid">
            <!-- Total Audits -->
            <div class="kpi-card" id="kpiCardTotal" data-filter-type="total">
                <div class="kpi-header">
                    <div class="kpi-label">Total Audits</div>
                    <div class="kpi-date" id="kpi0Date" style="display: none;">-</div>
                </div>
                <div class="kpi-value" id="totalAudits" style="color: #9333ea;">-</div>
                <div class="kpi-change" id="totalAuditsChange">All time</div>
                <div class="kpi-chart-container">
                    <canvas id="trendChart0"></canvas>
                </div>
            </div>

            <!-- Average Quality Score -->
            <div class="kpi-card" id="kpiCardAvgScore" data-filter-type="avgScore">
                <div class="kpi-header">
                    <div class="kpi-label">Avg Quality Score</div>
                    <div class="kpi-date" id="kpi1Date" style="display: none;">-</div>
                </div>
                <div class="kpi-value" id="avgQualityScore">-</div>
                <div class="kpi-change" id="avgQualityScoreChange">-</div>
                <div class="kpi-chart-container">
                    <canvas id="trendChart1"></canvas>
                </div>
            </div>

            <!-- Pass Rate -->
            <div class="kpi-card" id="kpiCardPassRate" data-filter-type="passed">
                <div class="kpi-header">
                    <div class="kpi-label">Pass Rate</div>
                    <div class="kpi-date" id="kpi2Date" style="display: none;">-</div>
                </div>
                <div class="kpi-value" id="passRate">-</div>
                <div class="kpi-change positive" id="passRateChange">-</div>
                <div class="kpi-chart-container">
                    <canvas id="trendChart2"></canvas>
            </div>
        </div>

            <!-- Critical Error Rate -->
            <div class="kpi-card" id="kpiCardCritical" data-filter-type="critical">
                <div class="kpi-header">
                    <div class="kpi-label">Critical Error Rate</div>
                    <div class="kpi-date" id="kpi3Date" style="display: none;">-</div>
            </div>
                <div class="kpi-value" id="criticalErrorRate" style="color: #ef4444;">-</div>
                <div class="kpi-change negative" id="criticalErrorCount">-</div>
                <div class="kpi-chart-container">
                    <canvas id="trendChart3"></canvas>
            </div>
        </div>

            <!-- Average Errors per Audit -->
            <div class="kpi-card" id="kpiCardAvgErrors" data-filter-type="errors">
                <div class="kpi-header">
                    <div class="kpi-label">Avg Errors/Audit</div>
                    <div class="kpi-date" id="kpi4Date" style="display: none;">-</div>
                </div>
                <div class="kpi-value" id="avgErrorsPerAudit" style="color: #f59e0b;">-</div>
                <div class="kpi-change negative" id="totalErrorsCount">-</div>
                <div class="kpi-chart-container">
                    <canvas id="trendChart4"></canvas>
                </div>
            </div>

            <!-- Reversal Rate -->
            <div class="kpi-card" id="kpiCardReversal" data-filter-type="reversal">
                <div class="kpi-header">
                    <div class="kpi-label">Reversal Rate</div>
                    <div class="kpi-date" id="kpi5Date" style="display: none;">-</div>
                </div>
                <div class="kpi-value" id="reversalRate" style="color: #f59e0b;">-</div>
                <div class="kpi-change negative" id="reversalCount">-</div>
                <div class="kpi-chart-container">
                    <canvas id="trendChart5"></canvas>
                </div>
            </div>

            <!-- Acknowledgement Pending Count -->
            <div class="kpi-card" id="kpiCardAcknowledgment" data-filter-type="acknowledgment">
                <div class="kpi-header">
                    <div class="kpi-label">Acknowledgement Pending Count</div>
                    <div class="kpi-date" id="kpi6Date" style="display: none;">-</div>
                </div>
                <div class="kpi-value" id="acknowledgmentRate" style="color: #f59e0b;">-</div>
                <div class="kpi-change positive" id="acknowledgmentCount">-</div>
                <div class="kpi-chart-container">
                    <canvas id="trendChart6"></canvas>
                </div>
            </div>

            <!-- Not Passed -->
            <div class="kpi-card" id="kpiCardNotPassed" data-filter-type="notPassed">
                <div class="kpi-header">
                    <div class="kpi-label">Not Passed</div>
                    <div class="kpi-date" id="kpi7Date" style="display: none;">-</div>
                </div>
                <div class="kpi-value" id="notPassingAudits" style="color: #ef4444;">-</div>
                <div class="kpi-change negative" id="notPassingAuditsChange">Needs attention</div>
                <div class="kpi-chart-container">
                    <canvas id="trendChart7"></canvas>
                </div>
            </div>
        </div>

    <!-- Audit List -->
    <div id="auditList" style="display: flex; flex-direction: column; gap: 0.5625rem; width: 100%;">
        <!-- Audits will be dynamically loaded here -->
    </div>

    <!-- Pagination Controls -->
    <div id="paginationContainer" style="display: none; margin-top: 1.125rem; padding: 0.75rem; background: #ffffff; border-radius: 0.375rem; border: 0.0469rem solid #e5e7eb; width: 100%;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem;">
            <div style="display: flex; align-items: center; gap: 0.375rem; font-size: 0.6562rem; color: #374151; font-family: 'Poppins', sans-serif;">
                <span>Showing</span>
                <select id="itemsPerPageSelect" style="padding: 0.1875rem 0.375rem; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.6562rem; font-family: 'Poppins', sans-serif; cursor: pointer;">
                    <option value="10">10</option>
                    <option value="25" selected>25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <span>items per page</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.375rem; font-size: 0.6562rem; color: #374151; font-family: 'Poppins', sans-serif;">
                <span id="paginationInfo">Page 1 of 1</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.375rem;">
                <button id="firstPageBtn" onclick="goToPage(1)" disabled style="padding: 0.375rem 0.5625rem; background-color: #ffffff; color: #374151; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.6562rem; font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.1875rem;" title="First Page">
                    <svg style="width: 0.75rem; height: 0.75rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="11 17 6 12 11 7"></polyline>
                        <polyline points="18 17 13 12 18 7"></polyline>
                    </svg>
                </button>
                <button id="prevPageBtn" onclick="goToPreviousPage()" disabled style="padding: 0.375rem 0.5625rem; background-color: #ffffff; color: #374151; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.6562rem; font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.1875rem;" title="Previous Page">
                    <svg style="width: 0.75rem; height: 0.75rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    <span>Previous</span>
                </button>
                <div id="pageNumbers" style="display: flex; align-items: center; gap: 0.1875rem;">
                    <!-- Page numbers will be dynamically generated here -->
                </div>
                <button id="nextPageBtn" onclick="goToNextPage()" disabled style="padding: 0.375rem 0.5625rem; background-color: #ffffff; color: #374151; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.6562rem; font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.1875rem;" title="Next Page">
                    <span>Next</span>
                    <svg style="width: 0.75rem; height: 0.75rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
                <button id="lastPageBtn" onclick="goToLastPage()" disabled style="padding: 0.375rem 0.5625rem; background-color: #ffffff; color: #374151; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.6562rem; font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.1875rem;" title="Last Page">
                    <svg style="width: 0.75rem; height: 0.75rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="13 17 18 12 13 7"></polyline>
                        <polyline points="6 17 11 12 6 7"></polyline>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- No Audits Message -->
    <div id="noAuditsMessage" style="display: none; text-align: center; padding: 1.5rem; color: #6b7280; font-family: 'Poppins', sans-serif; width: 100%;">
        <p style="font-size: 0.75rem; margin-bottom: 0.375rem;">No audits found</p>
        <p style="font-size: 0.6562rem;">Submit your first audit to see it here.</p>
    </div>
    </div>
</main>

<script>
// Audit Reports Functionality
document.addEventListener('DOMContentLoaded', function() {
    try {
        const auditList = document.getElementById('auditList');
        const noAuditsMessage = document.getElementById('noAuditsMessage');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const quarterFilter = document.getElementById('quarterFilter');
        const clearFilters = document.getElementById('clearFilters');
        const scorecardSelector = document.getElementById('scorecardSelector');
        const auditsCount = document.getElementById('auditsCount');
        
        // Verify critical elements exist
        if (!auditList) {
            console.error('auditList element not found!');
            return;
        }
        if (!scorecardSelector) {
            console.error('scorecardSelector element not found!');
            return;
        }
        
    let allAudits = [];
    let filteredAudits = [];
    let currentScorecard = null;
    let allScorecards = [];
    
    // User info and filtering state
    let currentUserEmail = '';
    let currentUserRole = '';
    let isAgent = false;
    let showAllAudits = false; // For employees, defaults to false (only show their audits)
    
    // Pagination state
    let currentPage = 1;
    let itemsPerPage = 25;
    let totalPages = 1;
    
    // KPI filter state
    let activeKpiFilter = null;
    
    // Chart instances for trend lines
    let trendCharts = {};
    
    // Week and date filter state
    let currentWeek = null;
    let currentWeekYear = null;
    let useWeekFilter = false; // Default to month view instead of week view
    let dateFilter = { start: null, end: null };
    
    // Cache configuration
    const CACHE_DURATION_MS = 5 * 60 * 1000; // 5 minutes cache duration
    
    // Cache helper functions
    function getCacheKey() {
        // Make cache user-specific
        const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
        const userEmail = (userInfo.email || 'anonymous').toLowerCase().trim();
        return `expert_audits_cache_${userEmail}`;
    }
    
    function getCacheTimestampKey() {
        const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
        const userEmail = (userInfo.email || 'anonymous').toLowerCase().trim();
        return `expert_audits_cache_timestamp_${userEmail}`;
    }
    
    function getCachedAudits() {
        try {
            const cacheKey = getCacheKey();
            const timestampKey = getCacheTimestampKey();
            const cachedData = localStorage.getItem(cacheKey);
            const cachedTimestamp = localStorage.getItem(timestampKey);
            
            if (!cachedData || !cachedTimestamp) {
                return null;
            }
            
            const timestamp = parseInt(cachedTimestamp, 10);
            const now = Date.now();
            
            // Check if cache is still valid
            if (now - timestamp > CACHE_DURATION_MS) {
                // Cache expired, clear it
                localStorage.removeItem(cacheKey);
                localStorage.removeItem(timestampKey);
                return null;
            }
            
            return JSON.parse(cachedData);
        } catch (error) {
            console.error('Error reading cache:', error);
            return null;
        }
    }
    
    function setCachedAudits(audits) {
        try {
            const cacheKey = getCacheKey();
            const timestampKey = getCacheTimestampKey();
            localStorage.setItem(cacheKey, JSON.stringify(audits));
            localStorage.setItem(timestampKey, Date.now().toString());
        } catch (error) {
            console.error('Error writing cache:', error);
            // If storage is full, try to clear old cache
            try {
                const cacheKey = getCacheKey();
                const timestampKey = getCacheTimestampKey();
                localStorage.removeItem(cacheKey);
                localStorage.removeItem(timestampKey);
            } catch (e) {
                // Ignore cleanup errors
            }
        }
    }
    
    function clearCache() {
        try {
            const cacheKey = getCacheKey();
            const timestampKey = getCacheTimestampKey();
            localStorage.removeItem(cacheKey);
            localStorage.removeItem(timestampKey);
        } catch (error) {
            console.error('Error clearing cache:', error);
        }
    }
    
    // Initialize user info
    function initializeUserInfo() {
        try {
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
            currentUserEmail = (userInfo.email || '').toLowerCase().trim();
            currentUserRole = userInfo.role || '';
            isAgent = currentUserRole === 'Employee';
            
            // Show "View All" button only for employees
            const viewAllBtn = document.getElementById('viewAllBtn');
            if (viewAllBtn) {
                viewAllBtn.style.display = isAgent ? 'block' : 'none';
            }
        } catch (error) {
            console.error('Error initializing user info:', error);
        }
    }
    
    // Toggle View All functionality for employees
    window.toggleViewAll = function() {
        if (!isAgent) return;
        
        showAllAudits = !showAllAudits;
        const viewAllBtn = document.getElementById('viewAllBtn');
        if (viewAllBtn) {
            if (showAllAudits) {
                viewAllBtn.textContent = 'Show My Audits Only';
                viewAllBtn.style.backgroundColor = '#1A733E';
                viewAllBtn.style.color = 'white';
                viewAllBtn.style.borderColor = '#1A733E';
            } else {
                viewAllBtn.textContent = 'View All';
                viewAllBtn.style.backgroundColor = '#f3f4f6';
                viewAllBtn.style.color = '#374151';
                viewAllBtn.style.borderColor = '#d1d5db';
            }
        }
        
        // Reset to first page and reload audits
        currentPage = 1;
        loadAudits();
    };
    
    // Load available scorecards
    async function loadScorecards() {
        try {
            const { data, error } = await window.supabaseClient
                .from('scorecards')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            allScorecards = data || [];
            
            // Build dropdown with "All Scorecards" as default
            scorecardSelector.innerHTML = '<option value="all">All Scorecards</option>';
            
            if (data && data.length > 0) {
                data.forEach(scorecard => {
                    const option = document.createElement('option');
                    option.value = scorecard.id;
                    option.textContent = scorecard.name + (scorecard.is_active ? '' : ' (Inactive)');
                    option.dataset.tableName = scorecard.table_name;
                    scorecardSelector.appendChild(option);
                });
            }
            
            // Default to "All Scorecards"
            scorecardSelector.value = 'all';
            currentScorecard = null;
            await loadAudits();
        } catch (error) {
            console.error('Error loading scorecards:', error);
            scorecardSelector.innerHTML = '<option value="all">All Scorecards</option><option value="">Error loading scorecards</option>';
            // Still try to load audits even if scorecards failed
            // The loadAudits function can use RPC to find tables directly
            await loadAudits();
        }
    }
    
    // Handle scorecard selection change
    scorecardSelector.addEventListener('change', async function() {
        const selectedId = this.value;
        
        // Reset pagination when changing scorecard
        currentPage = 1;
        
        if (selectedId === 'all') {
            // Show all scorecards
            currentScorecard = null;
            await loadAudits();
            return;
        }
        
        if (!selectedId) {
            currentScorecard = null;
            allAudits = [];
            filteredAudits = [];
            await renderAudits();
            return;
        }
        
        try {
            const { data, error } = await window.supabaseClient
                .from('scorecards')
                .select('*')
                .eq('id', selectedId)
                .single();
            
            if (error) throw error;
            
            currentScorecard = data;
            await loadAudits();
        } catch (error) {
            console.error('Error loading scorecard:', error);
        }
    });
    
    // Initialize user info first
    initializeUserInfo();
    
    // Hide auditor name filter for employees
    if (isAgent) {
        const auditorFilterContainer = document.getElementById('auditorNameFilterContainer');
        if (auditorFilterContainer) {
            auditorFilterContainer.style.display = 'none';
        }
    }
    
    // Initialize month filter (default view)
    initializeMonthFilter();
    
    // Setup event listeners for week navigation and date picker
    function setupHeaderActionListeners() {
        // Week navigation buttons
        const prevWeekBtn = document.getElementById('prevWeekBtn');
        const nextWeekBtn = document.getElementById('nextWeekBtn');
        const weekDisplay = document.getElementById('weekDisplay');
        
        if (prevWeekBtn) {
            prevWeekBtn.addEventListener('click', () => navigateWeek(-1));
        }
        if (nextWeekBtn) {
            nextWeekBtn.addEventListener('click', () => navigateWeek(1));
        }
        
        // Make week display clickable to switch to week view when in month view
        if (weekDisplay) {
            weekDisplay.addEventListener('click', function() {
                if (!useWeekFilter) {
                    switchToWeekView();
                }
            });
        }

        // Date button
        const dateBtn = document.getElementById('dateBtn');
        if (dateBtn) {
            dateBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const dropdown = document.getElementById('dateDropdown');
                if (dropdown) dropdown.classList.toggle('active');
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.date-picker-dropdown')) {
                const dropdown = document.getElementById('dateDropdown');
                if (dropdown) dropdown.classList.remove('active');
            }
        });

        // Filter button - toggle existing filter panel
        const filterBtn = document.getElementById('filterBtn');
        if (filterBtn) {
            filterBtn.addEventListener('click', () => {
                toggleFilters();
                filterBtn.classList.toggle('active');
            });
        }

        // Export button functionality is handled below in the export functionality section
    }
    
    // Setup listeners when DOM is ready
    setupHeaderActionListeners();
    setupKpiCardClickHandlers();
    
    // Wait for Supabase client to be ready, then initialize
    async function initializePage() {
        // Wait for Supabase to be ready
        let attempts = 0;
        while (!window.supabaseClient && attempts < 50) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
        }

        if (!window.supabaseClient) {
            console.error('Supabase client not available after waiting');
            // Show error message to user
            if (auditList) {
                auditList.innerHTML = '<div style="padding: 2rem; text-align: center; color: #ef4444;">Error: Could not connect to database. Please refresh the page.</div>';
            }
            return;
        }

    
    // Initialize scorecards (which will trigger loadAudits)
        try {
            await loadScorecards();
        } catch (error) {
            console.error('Error during initialization:', error);
            if (auditList) {
                auditList.innerHTML = '<div style="padding: 2rem; text-align: center; color: #ef4444;">Error loading audits. Please check the console for details.</div>';
            }
        }
    }
    
    // Start initialization
    initializePage();
    
    // Load audits from Supabase
    async function loadAudits(forceRefresh = false) {
        try {
            if (!window.supabaseClient) {
                console.error('Supabase client not initialized');
                return;
            }
            
            // Check cache first (unless force refresh)
            if (!forceRefresh) {
                const cachedAudits = getCachedAudits();
                if (cachedAudits && Array.isArray(cachedAudits) && cachedAudits.length >= 0) {
                    console.log('Loading audits from cache...');
                    allAudits = cachedAudits;
                    // Ensure filters are applied after loading from cache
                    // Use setTimeout to ensure DOM is ready and filters are initialized
                    setTimeout(() => {
                        filterAudits();
                    }, 0);
                    return;
                }
            }
            
            console.log('Loading audits from database...');
            let combinedAudits = [];
            
            // If no specific scorecard is selected, load from ALL scorecard tables
            if (!currentScorecard) {
                
                let tablesToQuery = [];
                
                // Step 1: Get all table names from the database that look like audit tables
                try {
                    const { data: allTables, error: tablesError } = await window.supabaseClient.rpc('get_audit_tables');
                    
                    if (tablesError) {
                        console.warn('Could not fetch table list via RPC, falling back to scorecard-based loading:', tablesError);
                        // Fallback: use known scorecards
                        if (allScorecards && allScorecards.length > 0) {
                            tablesToQuery = allScorecards
                                .filter(s => s.table_name !== 'ai_analysis_results') // Exclude AI analysis results
                                .map(s => ({
                            table_name: s.table_name,
                            scorecard_id: s.id,
                            scorecard_name: s.name,
                            scoring_type: s.scoring_type
                        }));
                    } else {
                            console.warn('No scorecards available and RPC failed. Cannot load audits.');
                            allAudits = [];
                            filteredAudits = [];
                            await renderAudits();
                            return;
                        }
                    } else {
                        // Match tables with scorecards where possible
                        if (allTables && allTables.length > 0) {
                            tablesToQuery = allTables
                                .filter(t => t.table_name !== 'ai_analysis_results') // Exclude AI analysis results
                                .map(t => {
                            const matchingScorecard = allScorecards.find(s => s.table_name === t.table_name);
                            return {
                                table_name: t.table_name,
                                scorecard_id: matchingScorecard?.id || null,
                                scorecard_name: matchingScorecard?.name || `Deleted Scorecard (${t.table_name})`,
                                scoring_type: matchingScorecard?.scoring_type || 'unknown'
                            };
                        });
                        } else if (allScorecards && allScorecards.length > 0) {
                            // If RPC returned empty but we have scorecards, use scorecards
                            tablesToQuery = allScorecards
                                .filter(s => s.table_name !== 'ai_analysis_results') // Exclude AI analysis results
                                .map(s => ({
                                table_name: s.table_name,
                                scorecard_id: s.id,
                                scorecard_name: s.name,
                                scoring_type: s.scoring_type
                            }));
                        } else {
                            console.warn('No tables found via RPC and no scorecards available.');
                            allAudits = [];
                            filteredAudits = [];
                            await renderAudits();
                            return;
                        }
                    }
                } catch (rpcError) {
                    console.warn('RPC call failed, using scorecard-based loading:', rpcError);
                    if (allScorecards && allScorecards.length > 0) {
                        tablesToQuery = allScorecards
                            .filter(s => s.table_name !== 'ai_analysis_results') // Exclude AI analysis results
                            .map(s => ({
                        table_name: s.table_name,
                        scorecard_id: s.id,
                        scorecard_name: s.name,
                        scoring_type: s.scoring_type
                    }));
                    } else {
                        console.error('No scorecards available and RPC failed. Cannot load audits.');
                        allAudits = [];
                        filteredAudits = [];
                        await renderAudits();
                        return;
                    }
                }
                
                // Step 2: Filter out ai_analysis_results table (additional safety check)
                tablesToQuery = tablesToQuery.filter(t => t.table_name !== 'ai_analysis_results');
                
                // Step 3: Load from all discovered tables
                for (const tableInfo of tablesToQuery) {
                    try {
                        let query = window.supabaseClient
                            .from(tableInfo.table_name)
                            .select('*')
                            .order('submitted_at', { ascending: false });
                        
                        // If employee and not showing all audits, filter by employee_email
                        if (isAgent && !showAllAudits && currentUserEmail) {
                            query = query.eq('employee_email', currentUserEmail);
                        }
                        
                        // Try to filter by audit_status, but handle errors gracefully
                        // Some tables may not have audit_status column
                        let data, error;
                        const result = await query;
                        data = result.data;
                        error = result.error;
                        
                        // If error and it's related to audit_status, try without the filter
                        if (error) {
                            // Check if error is about audit_status column
                            const errorMessage = error.message || JSON.stringify(error);
                            if (errorMessage.includes('audit_status') || error.code === 'PGRST116' || error.code === '42703') {
                                // Retry without audit_status filter
                                let retryQuery = window.supabaseClient
                                    .from(tableInfo.table_name)
                                    .select('*')
                                    .order('submitted_at', { ascending: false });
                                
                                if (isAgent && !showAllAudits && currentUserEmail) {
                                    retryQuery = retryQuery.eq('employee_email', currentUserEmail);
                                }
                                
                                const retryResult = await retryQuery;
                                data = retryResult.data;
                                error = retryResult.error;
                            }
                        
                        if (error) {
                            console.warn(`Error loading from ${tableInfo.table_name}:`, error);
                                continue; // Skip this table if error persists
                            }
                        }
                        
                        if (data && data.length > 0) {
                            // For employees, do additional client-side filtering to ensure exact match
                            // Also filter out incomplete audits (pending/in_progress)
                            let filteredData = data;
                            filteredData = filteredData.filter(audit => {
                                const auditStatus = audit.audit_status;
                                // Only include completed audits or audits without audit_status (legacy completed audits)
                                const isComplete = !auditStatus || auditStatus === 'completed';
                                if (!isComplete) return false;
                                
                                // Employee email filter
                                if (isAgent && !showAllAudits && currentUserEmail) {
                                    const auditEmployeeEmail = (audit.employee_email || '').toLowerCase().trim();
                                    return auditEmployeeEmail === currentUserEmail;
                                }
                                return true;
                            });
                            
                            // Add scorecard info to each audit
                            const auditsWithScorecard = filteredData.map(audit => ({
                                ...audit,
                                _scorecard_id: tableInfo.scorecard_id,
                                _scorecard_name: tableInfo.scorecard_name,
                                _scorecard_table: tableInfo.table_name,
                                _scoring_type: tableInfo.scoring_type
                            }));
                            combinedAudits = combinedAudits.concat(auditsWithScorecard);
                        }
                    } catch (err) {
                        console.warn(`Exception loading from ${tableInfo.table_name}:`, err);
                        continue;
                    }
                }
                
                // Sort by submitted_at descending
                combinedAudits.sort((a, b) => {
                    const dateA = toDhakaTime(a.submitted_at);
                    const dateB = toDhakaTime(b.submitted_at);
                    return dateB - dateA;
                });
            } else {
                // Load from specific scorecard table
                let query = window.supabaseClient
                    .from(currentScorecard.table_name)
                    .select('*')
                    .order('submitted_at', { ascending: false });
                
                // If employee and not showing all audits, filter by employee_email
                if (isAgent && !showAllAudits && currentUserEmail) {
                    query = query.eq('employee_email', currentUserEmail);
                }
                
                // Load data - filter audit_status client-side since some tables may not have this column
                let data, error;
                const result = await query;
                data = result.data;
                error = result.error;
                
                if (error) {
                    console.error('Error loading from Supabase:', error);
                    allAudits = [];
                    filteredAudits = [];
                    await renderAudits();
                    return;
                }
                
                let processedData = data || [];
                
                // Filter out incomplete audits and apply employee filter
                processedData = processedData.filter(audit => {
                    const auditStatus = audit.audit_status;
                    // Only include completed audits or audits without audit_status (legacy completed audits)
                    const isComplete = !auditStatus || auditStatus === 'completed';
                    if (!isComplete) return false;
                    
                    // For employees, do additional client-side filtering to ensure exact match
                    if (isAgent && !showAllAudits && currentUserEmail) {
                        const auditEmployeeEmail = (audit.employee_email || '').toLowerCase().trim();
                        return auditEmployeeEmail === currentUserEmail;
                    }
                    return true;
                });
                
                if (processedData.length > 0) {
                    // Add scorecard info to each audit
                    combinedAudits = processedData.map(audit => ({
                        ...audit,
                        _scorecard_id: currentScorecard.id,
                        _scorecard_name: currentScorecard.name,
                        _scorecard_table: currentScorecard.table_name,
                        _scoring_type: currentScorecard.scoring_type
                    }));
                }
            }
            
            if (combinedAudits.length > 0) {
                // Convert snake_case to camelCase for common fields, but preserve all original data
                allAudits = combinedAudits.map(audit => {
                    const mapped = {
                        // Keep ALL original fields (including dynamic error columns and scorecard info)
                        ...audit,
                        // Map common UI fields to camelCase
                    id: audit.id,
                    submittedAt: audit.submitted_at || audit.audit_timestamp,
                    auditTimestamp: audit.submitted_at || audit.audit_timestamp, // Using submitted_at for backward compatibility
                    auditDuration: audit.audit_duration,
                    auditorEmail: audit.auditor_email,
                    auditorName: audit.auditor_name,
                    employeeName: audit.employee_name,
                    employeeEmail: audit.employee_email,
                    employeeType: audit.employee_type,
                    interactionId: audit.interaction_id,
                    interactionDate: audit.interaction_date,
                    auditType: audit.audit_type,
                    channel: audit.channel,
                    quarter: audit.quarter,
                    week: audit.week,
                    countryOfEmployee: audit.country_of_employee,
                    clientEmail: audit.client_email,
                    agentPreStatus: audit.agent_pre_status,
                    agentPostStatus: audit.agent_post_status,
                    passingStatus: normalizePassingStatus(audit.passing_status),
                    validationStatus: audit.validation_status,
                    averageScore: audit.average_score,
                    criticalErrors: audit.critical_errors,
                    totalErrorsCount: audit.total_errors_count,
                    transcript: audit.transcript,
                    errorDescription: audit.error_description,
                    criticalFailError: audit.critical_fail_error,
                    criticalError: audit.critical_error,
                    significantError: audit.significant_error,
                    recommendations: audit.recommendations,
                    // Reversal tracking fields
                    reversalRequestedAt: audit.reversal_requested_at,
                    reversalRespondedAt: audit.reversal_responded_at,
                    slaInHours: audit.sla_in_hours,
                    reasonForReversalResponseDelay: audit.response_from_auditor,
                    reversalApproved: audit.reversal_approved,
                    withinAuditorScope: audit.within_auditor_scope,
                    scoreBeforeAppeal: audit.score_before_appeal,
                    scoreAfterAppeal: audit.score_after_appeal,
                    didResultInPass: audit.did_result_in_pass,
                    reversalType: audit.reversal_type,
                    reversalMetricsParameters: audit.reversal_metrics_parameters,
                    reversalJustificationFromAgent: audit.reversal_justification_from_agent,
                    reversalAttachments: audit.reversal_attachments,
                    reversalApprovedBy: audit.reversal_approved_by,
                    reversalResolvedBy: audit.reversal_resolved_by,
                    // Acknowledgement tracking fields
                    acknowledgementStatus: audit.acknowledgement_status,
                    acknowledgementStatusUpdatedAt: audit.acknowledgement_status_updated_at
                    };
                    return mapped;
                });
            } else {
                allAudits = [];
            }
            
            // Save to cache
            setCachedAudits(allAudits);
            
            // Update acknowledgment badge in sidebar
            if (window.updateAcknowledgmentBadgeCount) {
                window.updateAcknowledgmentBadgeCount();
            }
            
            // Apply filters (which will update statistics and render)
            filterAudits();
        } catch (error) {
            console.error('Error loading audits:', error);
            console.error('Stack trace:', error.stack);
            allAudits = [];
            filteredAudits = [];
            
            // Clear cache on error
            clearCache();
            
            // Show error in UI
            if (auditList) {
                auditList.innerHTML = `<div style="padding: 2rem; text-align: center; color: #ef4444;">
                    <p>Error loading audits: ${error.message}</p>
                    <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">Please check the console for more details.</p>
                </div>`;
            }
            
            // Still apply filters to update statistics (will be empty)
            filterAudits();
        }
    }
    
    // Cache for scorecard parameters to avoid repeated queries
    let scorecardParametersCache = {};
    
    // Load scorecard parameters for a scorecard
    async function loadScorecardParameters(scorecardId) {
        if (!scorecardId) return [];
        
        // Check cache first
        if (scorecardParametersCache[scorecardId]) {
            return scorecardParametersCache[scorecardId];
        }
        
        try {
            const { data: parameters, error } = await window.supabaseClient
                .from('scorecard_parameters')
                .select('*')
                .eq('scorecard_id', scorecardId)
                .eq('is_active', true);
            
            if (error) {
                console.warn(`Error loading parameters for scorecard ${scorecardId}:`, error);
                return [];
            }
            
            // Cache the result
            scorecardParametersCache[scorecardId] = parameters || [];
            return scorecardParametersCache[scorecardId];
        } catch (err) {
            console.warn(`Exception loading parameters for scorecard ${scorecardId}:`, err);
            return [];
        }
    }
    
    // Calculate critical error count for a single audit
    async function calculateCriticalErrorCount(audit) {
        const scorecardId = audit._scorecard_id;
        if (!scorecardId) return 0;
        
        const parameters = await loadScorecardParameters(scorecardId);
        if (parameters.length === 0) return 0;
        
        let criticalErrorCount = 0;
        
        parameters.forEach(param => {
            // Only count error parameters (not achievements/bonuses)
            if (param.parameter_type !== 'error') return;
            
            // Check if this is a Critical Fail or Critical error
            const isCriticalFail = param.error_category && param.error_category.includes('Fail');
            const isCritical = param.error_category && param.error_category.includes('Critical') && !isCriticalFail;
            
            if (isCriticalFail || isCritical) {
                const fieldKey = param.field_id;
                const value = audit[fieldKey];
                
                if (value !== null && value !== undefined && value !== '') {
                    if (param.field_type === 'radio') {
                        // For radio buttons, count 1 if yes/true
                        const isYes = value === 1 || value === true || value === 'true' || value === '1';
                        if (isYes) criticalErrorCount += 1;
                    } else {
                        // For counters, add the count
                        const count = parseInt(value) || 0;
                        criticalErrorCount += count;
                    }
                }
            }
        });
        
        return criticalErrorCount;
    }
    
    // Update statistics with comprehensive CX metrics
    async function updateStatistics(auditsForStats = null) {
        // Use provided audits or filteredAudits (before KPI filter)
        // This ensures statistics always show totals based on all filters EXCEPT KPI filter
        const statsAudits = auditsForStats || filteredAudits;
        
        const total = statsAudits.length;
        const passing = statsAudits.filter(a => normalizePassingStatus(a.passingStatus) === 'Passed').length;
        const notPassing = statsAudits.filter(a => normalizePassingStatus(a.passingStatus) === 'Not Passed').length;
        
        // Calculate Average Quality Score
        const auditsWithScores = statsAudits.filter(a => a.averageScore != null && a.averageScore !== '');
        const avgScore = auditsWithScores.length > 0
            ? Math.round(auditsWithScores.reduce((sum, a) => sum + (parseFloat(a.averageScore) || 0), 0) / auditsWithScores.length)
            : 0;
        
        // Calculate Pass Rate
        const passRate = total > 0 ? Math.round((passing / total) * 100) : 0;
        
        // Calculate Critical Error Rate (total critical error count / total error count)
        let totalCriticalErrors = 0;
        let totalErrors = 0;
        let criticalErrorAuditsCount = 0;
        
        // Load parameters for all unique scorecards in statsAudits
        const uniqueScorecardIds = [...new Set(statsAudits.map(a => a._scorecard_id).filter(id => id))];
        await Promise.all(uniqueScorecardIds.map(id => loadScorecardParameters(id)));
        
        // Calculate critical errors and total errors for each audit
        for (const audit of statsAudits) {
            const criticalCount = await calculateCriticalErrorCount(audit);
            totalCriticalErrors += criticalCount;
            
            const auditTotalErrors = parseInt(audit.totalErrorsCount) || 0;
            totalErrors += auditTotalErrors;
            
            // Count audits with critical errors for display purposes
            if (criticalCount > 0) criticalErrorAuditsCount++;
        }
        
        const criticalErrorRate = totalErrors > 0 ? Math.round((totalCriticalErrors / totalErrors) * 100) : 0;
        
        // Calculate Average Errors per Audit
        const avgErrorsPerAudit = total > 0 ? (totalErrors / total).toFixed(1) : '0.0';
        
        // Calculate Reversal Rate
        const reversals = statsAudits.filter(a => {
            const reversalRequested = a.reversalRequestedAt || a.reversal_requested_at;
            return reversalRequested != null && reversalRequested !== '';
        });
        const reversalRate = total > 0 ? Math.round((reversals.length / total) * 100) : 0;
        const pendingReversals = reversals.filter(a => {
            const reversalResponded = a.reversalRespondedAt || a.reversal_responded_at;
            return !reversalResponded || reversalResponded === '';
        }).length;
        
        // Calculate Acknowledgment Rate
        const acknowledged = statsAudits.filter(a => {
            const status = a.acknowledgementStatus || a.acknowledgement_status || '';
            return status && (
                status.toLowerCase().includes('acknowledged') || 
                status === 'Acknowledged'
            );
        });
        const acknowledgmentRate = total > 0 ? Math.round((acknowledged.length / total) * 100) : 0;
        const pendingAcknowledgments = total - acknowledged.length;
        
        // Update DOM elements
        const totalAuditsEl = document.getElementById('totalAudits');
        const passingAuditsEl = document.getElementById('passingAudits');
        const notPassingAuditsEl = document.getElementById('notPassingAudits');
        const avgQualityScoreEl = document.getElementById('avgQualityScore');
        const avgQualityScoreChangeEl = document.getElementById('avgQualityScoreChange');
        const passRateEl = document.getElementById('passRate');
        const passRateChangeEl = document.getElementById('passRateChange');
        const criticalErrorRateEl = document.getElementById('criticalErrorRate');
        const criticalErrorCountEl = document.getElementById('criticalErrorCount');
        const avgErrorsPerAuditEl = document.getElementById('avgErrorsPerAudit');
        const totalErrorsCountEl = document.getElementById('totalErrorsCount');
        const reversalRateEl = document.getElementById('reversalRate');
        const reversalCountEl = document.getElementById('reversalCount');
        const pendingReversalsEl = document.getElementById('pendingReversals');
        const acknowledgmentRateEl = document.getElementById('acknowledgmentRate');
        const acknowledgmentCountEl = document.getElementById('acknowledgmentCount');
        const pendingAcknowledgmentsEl = document.getElementById('pendingAcknowledgments');
        
        if (totalAuditsEl) totalAuditsEl.textContent = total.toLocaleString();
        if (passingAuditsEl) passingAuditsEl.textContent = passing.toLocaleString();
        if (notPassingAuditsEl) notPassingAuditsEl.textContent = notPassing.toLocaleString();
        if (avgQualityScoreEl) avgQualityScoreEl.textContent = `${avgScore}%`;
        if (avgQualityScoreChangeEl) {
            avgQualityScoreChangeEl.textContent = `Based on ${auditsWithScores.length} scored audits`;
            avgQualityScoreChangeEl.className = 'kpi-change';
        }
        if (passRateEl) passRateEl.textContent = `${passRate}%`;
        if (passRateChangeEl) {
            passRateChangeEl.textContent = `${passing.toLocaleString()} passed`;
            passRateChangeEl.className = 'kpi-change positive';
        }
        if (criticalErrorRateEl) criticalErrorRateEl.textContent = `${criticalErrorRate}%`;
        if (criticalErrorCountEl) {
            criticalErrorCountEl.textContent = `${totalCriticalErrors.toLocaleString()} critical errors of ${totalErrors.toLocaleString()} total`;
            criticalErrorCountEl.className = 'kpi-change negative';
        }
        if (avgErrorsPerAuditEl) avgErrorsPerAuditEl.textContent = avgErrorsPerAudit;
        if (totalErrorsCountEl) {
            totalErrorsCountEl.textContent = `Total: ${totalErrors.toLocaleString()} errors`;
            totalErrorsCountEl.className = 'kpi-change negative';
        }
        if (reversalRateEl) reversalRateEl.textContent = `${reversalRate}%`;
        if (reversalCountEl) {
            reversalCountEl.textContent = `${reversals.length.toLocaleString()} reversals (${pendingReversals.toLocaleString()} pending)`;
            reversalCountEl.className = 'kpi-change negative';
        }
        if (acknowledgmentRateEl) acknowledgmentRateEl.textContent = pendingAcknowledgments.toLocaleString();
        if (acknowledgmentCountEl) {
            acknowledgmentCountEl.textContent = `Acknowledged: ${acknowledged.length.toLocaleString()} out of ${total.toLocaleString()}`;
            acknowledgmentCountEl.className = 'kpi-change positive';
        }
        if (notPassingAuditsEl) notPassingAuditsEl.textContent = notPassing.toLocaleString();
        
        // Update trend charts using the same audits for consistency
        await updateTrendCharts(statsAudits);
    }
    
    // Calculate and update trend charts for all metrics
    async function updateTrendCharts(auditsForTrends = null) {
        if (typeof Chart === 'undefined') {
            console.warn('Chart.js not loaded, skipping trend charts');
            return;
        }
        
        // Use provided audits or filteredAudits (before KPI filter)
        const trendsAudits = auditsForTrends || filteredAudits;
        
        // Generate smooth trend data based on actual trend direction (matching employee-performance.html style)
        const generateData = (trend) => {
            const data = [];
            let value = 50;
            for (let i = 0; i < 7; i++) {
                value += trend ? Math.random() * 10 - 2 : Math.random() * 10 - 8;
                data.push(Math.max(0, Math.min(100, value)));
            }
            return data;
        };
        
        // Calculate actual trends from real data for last 7 days
        const today = getDhakaNow();
        const trendValues = {
            totalAudits: [],
            avgQualityScore: [],
            passRate: [],
            criticalErrorRate: [],
            avgErrorsPerAudit: [],
            reversalRate: [],
            acknowledgmentRate: [],
            notPassed: []
        };
        
        // Get last 7 days of data - use trendsAudits to respect week/date filter but not KPI filter
        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dhakaDate = getDhakaStartOfDay(date);
            const nextDate = new Date(dhakaDate);
            nextDate.setDate(nextDate.getDate() + 1);
            const dhakaNextDate = getDhakaStartOfDay(nextDate);
            
            // Filter audits for this day from trendsAudits (which already respects week/date filter)
            const dayAudits = trendsAudits.filter(a => {
                const submitted = toDhakaTime(a.submittedAt || a.submitted_at);
                return submitted >= dhakaDate && submitted < dhakaNextDate;
            });
            
            const dayTotal = dayAudits.length;
            const dayPassing = dayAudits.filter(a => normalizePassingStatus(a.passingStatus) === 'Passed').length;
            const dayNotPassing = dayAudits.filter(a => normalizePassingStatus(a.passingStatus) === 'Not Passed').length;
            
            // Calculate metrics for this day
            const dayAuditsWithScores = dayAudits.filter(a => a.averageScore != null && a.averageScore !== '');
            const dayAvgScore = dayAuditsWithScores.length > 0
                ? dayAuditsWithScores.reduce((sum, a) => sum + (parseFloat(a.averageScore) || 0), 0) / dayAuditsWithScores.length
                : 0;
            
            const dayPassRate = dayTotal > 0 ? (dayPassing / dayTotal) * 100 : 0;
            
            // Calculate critical error rate for this day (critical errors / total errors)
            let dayCriticalErrorCount = 0;
            let dayTotalErrorCount = 0;
            for (const audit of dayAudits) {
                const criticalCount = await calculateCriticalErrorCount(audit);
                dayCriticalErrorCount += criticalCount;
                dayTotalErrorCount += parseInt(audit.totalErrorsCount) || 0;
            }
            const dayCriticalErrorRate = dayTotalErrorCount > 0 ? (dayCriticalErrorCount / dayTotalErrorCount) * 100 : 0;
            
            const dayTotalErrors = dayAudits.reduce((sum, a) => sum + (parseInt(a.totalErrorsCount) || 0), 0);
            const dayAvgErrors = dayTotal > 0 ? dayTotalErrors / dayTotal : 0;
            
            const dayReversals = dayAudits.filter(a => {
                const reversalRequested = a.reversalRequestedAt || a.reversal_requested_at;
                return reversalRequested != null && reversalRequested !== '';
            }).length;
            const dayReversalRate = dayTotal > 0 ? (dayReversals / dayTotal) * 100 : 0;
            
            const dayAcknowledged = dayAudits.filter(a => {
                const status = a.acknowledgementStatus || a.acknowledgement_status || '';
                return status && (status.toLowerCase().includes('acknowledged') || status === 'Acknowledged');
            }).length;
            const dayAcknowledgmentRate = dayTotal > 0 ? (dayAcknowledged / dayTotal) * 100 : 0;
            
            // Store raw values
            trendValues.totalAudits.push(dayTotal);
            trendValues.avgQualityScore.push(dayAvgScore);
            trendValues.passRate.push(dayPassRate);
            trendValues.criticalErrorRate.push(dayCriticalErrorRate);
            trendValues.avgErrorsPerAudit.push(dayAvgErrors);
            trendValues.reversalRate.push(dayReversalRate);
            trendValues.acknowledgmentRate.push(dayAcknowledgmentRate);
            trendValues.notPassed.push(dayNotPassing);
        }
        
        // Determine actual trend directions from real data
        const getTrend = (data) => {
            if (data.length < 2) return true;
            // Compare first half average to second half average for more reliable trend
            const firstHalf = data.slice(0, Math.ceil(data.length / 2));
            const secondHalf = data.slice(Math.ceil(data.length / 2));
            const firstAvg = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
            const secondAvg = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;
            return secondAvg >= firstAvg;
        };
        
        const trends = {
            totalAudits: getTrend(trendValues.totalAudits),
            avgQualityScore: getTrend(trendValues.avgQualityScore),
            passRate: getTrend(trendValues.passRate),
            criticalErrorRate: !getTrend(trendValues.criticalErrorRate), // Inverted - lower is better
            avgErrorsPerAudit: !getTrend(trendValues.avgErrorsPerAudit), // Inverted - lower is better
            reversalRate: !getTrend(trendValues.reversalRate), // Inverted - lower is better
            acknowledgmentRate: getTrend(trendValues.acknowledgmentRate),
            notPassed: !getTrend(trendValues.notPassed) // Inverted - lower is better
        };
        
        // Chart configuration - exactly matching employee-performance.html
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { enabled: false } },
            scales: { x: { display: false }, y: { display: false } },
            elements: { point: { radius: 0 }, line: { borderWidth: 2 } }
        };
        
        // Create/update charts with smooth trend data based on actual trends
        const chartConfigs = [
            { 
                id: 'trendChart0', 
                trend: trends.totalAudits,
                borderColor: '#9333ea',
                backgroundColor: 'rgba(147, 51, 234, 0.1)'
            },
            { 
                id: 'trendChart1', 
                trend: trends.avgQualityScore,
                borderColor: trends.avgQualityScore ? '#10b981' : '#ef4444',
                backgroundColor: trends.avgQualityScore ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'
            },
            { 
                id: 'trendChart2', 
                trend: trends.passRate,
                borderColor: trends.passRate ? '#10b981' : '#ef4444',
                backgroundColor: trends.passRate ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'
            },
            { 
                id: 'trendChart3', 
                trend: trends.criticalErrorRate,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)'
            },
            { 
                id: 'trendChart4', 
                trend: trends.avgErrorsPerAudit,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)'
            },
            { 
                id: 'trendChart5', 
                trend: trends.reversalRate,
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)'
            },
            { 
                id: 'trendChart6', 
                trend: trends.acknowledgmentRate,
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)'
            },
            { 
                id: 'trendChart7', 
                trend: trends.notPassed,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)'
            }
        ];
        
        chartConfigs.forEach((config) => {
            const canvas = document.getElementById(config.id);
            if (!canvas) return;
            
            // Destroy existing chart if it exists
            if (trendCharts[config.id]) {
                trendCharts[config.id].destroy();
            }
            
            trendCharts[config.id] = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: Array(7).fill(''),
                    datasets: [{
                        data: generateData(config.trend),
                        borderColor: config.borderColor,
                        backgroundColor: config.backgroundColor,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: chartOptions
            });
        });
    }
    
    // Calculate pagination
    function calculatePagination() {
        totalPages = Math.ceil(filteredAudits.length / itemsPerPage);
        if (currentPage > totalPages && totalPages > 0) {
            currentPage = totalPages;
        }
        if (currentPage < 1) {
            currentPage = 1;
        }
    }
    
    // Get paginated audits
    function getPaginatedAudits() {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        return filteredAudits.slice(startIndex, endIndex);
    }
    
    // Update pagination UI
    function updatePaginationUI() {
        const paginationContainer = document.getElementById('paginationContainer');
        const paginationInfo = document.getElementById('paginationInfo');
        const pageNumbers = document.getElementById('pageNumbers');
        const firstPageBtn = document.getElementById('firstPageBtn');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const lastPageBtn = document.getElementById('lastPageBtn');
        
        if (filteredAudits.length === 0) {
            if (paginationContainer) paginationContainer.style.display = 'none';
            return;
        }
        
        if (paginationContainer) {
            paginationContainer.style.display = 'flex';
        }
        
        // Update pagination info
        const startIndex = (currentPage - 1) * itemsPerPage + 1;
        const endIndex = Math.min(currentPage * itemsPerPage, filteredAudits.length);
        if (paginationInfo) {
            paginationInfo.textContent = `Page ${currentPage} of ${totalPages} (Showing ${startIndex}-${endIndex} of ${filteredAudits.length})`;
        }
        
        // Update button states
        if (firstPageBtn) {
            firstPageBtn.disabled = currentPage === 1;
            firstPageBtn.style.opacity = currentPage === 1 ? '0.5' : '1';
            firstPageBtn.style.cursor = currentPage === 1 ? 'not-allowed' : 'pointer';
        }
        if (prevPageBtn) {
            prevPageBtn.disabled = currentPage === 1;
            prevPageBtn.style.opacity = currentPage === 1 ? '0.5' : '1';
            prevPageBtn.style.cursor = currentPage === 1 ? 'not-allowed' : 'pointer';
        }
        if (nextPageBtn) {
            nextPageBtn.disabled = currentPage === totalPages;
            nextPageBtn.style.opacity = currentPage === totalPages ? '0.5' : '1';
            nextPageBtn.style.cursor = currentPage === totalPages ? 'not-allowed' : 'pointer';
        }
        if (lastPageBtn) {
            lastPageBtn.disabled = currentPage === totalPages;
            lastPageBtn.style.opacity = currentPage === totalPages ? '0.5' : '1';
            lastPageBtn.style.cursor = currentPage === totalPages ? 'not-allowed' : 'pointer';
        }
        
        // Generate page numbers
        if (pageNumbers) {
            pageNumbers.innerHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // Adjust start page if we're near the end
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // First page
            if (startPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.textContent = '1';
                firstBtn.onclick = () => goToPage(1);
                firstBtn.style.cssText = 'padding: 0.375rem 0.5625rem; background-color: #ffffff; color: #374151; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.6562rem; font-family: \'Poppins\', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.2s ease;';
                pageNumbers.appendChild(firstBtn);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.cssText = 'padding: 0.375rem 0.1875rem; color: #6b7280; font-size: 0.6562rem;';
                    pageNumbers.appendChild(ellipsis);
                }
            }
            
            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i.toString();
                pageBtn.onclick = () => goToPage(i);
                if (i === currentPage) {
                    pageBtn.style.cssText = 'padding: 0.375rem 0.5625rem; background-color: #1A733E; color: #ffffff; border: 0.0469rem solid #1A733E; border-radius: 0.1875rem; font-size: 0.6562rem; font-family: \'Poppins\', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.2s ease;';
                } else {
                    pageBtn.style.cssText = 'padding: 0.375rem 0.5625rem; background-color: #ffffff; color: #374151; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.6562rem; font-family: \'Poppins\', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.2s ease;';
                }
                pageBtn.onmouseover = function() {
                    if (i !== currentPage) {
                        this.style.backgroundColor = '#f3f4f6';
                    }
                };
                pageBtn.onmouseout = function() {
                    if (i !== currentPage) {
                        this.style.backgroundColor = '#ffffff';
                    }
                };
                pageNumbers.appendChild(pageBtn);
            }
            
            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.cssText = 'padding: 0.375rem 0.1875rem; color: #6b7280; font-size: 0.6562rem;';
                    pageNumbers.appendChild(ellipsis);
                }
                
                const lastBtn = document.createElement('button');
                lastBtn.textContent = totalPages.toString();
                lastBtn.onclick = () => goToPage(totalPages);
                lastBtn.style.cssText = 'padding: 0.375rem 0.5625rem; background-color: #ffffff; color: #374151; border: 0.0469rem solid #d1d5db; border-radius: 0.1875rem; font-size: 0.6562rem; font-family: \'Poppins\', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.2s ease;';
                pageNumbers.appendChild(lastBtn);
            }
        }
    }
    
    // Pagination navigation functions
    window.goToPage = async function(page) {
        if (page >= 1 && page <= totalPages && page !== currentPage) {
            currentPage = page;
            await renderAudits();
            // Scroll to top of audit list
            const auditList = document.getElementById('auditList');
            if (auditList) {
                auditList.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    };
    
    window.goToPreviousPage = function() {
        if (currentPage > 1) {
            goToPage(currentPage - 1);
        }
    };
    
    window.goToNextPage = function() {
        if (currentPage < totalPages) {
            goToPage(currentPage + 1);
        }
    };
    
    window.goToLastPage = function() {
        if (totalPages > 0) {
            goToPage(totalPages);
        }
    };
    
    // Render audits
    async function renderAudits() {
        
        await updateStatistics();
        calculatePagination();
        
        // Update audits count display
        if (auditsCount) {
            const count = filteredAudits.length;
            auditsCount.textContent = `${count} audit${count !== 1 ? 's' : ''}`;
        }
        
        if (filteredAudits.length === 0) {
            auditList.style.display = 'none';
            noAuditsMessage.style.display = 'block';
            updatePaginationUI();
            return;
        }
        
        auditList.style.display = 'flex';
        noAuditsMessage.style.display = 'none';
        
        // Get paginated audits
        const paginatedAudits = getPaginatedAudits();
        const auditCards = paginatedAudits.map(audit => createAuditCard(audit));
        auditList.innerHTML = auditCards.join('');
        
        // Update pagination UI
        updatePaginationUI();
    }
    
    // Helper function to normalize passing status (handles both old and new values)
    function normalizePassingStatus(status) {
        if (!status) return status;
        // Convert old values to new ones for consistency
        if (status === 'Passing' || status === 'Pass') return 'Passed';
        if (status === 'Not Passing') return 'Not Passed';
        return status; // Return as-is if already normalized or unknown
    }
    
    // Helper function to get initials
    function getInitials(name) {
        if (!name) return '?';
        return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    }
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Helper function to get acknowledgment status chip
    function getAcknowledgmentStatusChip(audit) {
        const acknowledgementStatus = audit.acknowledgementStatus || audit.acknowledgement_status || '';
        
        // Check if acknowledged
        const isAcknowledged = acknowledgementStatus && (
            acknowledgementStatus.toLowerCase().includes('acknowledged') || 
            acknowledgementStatus === 'Acknowledged'
        );
        
        // Check if pending
        const isPending = acknowledgementStatus && (
            acknowledgementStatus.toLowerCase() === 'pending' || 
            acknowledgementStatus === 'Pending'
        );
        
        // If no status or empty, default to pending (since audits are created with pending by default)
        if (!acknowledgementStatus || acknowledgementStatus.trim() === '') {
            return `<span style="background-color: #fef3c7; color: #92400e; padding: 0.0938rem 0.375rem; border-radius: 0.1875rem; font-size: 0.5156rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.1875rem;">
                <svg style="width: 0.5625rem; height: 0.5625rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Acknowledgement Pending
            </span>`;
        }
        
        if (isAcknowledged) {
            return `<span style="background-color: #dcfce7; color: #166534; padding: 0.0938rem 0.375rem; border-radius: 0.1875rem; font-size: 0.5156rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.1875rem;">
                <svg style="width: 0.5625rem; height: 0.5625rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Acknowledged
            </span>`;
        }
        
        if (isPending) {
            return `<span style="background-color: #fef3c7; color: #92400e; padding: 0.0938rem 0.375rem; border-radius: 0.1875rem; font-size: 0.5156rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.1875rem;">
                <svg style="width: 0.5625rem; height: 0.5625rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Acknowledgement Pending
            </span>`;
        }
        
        // Default: show pending if status is unknown
        return `<span style="background-color: #fef3c7; color: #92400e; padding: 0.0938rem 0.375rem; border-radius: 0.1875rem; font-size: 0.5156rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.1875rem;">
            <svg style="width: 0.5625rem; height: 0.5625rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Acknowledgement Pending
        </span>`;
    }
    
    // Date formatting helper
    function formatCardDate(dateString) {
        if (!dateString) return 'N/A';
        const date = toDhakaTime(dateString);
        const now = getDhakaNow();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        
        return formatDhakaDate(date);
    }
    
    // Create audit card
    function createAuditCard(audit) {
        const submittedDateTime = formatCardDate(audit.submittedAt);
        const normalizedStatus = normalizePassingStatus(audit.passingStatus);
        const statusColor = normalizedStatus === 'Passed' ? '#10b981' : '#ef4444';
        const statusBgColor = normalizedStatus === 'Passed' ? '#dcfce7' : '#fee2e2';
        const statusTextColor = normalizedStatus === 'Passed' ? '#166534' : '#991b1b';
        const statusIcon = normalizedStatus === 'Passed' ? '' : '';
        
        // Check if reversal is pending (reversal_requested_at exists but reversal_responded_at is null)
        const reversalRequestedAt = audit.reversalRequestedAt || audit.reversal_requested_at;
        const reversalRespondedAt = audit.reversalRespondedAt || audit.reversal_responded_at;
        const isReversalPending = reversalRequestedAt && !reversalRespondedAt;
        
        // Get acknowledgment status chip
        const acknowledgmentStatusChip = getAcknowledgmentStatusChip(audit);
        
        // Check if current user is the auditor (for showing delete button)
        const auditAuditorEmail = (audit.auditorEmail || audit.auditor_email || '').toLowerCase().trim();
        const isAuditor = currentUserEmail && auditAuditorEmail === currentUserEmail;
        const deleteButtonHtml = isAuditor ? `
            <button 
                onclick="event.stopPropagation(); deleteAudit('${audit.id}', '${audit._scorecard_table || ''}', '${escapeHtml(audit.employeeName || audit.employee_name || 'Unknown')}', '${escapeHtml(audit.interactionId || audit.interaction_id || 'N/A')}')"
                style="padding: 0.375rem; background-color: #dc2626; color: white; border: none; border-radius: 0.1875rem; font-size: 0.5625rem; font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; width: 1.5rem; height: 1.5rem;"
                onmouseover="this.style.backgroundColor='#b91c1c'"
                onmouseout="this.style.backgroundColor='#dc2626'"
                title="Delete Audit"
            >
                <svg style="width: 0.75rem; height: 0.75rem; display: block;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
            </button>
        ` : '';
        
        // Create card element
        const cardHtml = `
            <div class="audit-card" style="background: #f9fafb; border: 0.0469rem solid ${isReversalPending ? '#fbbf24' : '#e5e7eb'}; border-radius: 0.1875rem; padding: 0.5625rem; transition: all 0.2s ease; display: flex; justify-content: space-between; align-items: center; gap: 0.5625rem; cursor: pointer; position: relative;" 
                 onclick="viewAuditDetails('${audit.id}')"
                 onmouseenter="this.style.borderColor='#1A733E'; this.style.backgroundColor='#ffffff';"
                 onmouseleave="this.style.borderColor='${isReversalPending ? '#fbbf24' : '#e5e7eb'}'; this.style.backgroundColor='#f9fafb';">
                
                <div style="flex: 1; display: flex; align-items: center; gap: 0.5625rem; pointer-events: none;">
                    <!-- Avatar with initials -->
                    <div style="width: 1.875rem; height: 1.875rem; border-radius: 0.1875rem; background: ${statusColor}; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.6562rem; flex-shrink: 0;">
                        ${getInitials(audit.employeeName || 'Unknown')}
                    </div>
                    
                    <!-- Employee info -->
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 0.375rem; margin-bottom: 0.1875rem; flex-wrap: wrap;">
                            <h4 style="margin: 0; font-size: 0.6562rem; font-weight: 600; color: #1f2937;">
                                ${escapeHtml(audit.employeeName || 'Unknown Employee')}
                            </h4>
                            ${isReversalPending ? `
                                <span style="background-color: #fef3c7; color: #92400e; padding: 0.0938rem 0.375rem; border-radius: 0.1875rem; font-size: 0.5156rem; font-weight: 600; border: 0.0469rem solid #fbbf24; display: flex; align-items: center; gap: 0.1875rem;">
                                    <svg style="width: 0.5625rem; height: 0.5625rem;" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                                    </svg>
                                    Reversal Pending
                                </span>
                            ` : ''}
                            ${audit._scorecard_name ? `
                                <span style="background-color: #f3f4f6; color: #374151; padding: 0.0938rem 0.375rem; border-radius: 0.1875rem; font-size: 0.4688rem; font-weight: 600; border: 0.0469rem solid #d1d5db;">
                                    ${escapeHtml(audit._scorecard_name)}
                                </span>
                            ` : ''}
                            <span style="background-color: ${statusBgColor}; color: ${statusTextColor}; padding: 0.0938rem 0.375rem; border-radius: 0.1875rem; font-size: 0.5156rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.1875rem;">
                                ${statusIcon} ${normalizedStatus || 'Unknown'}
                            </span>
                        </div>
                        <p style="margin: 0; font-size: 0.5625rem; color: #6b7280; display: flex; align-items: center; gap: 0.2812rem; flex-wrap: wrap;">
                            <span>${escapeHtml(audit.interactionId || 'No ID')}</span>
                            <span style="color: #d1d5db;"></span>
                            <span>${escapeHtml(audit.channel || 'No channel')}</span>
                            <span style="color: #d1d5db;"></span>
                                <span style="font-weight: 500;">${audit.averageScore || '0'}%</span>
                            <span style="color: #d1d5db;"></span>
                            <span>${audit.totalErrorsCount || '0'} errors</span>
                            ${!isAgent ? `<span style="color: #d1d5db;"></span>
                            <span style="color: #374151; font-weight: 500;">${escapeHtml(audit.auditorName || 'Unknown auditor')}</span>` : ''}
                            <span style="color: #d1d5db;"></span>
                            <span>${submittedDateTime}</span>
                        </p>
                    </div>
                </div>
                
                <!-- Action buttons -->
                <div style="display: flex; gap: 0.375rem; flex-shrink: 0; align-items: center; pointer-events: auto;">
                    ${acknowledgmentStatusChip}
                    <button 
                        onclick="event.stopPropagation(); viewAuditDetails('${audit.id}')"
                        style="padding: 0.375rem 0.75rem; background-color: #1A733E; color: white; border: none; border-radius: 0.1875rem; font-size: 0.5625rem; font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.2s ease; white-space: nowrap;"
                        onmouseover="this.style.backgroundColor='#15582E'"
                        onmouseout="this.style.backgroundColor='#1A733E'"
                    >
                        View Details
                    </button>
                    ${deleteButtonHtml}
                </div>
            </div>
        `;
        
        return cardHtml;
    }
    
    // Week filter functions
    function getWeekNumber(date = null) {
        if (!date) date = getDhakaNow();
        return getDhakaWeekNumber(date);
    }

    function getWeekDates(weekNumber, year) {
        return getDhakaWeekDates(weekNumber, year);
    }

    function initializeWeekFilter() {
        const today = getDhakaNow();
        currentWeek = getDhakaWeekNumber(today);
        currentWeekYear = today.getFullYear();
        updateWeekDisplay();
    }

    function initializeMonthFilter() {
        const today = getDhakaNow();
        const firstDay = getDhakaFirstDayOfMonth(today);
        const lastDay = getDhakaLastDayOfMonth(today);
        const firstDayStr = formatDhakaDateForInput(firstDay);
        const lastDayStr = formatDhakaDateForInput(lastDay);
        
        // Set date filter to current month
        dateFilter.start = firstDayStr;
        dateFilter.end = lastDayStr;
        useWeekFilter = false;
        
        // Update date input fields
        const startDateEl = document.getElementById('startDate');
        const endDateEl = document.getElementById('endDate');
        const dateBtnTextEl = document.getElementById('dateBtnText');
        
        if (startDateEl) startDateEl.value = firstDayStr;
        if (endDateEl) endDateEl.value = lastDayStr;
        
        // Update date button text to show current month
        if (dateBtnTextEl) {
            const start = formatDhakaDate(firstDay, { month: 'short', day: 'numeric' });
            const end = formatDhakaDate(lastDay, { month: 'short', day: 'numeric' });
            dateBtnTextEl.textContent = `${start} - ${end}`;
        }
        
        // Activate "This Month" button
        const quickDateButtons = document.querySelectorAll('.quick-date-btn');
        quickDateButtons.forEach(btn => btn.classList.remove('active'));
        const thisMonthBtn = document.getElementById('thisMonthBtn');
        if (thisMonthBtn) {
            thisMonthBtn.classList.add('active');
        }
        
        // Update week display to show it's disabled
        updateWeekDisplay();
    }

    function updateWeekDisplay() {
        const weekTextEl = document.getElementById('weekText');
        const prevWeekBtn = document.getElementById('prevWeekBtn');
        const nextWeekBtn = document.getElementById('nextWeekBtn');
        const weekDisplay = document.getElementById('weekDisplay');
        
        // Initialize current week if not set
        if (currentWeek === null) {
            const today = new Date();
            currentWeek = getWeekNumber(today);
            currentWeekYear = today.getFullYear();
        }
        
        if (weekTextEl) {
            if (useWeekFilter && currentWeek !== null) {
                weekTextEl.textContent = `Week ${currentWeek}`;
            } else {
                weekTextEl.textContent = `Week ${currentWeek || '-'}`;
            }
        }
        
        // Always enable week navigation buttons - they can switch to week view when clicked
        if (prevWeekBtn) {
            prevWeekBtn.disabled = false;
            prevWeekBtn.style.opacity = '1';
            prevWeekBtn.style.cursor = 'pointer';
        }
        
        if (nextWeekBtn) {
            nextWeekBtn.disabled = false;
            nextWeekBtn.style.opacity = '1';
            nextWeekBtn.style.cursor = 'pointer';
        }
        
        // Update week display styling
        if (weekDisplay) {
            if (useWeekFilter) {
                weekDisplay.style.backgroundColor = 'var(--primary-color)';
                weekDisplay.style.color = 'var(--white)';
                weekDisplay.style.borderColor = 'var(--primary-color)';
                weekDisplay.style.cursor = 'default';
            } else {
                weekDisplay.style.backgroundColor = '#f3f4f6';
                weekDisplay.style.color = '#6b7280';
                weekDisplay.style.borderColor = '#e5e7eb';
                weekDisplay.style.cursor = 'pointer';
            }
        }
    }

    function navigateWeek(direction) {
        // Initialize current week if not set
        if (currentWeek === null) {
            const today = new Date();
            currentWeek = getWeekNumber(today);
            currentWeekYear = today.getFullYear();
        }
        
        currentWeek += direction;
        
        if (currentWeek > 52) {
            currentWeek = 1;
            currentWeekYear += 1;
        } else if (currentWeek < 1) {
            currentWeek = 52;
            currentWeekYear -= 1;
        }
        
        // Switch to week view when navigating
        useWeekFilter = true;
        dateFilter.start = null;
        dateFilter.end = null;
        const startDateEl = document.getElementById('startDate');
        const endDateEl = document.getElementById('endDate');
        const dateBtnTextEl = document.getElementById('dateBtnText');
        if (startDateEl) startDateEl.value = '';
        if (endDateEl) endDateEl.value = '';
        if (dateBtnTextEl) dateBtnTextEl.textContent = 'Date Range';
        
        // Clear active state of quick filter buttons when switching to week view
        const quickDateButtons = document.querySelectorAll('.quick-date-btn');
        quickDateButtons.forEach(btn => btn.classList.remove('active'));
        
        updateWeekDisplay();
        updateClearAllButtonVisibility();
        filterAudits();
    }
    
    // Function to switch to week view when week display is clicked
    function switchToWeekView() {
        // Initialize current week if not set
        if (currentWeek === null) {
            const today = new Date();
            currentWeek = getWeekNumber(today);
            currentWeekYear = today.getFullYear();
        }
        
        useWeekFilter = true;
        dateFilter.start = null;
        dateFilter.end = null;
        const startDateEl = document.getElementById('startDate');
        const endDateEl = document.getElementById('endDate');
        const dateBtnTextEl = document.getElementById('dateBtnText');
        if (startDateEl) startDateEl.value = '';
        if (endDateEl) endDateEl.value = '';
        if (dateBtnTextEl) dateBtnTextEl.textContent = 'Date Range';
        
        // Clear active state of quick filter buttons when switching to week view
        const quickDateButtons = document.querySelectorAll('.quick-date-btn');
        quickDateButtons.forEach(btn => btn.classList.remove('active'));
        
        updateWeekDisplay();
        updateClearAllButtonVisibility();
        filterAudits();
    }

    window.applyDateFilter = function() {
        const startDateEl = document.getElementById('startDate');
        const endDateEl = document.getElementById('endDate');
        const startDate = startDateEl?.value || '';
        const endDate = endDateEl?.value || '';
        
        if (startDate) dateFilter.start = startDate;
        if (endDate) dateFilter.end = endDate;

        const dateBtnTextEl = document.getElementById('dateBtnText');
        if (startDate || endDate) {
            const start = startDate ? formatDhakaDate(parseDhakaDate(startDate), { month: 'short', day: 'numeric' }) : 'Start';
            const end = endDate ? formatDhakaDate(parseDhakaDate(endDate), { month: 'short', day: 'numeric' }) : 'End';
            if (dateBtnTextEl) dateBtnTextEl.textContent = `${start} - ${end}`;
            useWeekFilter = false;
            
            // Clear active state of quick filter buttons when using custom date range
            const quickDateButtons = document.querySelectorAll('.quick-date-btn');
            quickDateButtons.forEach(btn => btn.classList.remove('active'));
            
            updateWeekDisplay(); // Update week display to show "-"
        } else {
            // If both dates are cleared, reset to current month view
            initializeMonthFilter();
        }

        const dateDropdown = document.getElementById('dateDropdown');
        if (dateDropdown) dateDropdown.classList.remove('active');
        updateClearAllButtonVisibility();
        filterAudits();
    };

    window.clearDateFilter = function() {
        // Reset to current month view instead of week view
        initializeMonthFilter();
        const dateDropdown = document.getElementById('dateDropdown');
        if (dateDropdown) dateDropdown.classList.remove('active');
        updateClearAllButtonVisibility();
        filterAudits();
    };

    // Use shared date filter utility - wrap to provide page-specific callbacks
    const originalApplyQuickDateFilter = window.applyQuickDateFilter;
    window.applyQuickDateFilter = function(period) {
        originalApplyQuickDateFilter(period, {
            dateFilter: dateFilter,
            setUseWeekFilter: () => { useWeekFilter = false; },
            onUpdate: updateWeekDisplay,
            onRefresh: () => {
                updateClearAllButtonVisibility();
                filterAudits();
            }
        });
    };
    
    // Toggle filter panel
    window.toggleFilters = function() {
        const panel = document.getElementById('filterPanel');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
        } else {
            panel.style.display = 'none';
        }
    };
    
    // Filter audits
    async function filterAudits() {
        // Reset to first page when filters change
        currentPage = 1;
        
        const searchTerm = (searchInput?.value || '').toLowerCase();
        const statusValue = statusFilter?.value || '';
        const quarterValue = quarterFilter?.value || '';
        
        // Apply week or date filter first
        let dateFilteredAudits = [...allAudits];
        
        if (dateFilter.start || dateFilter.end) {
            useWeekFilter = false;
            dateFilteredAudits = dateFilteredAudits.filter(a => {
                const submittedDate = a.submittedAt || a.submitted_at;
                if (!submittedDate) return false;
                
                const submitted = toDhakaTime(submittedDate);
                if (isNaN(submitted.getTime())) return false; // Invalid date
                
                if (dateFilter.start) {
                    const startDate = getDhakaStartOfDay(parseDhakaDate(dateFilter.start));
                    if (submitted < startDate) return false;
                }
                if (dateFilter.end) {
                    const endDate = getDhakaEndOfDay(parseDhakaDate(dateFilter.end));
                    if (submitted > endDate) return false;
                }
                return true;
            });
        } else if (useWeekFilter && currentWeek !== null) {
            const weekDates = getWeekDates(currentWeek, currentWeekYear);
            dateFilteredAudits = dateFilteredAudits.filter(a => {
                const submittedDate = a.submittedAt || a.submitted_at;
                if (!submittedDate) return false;
                
                const submitted = toDhakaTime(submittedDate);
                if (isNaN(submitted.getTime())) return false; // Invalid date
                
                return submitted >= weekDates.start && submitted <= weekDates.end;
            });
        }
        
        filteredAudits = dateFilteredAudits.filter(audit => {
            // General search
            const matchesSearch = !searchTerm || 
                (audit.employeeName && audit.employeeName.toLowerCase().includes(searchTerm)) ||
                (audit.auditorName && audit.auditorName.toLowerCase().includes(searchTerm)) ||
                (audit.interactionId && audit.interactionId.toLowerCase().includes(searchTerm));
            
            // Specific filters
            const normalizedAuditStatus = normalizePassingStatus(audit.passingStatus);
            const matchesStatus = !statusValue || normalizedAuditStatus === statusValue;
            const matchesQuarter = !quarterValue || audit.quarter === quarterValue;
            
            // Get all other filter values
            const auditorFilter = (document.getElementById('auditorNameFilter')?.value || '').toLowerCase();
            const employeeFilter = (document.getElementById('employeeNameFilter')?.value || '').toLowerCase();
            const auditTypeFilter = document.getElementById('auditTypeFilter')?.value || '';
            const channelFilter = document.getElementById('channelFilter')?.value || '';
            const employeeTypeFilter = document.getElementById('employeeTypeFilter')?.value || '';
            const countryFilter = document.getElementById('countryFilter')?.value || '';
            const interactionIdFilter = (document.getElementById('interactionIdFilter')?.value || '').toLowerCase();
            const weekFilter = document.getElementById('weekFilter')?.value || '';
            const validationFilter = document.getElementById('validationStatusFilter')?.value || '';
            const acknowledgementFilter = document.getElementById('acknowledgementStatusFilter')?.value || '';
            const preStatusFilter = document.getElementById('agentPreStatusFilter')?.value || '';
            const postStatusFilter = document.getElementById('agentPostStatusFilter')?.value || '';
            
            // Apply filters
            const matchesAuditor = !auditorFilter || (audit.auditorName && audit.auditorName.toLowerCase().includes(auditorFilter));
            const matchesEmployee = !employeeFilter || (audit.employeeName && audit.employeeName.toLowerCase().includes(employeeFilter));
            const matchesAuditType = !auditTypeFilter || audit.auditType === auditTypeFilter;
            const matchesChannel = !channelFilter || audit.channel === channelFilter;
            const matchesEmployeeType = !employeeTypeFilter || audit.employeeType === employeeTypeFilter;
            const matchesCountry = !countryFilter || audit.countryOfEmployee === countryFilter;
            const matchesInteractionId = !interactionIdFilter || (audit.interactionId && audit.interactionId.toLowerCase().includes(interactionIdFilter));
            const matchesWeek = !weekFilter || audit.week === weekFilter;
            const matchesValidation = !validationFilter || audit.validationStatus === validationFilter;
            const matchesAcknowledgement = !acknowledgementFilter || (() => {
                const status = audit.acknowledgementStatus || audit.acknowledgement_status || '';
                if (acknowledgementFilter === 'Acknowledged') {
                    return status && (status.toLowerCase().includes('acknowledged') || status === 'Acknowledged');
                } else if (acknowledgementFilter === 'Pending') {
                    return !status || status.trim() === '' || status.toLowerCase() === 'pending' || status === 'Pending';
                }
                return true;
            })();
            const matchesPreStatus = !preStatusFilter || audit.agentPreStatus === preStatusFilter;
            const matchesPostStatus = !postStatusFilter || audit.agentPostStatus === postStatusFilter;
            
            // Score range filters
            const minScoreFilter = document.getElementById('minScoreFilter')?.value || '';
            const maxScoreFilter = document.getElementById('maxScoreFilter')?.value || '';
            const minErrorsFilter = document.getElementById('minErrorsFilter')?.value || '';
            const maxErrorsFilter = document.getElementById('maxErrorsFilter')?.value || '';
            
            const scoreValue = parseFloat(audit.averageScore) || 0;
            const matchesMinScore = !minScoreFilter || scoreValue >= parseFloat(minScoreFilter);
            const matchesMaxScore = !maxScoreFilter || scoreValue <= parseFloat(maxScoreFilter);
            
            const errorsValue = parseInt(audit.totalErrorsCount) || 0;
            const matchesMinErrors = !minErrorsFilter || errorsValue >= parseInt(minErrorsFilter);
            const matchesMaxErrors = !maxErrorsFilter || errorsValue <= parseInt(maxErrorsFilter);
            
            // Date range filters
            const dateFromFilter = document.getElementById('dateFromFilter')?.value || '';
            const dateToFilter = document.getElementById('dateToFilter')?.value || '';
            
            let matchesDateRange = true;
            if (dateFromFilter || dateToFilter) {
                const auditDate = toDhakaTime(audit.submittedAt);
                if (dateFromFilter) {
                    const fromDate = getDhakaStartOfDay(parseDhakaDate(dateFromFilter));
                    if (auditDate < fromDate) matchesDateRange = false;
                }
                if (dateToFilter) {
                    const toDate = getDhakaEndOfDay(parseDhakaDate(dateToFilter));
                    if (auditDate > toDate) matchesDateRange = false;
                }
            }
            
            // Apply KPI filter if active
            let matchesKpiFilter = true;
            if (activeKpiFilter) {
                switch (activeKpiFilter) {
                    case 'passed':
                        matchesKpiFilter = normalizePassingStatus(audit.passingStatus) === 'Passed';
                        break;
                    case 'notPassed':
                        matchesKpiFilter = normalizePassingStatus(audit.passingStatus) === 'Not Passed';
                        break;
                    case 'critical':
                        // Filter audits with critical errors - this will be checked asynchronously
                        matchesKpiFilter = true; // Will be filtered after async check
                        break;
                    case 'reversal':
                        const reversalRequested = audit.reversalRequestedAt || audit.reversal_requested_at;
                        matchesKpiFilter = reversalRequested != null && reversalRequested !== '';
                        break;
                    case 'acknowledgment':
                        // Filter for pending acknowledgments (not acknowledged)
                        const status = audit.acknowledgementStatus || audit.acknowledgement_status || '';
                        const isAcknowledged = status && (
                            status.toLowerCase().includes('acknowledged') || 
                            status === 'Acknowledged'
                        );
                        matchesKpiFilter = !isAcknowledged; // Show pending (not acknowledged)
                        break;
                    case 'errors':
                        // Filter audits with errors > 0
                        matchesKpiFilter = (parseInt(audit.totalErrorsCount) || 0) > 0;
                        break;
                    case 'total':
                    case 'avgScore':
                    default:
                        matchesKpiFilter = true; // No filter for these
                        break;
                }
            }
            
            return matchesSearch && matchesStatus && matchesQuarter &&
                   matchesAuditor && matchesEmployee && matchesAuditType &&
                   matchesChannel && matchesEmployeeType && matchesCountry &&
                   matchesInteractionId && matchesWeek && matchesValidation &&
                   matchesAcknowledgement && matchesPreStatus && matchesPostStatus && matchesMinScore &&
                   matchesMaxScore && matchesMinErrors && matchesMaxErrors &&
                   matchesDateRange && matchesKpiFilter;
        });
        
        // Store audits before KPI filter for statistics calculation
        // Statistics should always show totals based on all filters EXCEPT KPI filter
        const auditsBeforeKpiFilter = [...filteredAudits];
        
        // If critical filter is active, further filter by checking critical errors
        if (activeKpiFilter === 'critical') {
            // Load parameters for all unique scorecards
            const uniqueScorecardIds = [...new Set(filteredAudits.map(a => a._scorecard_id).filter(id => id))];
            await Promise.all(uniqueScorecardIds.map(id => loadScorecardParameters(id)));
            
            // Filter to only audits with critical errors
            const auditsWithCriticalErrors = [];
            for (const audit of filteredAudits) {
                const criticalCount = await calculateCriticalErrorCount(audit);
                if (criticalCount > 0) {
                    auditsWithCriticalErrors.push(audit);
                }
            }
            filteredAudits = auditsWithCriticalErrors;
        }
        
        // Update clear all button visibility
        updateClearAllButtonVisibility();
        
        // Update statistics using audits before KPI filter (so totals don't change)
        await updateStatistics(auditsBeforeKpiFilter);
        
        await renderAudits();
    }
    
    // Apply KPI filter when card is clicked
    async function applyKpiFilter(filterType) {
        // Toggle filter if clicking the same card
        if (activeKpiFilter === filterType) {
            activeKpiFilter = null;
        } else {
            activeKpiFilter = filterType;
        }
        
        // Update active state of all KPI cards
        document.querySelectorAll('.kpi-card').forEach(card => {
            const cardFilterType = card.getAttribute('data-filter-type');
            if (cardFilterType === activeKpiFilter) {
                card.classList.add('active');
            } else {
                card.classList.remove('active');
            }
        });
        
        // Update button visibility
        updateClearAllButtonVisibility();
        
        // Apply filters
        await filterAudits();
    }
    
    // Setup KPI card click handlers
    function setupKpiCardClickHandlers() {
        const kpiCards = document.querySelectorAll('.kpi-card[data-filter-type]');
        kpiCards.forEach(card => {
            card.addEventListener('click', function(e) {
                // Don't trigger if clicking on the chart canvas or chart container
                if (e.target.tagName === 'CANVAS' || 
                    e.target.closest('canvas') || 
                    e.target.closest('.kpi-chart-container')) {
                    return;
                }
                const filterType = this.getAttribute('data-filter-type');
                applyKpiFilter(filterType);
            });
        });
    }
    
    // Check if any filters are applied
    function hasActiveFilters() {
        // Check search input
        if (searchInput && searchInput.value.trim() !== '') return true;
        
        // Check status filter
        if (statusFilter && statusFilter.value !== '') return true;
        
        // Check quarter filter
        if (quarterFilter && quarterFilter.value !== '') return true;
        
        // Check all other filter inputs
        const filterInputs = document.querySelectorAll('input[id$="Filter"], select[id$="Filter"]');
        for (const input of filterInputs) {
            if (input.value && input.value.trim() !== '') return true;
        }
        
        // Check date filters
        if (dateFilter.start || dateFilter.end) return true;
        if (useWeekFilter && currentWeek !== null) return true;
        
        // Check KPI filter
        if (activeKpiFilter) return true;
        
        return false;
    }
    
    // Update clear all button visibility
    function updateClearAllButtonVisibility() {
        const clearAllBtn = document.getElementById('clearAllBtn');
        if (clearAllBtn) {
            clearAllBtn.style.display = hasActiveFilters() ? 'inline-flex' : 'none';
        }
    }
    
    // Clear all filters function
    async function clearAllFilters() {
            // Clear all filter inputs and selects
            document.querySelectorAll('input[id$="Filter"], select[id$="Filter"], #searchInput').forEach(input => {
                input.value = '';
            });
        
        // Clear KPI filter
        activeKpiFilter = null;
        document.querySelectorAll('.kpi-card').forEach(card => {
            card.classList.remove('active');
        });
        
        // Clear date filters
        dateFilter.start = null;
        dateFilter.end = null;
        useWeekFilter = false;
        currentWeek = null;
        currentWeekYear = null;
        
        // Reset date inputs
        const startDateEl = document.getElementById('startDate');
        const endDateEl = document.getElementById('endDate');
        const dateBtnTextEl = document.getElementById('dateBtnText');
        if (startDateEl) startDateEl.value = '';
        if (endDateEl) endDateEl.value = '';
        if (dateBtnTextEl) dateBtnTextEl.textContent = 'Date Range';
        
        // Reset to current month view
        initializeMonthFilter();
        
        // Update button visibility
        updateClearAllButtonVisibility();
        
        // Apply filters (which will show all audits)
        await filterAudits();
    }
    
    // Event listeners - simplified
    if (searchInput) {
        searchInput.addEventListener('input', () => {
            updateClearAllButtonVisibility();
            filterAudits();
        });
    }
    if (statusFilter) {
        statusFilter.addEventListener('change', () => {
            updateClearAllButtonVisibility();
            filterAudits();
        });
    }
    if (quarterFilter) {
        quarterFilter.addEventListener('change', () => {
            updateClearAllButtonVisibility();
            filterAudits();
        });
    }
    
    // Header clear all button
    const clearAllBtn = document.getElementById('clearAllBtn');
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', clearAllFilters);
    }
    
    // Panel clear filters button (inside filter panel)
    if (clearFilters) {
        clearFilters.addEventListener('click', clearAllFilters);
    }
    
    // Add event listeners for all additional filter inputs
    const additionalFilters = [
        'auditorNameFilter', 'employeeNameFilter', 'auditTypeFilter', 
        'channelFilter', 'employeeTypeFilter', 'countryFilter', 
        'interactionIdFilter', 'weekFilter', 'minScoreFilter', 
        'maxScoreFilter', 'minErrorsFilter', 'maxErrorsFilter', 
        'dateFromFilter', 'dateToFilter', 'validationStatusFilter', 
        'acknowledgementStatusFilter', 'agentPreStatusFilter', 'agentPostStatusFilter'
    ];
    
    additionalFilters.forEach(filterId => {
        const filterElement = document.getElementById(filterId);
        if (filterElement) {
            filterElement.addEventListener('input', () => {
                updateClearAllButtonVisibility();
                filterAudits();
            });
            filterElement.addEventListener('change', () => {
                updateClearAllButtonVisibility();
                filterAudits();
            });
        }
    });
    
    // Items per page change handler
    const itemsPerPageSelect = document.getElementById('itemsPerPageSelect');
    if (itemsPerPageSelect) {
        itemsPerPageSelect.addEventListener('change', async function() {
            itemsPerPage = parseInt(this.value);
            currentPage = 1; // Reset to first page when changing items per page
            await renderAudits();
        });
    }
    
    // Export functionality
    const exportBtnEl = document.getElementById('exportBtn');
    if (exportBtnEl) {
        exportBtnEl.addEventListener('click', function() {
        if (filteredAudits.length === 0) {
            alert('No audits to export. Please adjust your filters.');
            return;
        }
        
        // Convert audits to CSV format
        const headers = [
            'ID', 'Submitted At', 'Employee Name', ...(isAgent ? [] : ['Auditor Name']), 'Audit Type', 
            'Passed Status', 'Average Score', 'Total Errors', 'Quarter', 'Channel',
            'Interaction ID', 'Week', 'Country', 'Employee Type', 'Validation Status',
            'Employee Pre Status', 'Employee Post Status', 'Audit Duration'
        ];
        
        const csvContent = [
            headers.join(','),
            ...filteredAudits.map(audit => [
                audit.id || '',
                audit.submittedAt || '',
                audit.employeeName || '',
                ...(isAgent ? [] : [audit.auditorName || '']),
                audit.auditType || '',
                audit.passingStatus || '',
                audit.averageScore || '',
                audit.totalErrorsCount || '',
                audit.quarter || '',
                audit.channel || '',
                audit.interactionId || '',
                audit.week || '',
                audit.countryOfEmployee || '',
                audit.employeeType || '',
                audit.validationStatus || '',
                audit.agentPreStatus || '',
                audit.agentPostStatus || '',
                audit.auditDuration || ''
            ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))
        ].join('\n');
        
        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `expert-audits-${formatDhakaDateForInput(getDhakaNow())}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        });
    }
    
    // View audit details
    window.viewAuditDetails = function(auditId) {
        const audit = allAudits.find(a => a.id === auditId);
        if (audit) {
            // Navigate to dedicated audit view page
            const scorecardId = audit._scorecard_id || '';
            const tableName = audit._scorecard_table || '';
            window.location.href = `audit-view.html?id=${auditId}&scorecard=${scorecardId}&table=${tableName}`;
        }
    };
    
    // Delete audit
    window.deleteAudit = async function(auditId, tableName, employeeName, interactionId) {
        if (!auditId || !tableName) {
            alert('Error: Missing audit ID or table name');
            return;
        }
        
        // Verify that current user is the auditor
        const audit = allAudits.find(a => a.id === auditId);
        if (!audit) {
            alert('Error: Audit not found');
            return;
        }
        
        const auditAuditorEmail = (audit.auditorEmail || audit.auditor_email || '').toLowerCase().trim();
        if (!currentUserEmail || auditAuditorEmail !== currentUserEmail) {
            if (window.confirmationDialog) {
                await window.confirmationDialog.show({
                    title: 'Access Denied',
                    message: 'Only the auditor who created this audit can delete it.',
                    confirmText: 'OK',
                    type: 'error'
                });
            } else {
                alert('Only the auditor who created this audit can delete it.');
            }
            return;
        }
        
        // Show confirmation dialog
        const confirmed = await window.confirmationDialog.show({
            title: 'Delete Audit?',
            message: `Are you sure you want to delete this audit?\n\nEmployee: ${employeeName}\nInteraction ID: ${interactionId}\n\nThis action cannot be undone. The audit will be permanently deleted and any related assignments will be reset to pending.`,
            confirmText: 'Delete',
            cancelText: 'Cancel',
            type: 'warning'
        });
        
        if (!confirmed) return;
        
        try {
            // First, find and update audit_assignments that reference this audit
            const { data: assignments, error: assignmentsError } = await window.supabaseClient
                .from('audit_assignments')
                .select('id')
                .eq('audit_id', auditId);
            
            if (assignmentsError) {
                console.error('Error finding audit assignments:', assignmentsError);
                // Continue with deletion even if we can't find assignments
            } else if (assignments && assignments.length > 0) {
                // Update all assignments to pending status
                const assignmentIds = assignments.map(a => a.id);
                const { error: updateError } = await window.supabaseClient
                    .from('audit_assignments')
                    .update({
                        status: 'pending',
                        completed_at: null,
                        audit_id: null
                    })
                    .in('id', assignmentIds);
                
                if (updateError) {
                    console.error('Error updating audit assignments:', updateError);
                    // Continue with deletion even if update fails
                } else {
                    console.log(`Updated ${assignmentIds.length} assignment(s) to pending status`);
                }
            }
            
            // Delete the audit from the table
            const { error: deleteError } = await window.supabaseClient
                .from(tableName)
                .delete()
                .eq('id', auditId);
            
            if (deleteError) {
                throw deleteError;
            }
            
            // Show success message
            await window.confirmationDialog.show({
                title: 'Success!',
                message: 'Audit deleted successfully. Any related assignments have been reset to pending status.',
                confirmText: 'OK',
                type: 'success'
            });
            
            // Reload audits
            await loadAudits();
            
        } catch (error) {
            console.error('Error deleting audit:', error);
            await window.confirmationDialog.show({
                title: 'Error',
                message: 'Failed to delete audit: ' + error.message,
                confirmText: 'OK',
                type: 'error'
            });
        }
    };
    
    // Edit audit
    window.editAudit = async function(auditId) {
        const audit = allAudits.find(a => a.id === auditId);
        if (!audit) {
            alert('Audit not found');
            return;
        }
        
        // Navigate to create-audit.html with the audit ID as a parameter
        // The create-audit page will load this audit for editing
        window.location.href = `create-audit.html?edit=${auditId}&scorecard=${audit._scorecard_id || ''}&table=${audit._scorecard_table || ''}`;
    };
    
    // Show audit modal
    async function showAuditModal(audit) {
        // Load scorecard parameters dynamically
        let errorFields = [];
        let auditScorecard = null;
        
        // Determine which scorecard this audit belongs to
        const scorecardId = audit._scorecard_id || (currentScorecard ? currentScorecard.id : null);
        
        if (scorecardId) {
            try {
                // Load scorecard info
                const { data: scorecardData, error: scorecardError } = await window.supabaseClient
                    .from('scorecards')
                    .select('*')
                    .eq('id', scorecardId)
                    .single();
                
                if (!scorecardError && scorecardData) {
                    auditScorecard = scorecardData;
                }
                
                // Load parameters
                const { data: parameters, error } = await window.supabaseClient
                    .from('scorecard_parameters')
                    .select('*')
                    .eq('scorecard_id', scorecardId)
                    .eq('is_active', true)
                    .order('display_order', { ascending: true });
                
                if (!error && parameters) {
                    errorFields = parameters.map(param => ({
                        key: param.field_id,
                        label: param.error_name,
                        feedback: `feedback_${param.field_id}`,
                        severity: param.error_category.includes('Fail') ? 'Critical Fail' : 
                                 param.error_category.includes('Critical') ? 'Critical' : 
                                 'Significant',
                        field_type: param.field_type || 'counter',
                        parameter_type: param.parameter_type || 'error',
                        points: param.penalty_points || 0
                    }));
                }
            } catch (err) {
                console.error('Error loading scorecard parameters for modal:', err);
            }
        }
        
        // Fallback to default fields if no parameters loaded
        if (errorFields.length === 0) {
            errorFields = [
                { key: 'error_loss_business', label: 'Loss of Business', feedback: 'feedback_error_loss_business', severity: 'Critical Fail' },
                { key: 'zero_tolerance', label: 'Zero Tolerance', feedback: 'feedback_zero_tolerance', severity: 'Critical Fail' },
                { key: 'incorrect_info', label: 'Incorrect Information', feedback: 'feedback_incorrect_info', severity: 'Critical' },
                { key: 'lack_professionalism', label: 'Lack of Professionalism', feedback: 'feedback_lack_professionalism', severity: 'Critical' },
                { key: 'lack_escalation', label: 'Lack of Escalation', feedback: 'feedback_lack_escalation', severity: 'Critical' },
                { key: 'lack_investigation', label: 'Lack of Investigation', feedback: 'feedback_lack_investigation', severity: 'Critical' },
                { key: 'lack_empathy', label: 'Lack of Empathy', feedback: 'feedback_lack_empathy', severity: 'Significant' },
                { key: 'lack_knowledge', label: 'Lack of Knowledge', feedback: 'feedback_lack_knowledge', severity: 'Significant' },
                { key: 'lack_internal_comm', label: 'Lack of Internal Communication', feedback: 'feedback_lack_internal_comm', severity: 'Significant' },
                { key: 'missing_info', label: 'Missing Information', feedback: 'feedback_missing_info', severity: 'Significant' },
                { key: 'outdated_macro', label: 'Outdated Macro', feedback: 'feedback_outdated_macro', severity: 'Significant' },
                { key: 'grammatical_errors', label: 'Grammatical Errors', feedback: 'feedback_grammatical_errors', severity: 'Significant' },
                { key: 'info_overload', label: 'Information Overload', feedback: 'feedback_info_overload', severity: 'Significant' },
                { key: 'inadequate_engagement', label: 'Inadequate Engagement', feedback: 'feedback_inadequate_engagement', severity: 'Significant' },
                { key: 'missing_minimal_info', label: 'Missing Minimal Information', feedback: 'feedback_missing_minimal_info', severity: 'Significant' }
            ];
        }
        
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 1000; display: flex; 
            align-items: flex-start; justify-content: center; padding: 0;
            overflow-y: auto;
        `;
        
        // Date formatting helper function
        function formatDate(dateString, includeTime = false) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const day = date.getDate();
            const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            
            if (includeTime) {
                let hours = date.getHours();
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12 || 12;
                return `${day} ${month} ${year}, ${hours}:${minutes} ${ampm}`;
            }
            return `${day} ${month} ${year}`;
        }
        
        const submittedDateTime = formatDate(audit.submittedAt, true);
        const normalizedStatus = normalizePassingStatus(audit.passingStatus);
        const statusColor = normalizedStatus === 'Passed' ? '#10b981' : '#ef4444';
        const statusIcon = normalizedStatus === 'Passed' ? '' : '';
        
        // Generate error details HTML
        function generateErrorDetails() {
            
            // Calculate actual totals from individual error counts
            let criticalFailTotal = 0;
            let criticalTotal = 0;
            let significantTotal = 0;
            
            errorFields.forEach(field => {
                const count = audit[field.key] ? parseInt(audit[field.key]) : 0;
                if (count > 0) {
                    if (field.severity === 'Critical Fail') {
                        criticalFailTotal += count;
                    } else if (field.severity === 'Critical') {
                        criticalTotal += count;
                    } else if (field.severity === 'Significant') {
                        significantTotal += count;
                    }
                }
            });
            
            const errorRows = errorFields.map(field => {
                const rawValue = audit[field.key];
                let displayValue = '';
                let count = 0;
                
                if (field.field_type === 'radio') {
                    // For radio buttons, show YES/NO
                    const isYes = rawValue === 1 || rawValue === true || rawValue === 'true' || rawValue === '1';
                    displayValue = isYes ? ' YES' : ' NO';
                    count = isYes ? 1 : 0;
                } else {
                    // For counters, show the number
                    count = rawValue ? parseInt(rawValue) : 0;
                    displayValue = count.toString();
                }
                
                const feedback = audit[field.feedback] && audit[field.feedback].trim() ? audit[field.feedback] : '-';
                
                // Different colors for different parameter types
                let severityColor = '#3b82f6';
                let severityBg = '#eff6ff';
                let paramIcon = '';
                
                if (field.parameter_type === 'error') {
                    paramIcon = '';
                    if (field.severity === 'Critical Fail') {
                        severityColor = '#ef4444';
                        severityBg = '#fee2e2';
                    } else if (field.severity === 'Critical') {
                        severityColor = '#f59e0b';
                        severityBg = '#fef3c7';
                    }
                } else if (field.parameter_type === 'achievement' || field.parameter_type === 'bonus') {
                    paramIcon = '+';
                    severityColor = '#10b981';
                    severityBg = '#d1fae5';
                }
                
                return `
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 3fr; gap: 0.75rem; align-items: center; padding: 0.375rem 0; border-bottom: 0.0469rem solid #f3f4f6;">
                        <div style="font-size: 0.6562rem; color: #1f2937; font-weight: 600; font-family: 'Poppins', sans-serif;">
                            <span style="font-weight: 700; color: ${field.parameter_type === 'error' ? '#dc2626' : '#10b981'};">${paramIcon}</span> ${field.label}
                            <span style="font-size: 0.5156rem; color: #6b7280; font-weight: 400;"> (${field.points} pts)</span>
                        </div>
                        <div style="display: flex; justify-content: center;">
                            <span style="background: ${severityBg}; color: ${severityColor}; padding: 0.1875rem 0.5625rem; border-radius: 0.2812rem; font-size: 0.5625rem; font-weight: 600; font-family: 'Poppins', sans-serif; text-transform: uppercase; letter-spacing: 0.0175rem;">${(field.parameter_type === 'achievement' || field.parameter_type === 'bonus') && field.field_type !== 'radio' ? 'ACHIEVEMENT' : field.severity}</span>
                        </div>
                        <div style="font-size: 0.6562rem; color: #1f2937; text-align: center; font-weight: 700; font-family: 'Poppins', sans-serif;">${displayValue}</div>
                        <div style="font-size: 0.6562rem; color: #4b5563; font-family: 'Poppins', sans-serif; white-space: pre-wrap; line-height: 1.6;">${feedback}</div>
                    </div>
                `;
            }).join('');
            
            return `
                <div style="background: #f9fafb; border-radius: 0.375rem; padding: 0.75rem; margin-bottom: 0.75rem; border: 0.0352rem solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5625rem;">
                        <h3 style="font-size: 0.7031rem; font-weight: 600; color: #1A733E; margin: 0; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 0.375rem;">
                            <svg style="width: 0.8438rem; height: 0.8438rem;" viewBox="0 0 24 24" fill="#1A733E"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
                            Error Details
                        </h3>
                        <div style="display: flex; gap: 0.2812rem;">
                            <span style="background: #dc2626; color: #ffffff; padding: 0.1875rem 0.375rem; border-radius: 351.5273rem; font-size: 0.5156rem; font-weight: 700; font-family: 'Poppins', sans-serif; white-space: nowrap;">Critical Fail: ${criticalFailTotal}</span>
                            <span style="background: #f59e0b; color: #ffffff; padding: 0.1875rem 0.375rem; border-radius: 351.5273rem; font-size: 0.5156rem; font-weight: 700; font-family: 'Poppins', sans-serif; white-space: nowrap;">Critical: ${criticalTotal}</span>
                            <span style="background: #3b82f6; color: #ffffff; padding: 0.1875rem 0.375rem; border-radius: 351.5273rem; font-size: 0.5156rem; font-weight: 700; font-family: 'Poppins', sans-serif; white-space: nowrap;">Significant: ${significantTotal}</span>
                        </div>
                    </div>
                    
                    <div style="background: white; border-radius: 0.5625rem; box-shadow: 0 0.0469rem 0.1406rem 0 rgba(0, 0, 0, 0.1); overflow: hidden; margin-bottom: 0.75rem;">
                        <div style="background-color: #f8f9fa; padding: 0.5625rem 0.75rem; border-bottom: 0.0469rem solid #e5e7eb;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 3fr; gap: 0.75rem; align-items: center; font-weight: 700; font-size: 0.6562rem; color: #1f2937; text-transform: uppercase; letter-spacing: 0.05em;">
                                <div>Error Type</div>
                                <div style="text-align: center;">Severity</div>
                                <div style="text-align: center;">Status</div>
                                <div>Feedback</div>
                            </div>
                        </div>
                        <div style="padding: 0 0.75rem 0.75rem 0.75rem; box-shadow: 0 -0.0703rem 0.1406rem rgba(0, 0, 0, 0.05);">
                            ${errorRows}
                        </div>
                    </div>
                    
                    <!-- Pre/Post Status -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(6.3281rem, 1fr)); gap: 0.5625rem;">
                        <div style="background: #f0fdf4; padding: 0.5625rem; border-radius: 0.2812rem; border: 0.0352rem solid #bbf7d0;">
                            <p style="font-size: 0.5156rem; color: #166534; margin: 0 0 0.1875rem 0; font-family: 'Poppins', sans-serif; text-transform: uppercase; letter-spacing: 0.0175rem; font-weight: 600;">Pre-Status</p>
                            <p style="font-size: 0.6562rem; color: #15803d; margin: 0; font-family: 'Poppins', sans-serif; font-weight: 600;">${audit.agentPreStatus || 'N/A'}</p>
                        </div>
                        <div style="background: #f0f9ff; padding: 0.5625rem; border-radius: 0.2812rem; border: 0.0352rem solid #bae6fd;">
                            <p style="font-size: 0.5156rem; color: #075985; margin: 0 0 0.1875rem 0; font-family: 'Poppins', sans-serif; text-transform: uppercase; letter-spacing: 0.0175rem; font-weight: 600;">Post-Status</p>
                            <p style="font-size: 0.6562rem; color: #0369a1; margin: 0; font-family: 'Poppins', sans-serif; font-weight: 600;">${audit.agentPostStatus || 'N/A'}</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        const errorDetailsHtml = generateErrorDetails();
        const transcriptHtml = audit.transcript ? `
            <div style="background: #f9fafb; border-radius: 0.375rem; padding: 0.75rem; margin-bottom: 0.75rem; border: 0.0352rem solid #e5e7eb;">
                <h3 style="font-size: 0.7031rem; font-weight: 600; color: #1A733E; margin: 0 0 0.5625rem 0; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 0.375rem;">
                    <svg style="width: 0.8438rem; height: 0.8438rem;" viewBox="0 0 24 24" fill="#1A733E"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                    Transcript
                </h3>
                <div style="background: white; padding: 0.6562rem; border-radius: 0.2812rem; border: 0.0352rem solid #e5e7eb; white-space: pre-wrap; font-size: 0.6094rem; line-height: 1.6; color: #374151; font-family: 'Poppins', sans-serif; max-height: 14.0625rem; overflow-y: auto;">${audit.transcript}</div>
            </div>
        ` : '';
        
        const headerGradient = normalizedStatus === 'Not Passed' 
            ? 'linear-gradient(135deg, #d41212 0%, #b91c1c 100%)' 
            : 'linear-gradient(135deg, #1A733E 0%, #2d9a5a 100%)';
        
        modal.innerHTML = `
            <div style="background: white; width: 100%; min-height: 100vh;">
                <div style="background: ${headerGradient}; padding: 0.75rem 1.125rem; color: white; box-shadow: 0 0.1406rem 0.2109rem rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5625rem;">
                        <div style="flex: 1;">
                            <h2 style="font-size: 0.8438rem; font-weight: 700; margin: 0 0 0.1875rem 0; font-family: 'Poppins', sans-serif;">Audit Details</h2>
                            <div style="display: flex; align-items: center; gap: 0.375rem; margin-bottom: 0.375rem;">
                                <p style="font-size: 0.5625rem; color: rgba(255,255,255,0.85); margin: 0; font-family: 'Poppins', sans-serif;">${auditScorecard ? auditScorecard.name : (audit._scorecard_name || 'Default Scorecard')}</p>
                                ${auditScorecard && auditScorecard.scoring_type ? `
                                    <span style="background: rgba(255,255,255,0.25); padding: 0.1125rem 0.375rem; border-radius: 0.1875rem; font-size: 0.4688rem; font-weight: 600; text-transform: uppercase; border: 0.0352rem solid rgba(255,255,255,0.4);">
                                        ${auditScorecard.scoring_type === 'deductive' ? 'Deductive' : 
                                          auditScorecard.scoring_type === 'additive' ? 'Additive' : 
                                          auditScorecard.scoring_type === 'hybrid' ? 'Hybrid' : 
                                          auditScorecard.scoring_type}
                                    </span>
                                ` : (audit._scoring_type ? `
                                    <span style="background: rgba(255,255,255,0.25); padding: 0.1125rem 0.375rem; border-radius: 0.1875rem; font-size: 0.4688rem; font-weight: 600; text-transform: uppercase; border: 0.0352rem solid rgba(255,255,255,0.4);">
                                        ${audit._scoring_type === 'deductive' ? 'Deductive' : 
                                          audit._scoring_type === 'additive' ? 'Additive' : 
                                          audit._scoring_type === 'hybrid' ? 'Hybrid' : 
                                          audit._scoring_type}
                                    </span>
                                ` : '')}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(7.0312rem, 1fr)); gap: 0.375rem; margin-bottom: 0.5625rem;">
                                <div>
                                    <p style="font-size: 0.4688rem; color: rgba(255,255,255,0.7); margin: 0; font-family: 'Poppins', sans-serif; text-transform: uppercase;">Employee</p>
                                    <p style="font-size: 0.6562rem; font-weight: 600; margin: 0; font-family: 'Poppins', sans-serif;">${audit.employeeName || 'N/A'}</p>
                                </div>
                                <div>
                                    <p style="font-size: 0.4688rem; color: rgba(255,255,255,0.7); margin: 0; font-family: 'Poppins', sans-serif; text-transform: uppercase;">Email</p>
                                    <p style="font-size: 0.6562rem; font-weight: 600; margin: 0; font-family: 'Poppins', sans-serif; word-break: break-all;">${audit.employeeEmail || 'N/A'}</p>
                                </div>
                                <div>
                                    <p style="font-size: 0.4688rem; color: rgba(255,255,255,0.7); margin: 0; font-family: 'Poppins', sans-serif; text-transform: uppercase;">Type</p>
                                    <p style="font-size: 0.6562rem; font-weight: 600; margin: 0; font-family: 'Poppins', sans-serif;">${audit.employeeType || 'N/A'}</p>
                                </div>
                                <div>
                                    <p style="font-size: 0.4688rem; color: rgba(255,255,255,0.7); margin: 0; font-family: 'Poppins', sans-serif; text-transform: uppercase;">Country</p>
                                    <p style="font-size: 0.6562rem; font-weight: 600; margin: 0; font-family: 'Poppins', sans-serif;">${audit.countryOfEmployee || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                        <button onclick="this.closest('.modal').remove()" style="background: rgba(255,255,255,0.2); border: 0.0703rem solid white; border-radius: 0.2812rem; width: 1.5rem; height: 1.5rem; font-size: 0.9375rem; cursor: pointer; color: white; font-weight: bold; transition: all 0.2s; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-left: 0.75rem;"></button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(4.9219rem, 1fr)); gap: 0.375rem;">
                        <div style="background: rgba(255,255,255,0.15); border-radius: 0.2812rem; padding: 0.375rem 0.5625rem; backdrop-filter: blur(0.3516rem);">
                            <p style="font-size: 0.4688rem; color: rgba(255,255,255,0.8); margin: 0 0 0.1875rem 0; font-family: 'Poppins', sans-serif; text-transform: uppercase; letter-spacing: 0.0175rem;">Status</p>
                            <p style="font-size: 0.75rem; font-weight: 700; margin: 0; font-family: 'Poppins', sans-serif;">${statusIcon} ${normalizedStatus || 'N/A'}</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 0.2812rem; padding: 0.375rem 0.5625rem; backdrop-filter: blur(0.3516rem);">
                            <p style="font-size: 0.4688rem; color: rgba(255,255,255,0.8); margin: 0 0 0.1875rem 0; font-family: 'Poppins', sans-serif; text-transform: uppercase; letter-spacing: 0.0175rem;">Score</p>
                            <p style="font-size: 0.75rem; font-weight: 700; margin: 0; font-family: 'Poppins', sans-serif;">${audit.averageScore || '0'}%</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 0.2812rem; padding: 0.375rem 0.5625rem; backdrop-filter: blur(0.3516rem);">
                            <p style="font-size: 0.4688rem; color: rgba(255,255,255,0.8); margin: 0 0 0.1875rem 0; font-family: 'Poppins', sans-serif; text-transform: uppercase; letter-spacing: 0.0175rem;">Total Errors</p>
                            <p style="font-size: 0.75rem; font-weight: 700; margin: 0; font-family: 'Poppins', sans-serif;">${audit.totalErrorsCount || '0'}</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 0.2812rem; padding: 0.375rem 0.5625rem; backdrop-filter: blur(0.3516rem);">
                            <p style="font-size: 0.4688rem; color: rgba(255,255,255,0.8); margin: 0 0 0.1875rem 0; font-family: 'Poppins', sans-serif; text-transform: uppercase; letter-spacing: 0.0175rem;">Audit Type</p>
                            <p style="font-size: 0.6562rem; font-weight: 600; margin: 0; font-family: 'Poppins', sans-serif;">${audit.auditType || 'N/A'}</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 0.2812rem; padding: 0.375rem 0.5625rem; backdrop-filter: blur(0.3516rem);">
                            <p style="font-size: 0.4688rem; color: rgba(255,255,255,0.8); margin: 0 0 0.1875rem 0; font-family: 'Poppins', sans-serif; text-transform: uppercase; letter-spacing: 0.0175rem;">Audit Date</p>
                            <p style="font-size: 0.5625rem; font-weight: 600; margin: 0; font-family: 'Poppins', sans-serif;">${formatDate(audit.auditTimestamp, true)}</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 0.2812rem; padding: 0.375rem 0.5625rem; backdrop-filter: blur(0.3516rem);">
                            <p style="font-size: 0.4688rem; color: rgba(255,255,255,0.8); margin: 0 0 0.1875rem 0; font-family: 'Poppins', sans-serif; text-transform: uppercase; letter-spacing: 0.0175rem;">Quarter</p>
                            <p style="font-size: 0.6562rem; font-weight: 600; margin: 0; font-family: 'Poppins', sans-serif;">${audit.quarter ? (audit.quarter.toString().startsWith('Q') ? audit.quarter : 'Q' + audit.quarter) : 'N/A'}</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 0.2812rem; padding: 0.375rem 0.5625rem; backdrop-filter: blur(0.3516rem);">
                            <p style="font-size: 0.4688rem; color: rgba(255,255,255,0.8); margin: 0 0 0.1875rem 0; font-family: 'Poppins', sans-serif; text-transform: uppercase; letter-spacing: 0.0175rem;">Week</p>
                            <p style="font-size: 0.6562rem; font-weight: 600; margin: 0; font-family: 'Poppins', sans-serif;">${audit.week || 'N/A'}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Two Column Layout -->
                <div id="auditContent" style="display: flex; padding: 1.125rem; max-width: 100%; gap: 0; flex-wrap: nowrap;">
                    
                    <!-- LEFT COLUMN: Interaction Details + Transcript -->
                    <div id="leftColumn" style="display: flex; flex-direction: column; gap: 0.75rem; width: 45%; min-width: 10.5469rem; padding-right: 0.375rem;">
                        
                        <!-- Interaction Details -->
                        <div style="background: #f9fafb; border-radius: 0.2812rem; padding: 0.375rem 0.5625rem; border: 0.0352rem solid #e5e7eb;">
                            <div style="display: flex; align-items: center; gap: 0.5625rem; flex-wrap: nowrap;">
                                <div style="display: flex; align-items: center; gap: 0.1875rem;">
                                    <svg style="width: 0.5625rem; height: 0.5625rem;" viewBox="0 0 24 24" fill="#1A733E"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/></svg>
                                    <span style="font-size: 0.5156rem; color: #6b7280; font-family: 'Poppins', sans-serif; text-transform: uppercase; letter-spacing: 0.0106rem; white-space: nowrap;">ID:</span>
                                    <span style="font-size: 0.5625rem; color: #1f2937; font-family: 'Poppins', sans-serif; font-weight: 600;">${audit.interactionId || 'N/A'}</span>
                                    <button onclick="navigator.clipboard.writeText('${audit.interactionId || ''}'); const btn = this; const originalHTML = btn.innerHTML; btn.innerHTML='<svg style=&quot;width: 0.6562rem; height: 0.6562rem;&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;#22c55e&quot;><path d=&quot;M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z&quot;/></svg>'; setTimeout(() => btn.innerHTML = originalHTML, 1000);" style="background: transparent; border: none; cursor: pointer; padding: 0.0938rem; display: inline-flex; align-items: center;" title="Copy Interaction ID"><svg style="width: 0.6562rem; height: 0.6562rem;" viewBox="0 0 24 24" fill="#6b7280"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
                                </div>
                                <div style="width: 0.0352rem; height: 0.75rem; background: #d1d5db;"></div>
                                <div style="display: flex; align-items: center; gap: 0.1875rem;">
                                    <span style="font-size: 0.5156rem; color: #6b7280; font-family: 'Poppins', sans-serif; text-transform: uppercase; letter-spacing: 0.0106rem; white-space: nowrap;">Date:</span>
                                    <span style="font-size: 0.5625rem; color: #1f2937; font-family: 'Poppins', sans-serif; font-weight: 600;">${formatDate(audit.interactionDate, false)}</span>
                                </div>
                                <div style="width: 0.0352rem; height: 0.75rem; background: #d1d5db;"></div>
                                <div style="display: flex; align-items: center; gap: 0.1875rem;">
                                    <span style="font-size: 0.5156rem; color: #6b7280; font-family: 'Poppins', sans-serif; text-transform: uppercase; letter-spacing: 0.0106rem; white-space: nowrap;">Channel:</span>
                                    <span style="font-size: 0.5625rem; color: #1f2937; font-family: 'Poppins', sans-serif; font-weight: 600;">${audit.channel || 'N/A'}</span>
                                </div>
                                <div style="width: 0.0352rem; height: 0.75rem; background: #d1d5db;"></div>
                                <div style="display: flex; align-items: center; gap: 0.1875rem; min-width: 0; flex: 1;">
                                    <span style="font-size: 0.5156rem; color: #6b7280; font-family: 'Poppins', sans-serif; text-transform: uppercase; letter-spacing: 0.0106rem; white-space: nowrap;">Email:</span>
                                    <span style="font-size: 0.5625rem; color: #1f2937; font-family: 'Poppins', sans-serif; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${audit.clientEmail || 'N/A'}">${audit.clientEmail || 'N/A'}</span>
                                    <button onclick="navigator.clipboard.writeText('${audit.clientEmail || ''}'); const btn = this; const originalHTML = btn.innerHTML; btn.innerHTML='<svg style=&quot;width: 0.6562rem; height: 0.6562rem;&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;#22c55e&quot;><path d=&quot;M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z&quot;/></svg>'; setTimeout(() => btn.innerHTML = originalHTML, 1000);" style="background: transparent; border: none; cursor: pointer; padding: 0.0938rem; display: inline-flex; align-items: center; flex-shrink: 0;" title="Copy Client Email"><svg style="width: 0.6562rem; height: 0.6562rem;" viewBox="0 0 24 24" fill="#6b7280"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Transcript -->
                        <div style="background: #f9fafb; border-radius: 0.375rem; padding: 0; border: 0.0352rem solid #e5e7eb; display: flex; flex-direction: column; height: 80vh; transition: height 0.3s ease;">
                            <div style="background: #f9fafb; padding: 0.75rem; border-bottom: 0.0352rem solid #e5e7eb; flex-shrink: 0;">
                                <h3 style="font-size: 0.7031rem; font-weight: 600; color: #1A733E; margin: 0; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 0.375rem;">
                                    <svg style="width: 0.8438rem; height: 0.8438rem;" viewBox="0 0 24 24" fill="#1A733E"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/></svg>
                                    Transcript
                                </h3>
                            </div>
                            <div style="padding: 0.75rem; background: white; overflow-y: auto; flex: 1;">
                                <div style="white-space: pre-wrap; font-size: 0.6094rem; line-height: 1.6; color: #374151; font-family: 'Poppins', sans-serif;">${audit.transcript || '<span style="color: #9ca3af; font-style: italic;">No transcript available</span>'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RESIZABLE SPLITTER -->
                    <div id="splitter" style="width: 0.2812rem; background: #e5e7eb; cursor: col-resize; position: relative; flex-shrink: 0; transition: background 0.2s;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 0.1406rem; height: 1.4062rem; background: #9ca3af; border-radius: 0.0703rem;"></div>
                    </div>
                    
                    <!-- RIGHT COLUMN: Error Details & Recommendations -->
                    <div id="rightColumn" style="flex: 1; min-width: 10.5469rem; padding-left: 0.375rem;">
                        
                        <!-- Error Details -->
                        ${errorDetailsHtml}
                        
                        <!-- Recommendations -->
                        ${audit.recommendations ? `<div style="background: #f9fafb; border-radius: 0.375rem; padding: 0.75rem; margin-bottom: 0.75rem; border: 0.0352rem solid #e5e7eb;"><h3 style="font-size: 0.7031rem; font-weight: 600; color: #1A733E; margin: 0 0 0.5625rem 0; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 0.375rem;"><svg style="width: 0.8438rem; height: 0.8438rem;" viewBox="0 0 24 24" fill="#1A733E"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6C7.8 12.16 7 10.63 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/></svg>Recommendations / Next Steps</h3><div style="background: white; padding: 0.6562rem; border-radius: 0.2812rem; border: 0.0352rem solid #e5e7eb; white-space: pre-wrap; font-size: 0.6094rem; line-height: 1.6; color: #374151; font-family: 'Poppins', sans-serif;">${audit.recommendations}</div></div>` : ''}
                        
                        <!-- Close Button -->
                        <div style="display: flex; justify-content: center; margin-top: 0.75rem; padding-bottom: 0.75rem;">
                            <button onclick="this.closest('.modal').remove()" style="background: #1A733E; color: white; border: none; border-radius: 0.375rem; padding: 0.5625rem 1.5rem; font-size: 0.75rem; font-weight: 600; font-family: 'Poppins', sans-serif; cursor: pointer; transition: all 0.2s; box-shadow: 0 0.1406rem 0.2109rem rgba(0,0,0,0.1);">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        modal.className = 'modal';
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        });
        
        document.body.appendChild(modal);
        
        // Make splitter draggable
        const splitter = document.getElementById('splitter');
        const leftColumn = document.getElementById('leftColumn');
        const rightColumn = document.getElementById('rightColumn');
        const auditContent = document.getElementById('auditContent');
        
        if (splitter && leftColumn && rightColumn && auditContent) {
            let isResizing = false;
            
            splitter.addEventListener('mousedown', function(e) {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                splitter.style.background = '#9ca3af';
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const containerRect = auditContent.getBoundingClientRect();
                const offsetX = e.clientX - containerRect.left;
                const containerWidth = containerRect.width;
                
                // Calculate percentage (with min/max constraints)
                let leftPercentage = (offsetX / containerWidth) * 100;
                leftPercentage = Math.max(25, Math.min(75, leftPercentage));
                
                leftColumn.style.width = leftPercentage + '%';
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    splitter.style.background = '#e5e7eb';
                }
            });
            
            // Hover effect
            splitter.addEventListener('mouseenter', function() {
                if (!isResizing) {
                    splitter.style.background = '#d1d5db';
                }
            });
            
            splitter.addEventListener('mouseleave', function() {
                if (!isResizing) {
                    splitter.style.background = '#e5e7eb';
                }
            });
        }
    }
    
    // Note: loadAudits() is called by loadScorecards() after scorecards are loaded
    // No need to call it again here
    
    } catch (error) {
        console.error('Error in audit reports functionality:', error);
    }
});
</script>

</body>
</html>
